<!DOCTYPE html>

<html lang="zh-CN">

<head>
    
    <title>使用 Phoenix LiveView 构建 Instagram (6) - 和光同尘|MarkHoo_不积跬步无以至千里，不积小流无以成江海</title>
    <meta charset="UTF-8">
    <meta name="description" content="终日而思,不如须臾之所学也">
    <meta name="keywords" content="和光同尘,MarkHoo,Python,Elixir,Phoenix,SpringBoot,Django,">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    

    <link rel="shortcut icon" href="https://media.markhoo.com/image/favicon24.ico" type="image/x-icon" />
    <meta name="description" content="使用PETAL(Phoenix、Elixir、TailwindCSS、AlpineJS、LiveView)技术栈构建一个简化版的Instagram Web应用程序">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 Phoenix LiveView 构建 Instagram (6)">
<meta property="og:url" content="https://blog.markhoo.com/posts/instagram-phoenix-liveview-p6/">
<meta property="og:site_name" content="和光同尘|MarkHoo_不积跬步无以至千里，不积小流无以成江海">
<meta property="og:description" content="使用PETAL(Phoenix、Elixir、TailwindCSS、AlpineJS、LiveView)技术栈构建一个简化版的Instagram Web应用程序">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-09-03T14:43:40.000Z">
<meta property="article:modified_time" content="2023-08-30T09:24:47.594Z">
<meta property="article:author" content="MarkHoo">
<meta property="article:tag" content="Elixir">
<meta property="article:tag" content="Phoenix">
<meta property="article:tag" content="LiveView">
<meta property="article:tag" content="TailwindCSS">
<meta property="article:tag" content="AlpineJS">
<meta name="twitter:card" content="summary">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/npm/highlight.js@9.15.8/styles/atom-one-dark.css,npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css,gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css,npm/hexo-theme-nexmoe@latest/source/lib/mdui_043tiny/css/mdui.css,npm/hexo-theme-nexmoe@latest/source/lib/iconfont/iconfont.css?v=233" crossorigin>
    <link rel="stylesheet" href="/css/style.css?v=1693394618023">
     
    
    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1693394618024">
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="mdui-drawer-body-left">
    
    <div id="nexmoe-background">
        <div class="nexmoe-bg" style="background-image: url(https://s2.loli.net/2023/08/30/SfpNaZsg3IW5MDz.jpg)"></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="MarkHoo" class="mdui-btn mdui-btn-icon"><img src="https://media.markhoo.com/avatar.jpg" alt="MarkHoo"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="MarkHoo">
            <img src="https://media.markhoo.com/avatar.jpg" alt="MarkHoo" alt="MarkHoo">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>53</div>
        <div><span>标签</span>40</div>
        <div><span>分类</span>11</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archives" title="归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/books" title="书架">
            <i class="mdui-list-item-icon nexmoefont icon-battlenet"></i>
            <div class="mdui-list-item-content">
                书架
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about" title="关于">
            <i class="mdui-list-item-icon nexmoefont icon-coffee"></i>
            <div class="mdui-list-item-content">
                关于
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/links" title="邻居">
            <i class="mdui-list-item-icon nexmoefont icon-dribbble"></i>
            <div class="mdui-list-item-content">
                邻居
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=site:markhoo.com" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
            </form>
         
    </div>
</div>
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://jq.qq.com/" target="_blank" mdui-tooltip="{content: 'QQ群'}" style="color: rgb(249, 174, 8);background-color: rgba(249, 174, 8, .1);">
            <i class="nexmoefont icon-QQ"></i>
        </a><a class="mdui-ripple" href="https://space.bilibili.com/182687081" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/markhoo/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
    
    
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/API/" style="font-size: 10px;">API</a> <a href="/tags/AlpineJS/" style="font-size: 16.25px;">AlpineJS</a> <a href="/tags/ArchLinux/" style="font-size: 10px;">ArchLinux</a> <a href="/tags/C-C/" style="font-size: 10px;">C/C++</a> <a href="/tags/CentOS7/" style="font-size: 15px;">CentOS7</a> <a href="/tags/Django/" style="font-size: 18.75px;">Django</a> <a href="/tags/Elixir/" style="font-size: 18.75px;">Elixir</a> <a href="/tags/EndeavourOS/" style="font-size: 10px;">EndeavourOS</a> <a href="/tags/Erlang/" style="font-size: 10px;">Erlang</a> <a href="/tags/Gin/" style="font-size: 10px;">Gin</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/Gitlab/" style="font-size: 10px;">Gitlab</a> <a href="/tags/Go/" style="font-size: 16.25px;">Go</a> <a href="/tags/Gunicorn/" style="font-size: 12.5px;">Gunicorn</a> <a href="/tags/Hugo/" style="font-size: 10px;">Hugo</a> <a href="/tags/IDE/" style="font-size: 11.25px;">IDE</a> <a href="/tags/JWT/" style="font-size: 10px;">JWT</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Linux/" style="font-size: 13.75px;">Linux</a> <a href="/tags/LiveView/" style="font-size: 16.25px;">LiveView</a> <a href="/tags/Lua/" style="font-size: 11.25px;">Lua</a> <a href="/tags/Manim/" style="font-size: 10px;">Manim</a> <a href="/tags/NeoVim/" style="font-size: 11.25px;">NeoVim</a> <a href="/tags/Nginx/" style="font-size: 13.75px;">Nginx</a> <a href="/tags/Phoenix/" style="font-size: 17.5px;">Phoenix</a> <a href="/tags/PyCharm/" style="font-size: 10px;">PyCharm</a> <a href="/tags/Python/" style="font-size: 20px;">Python</a> <a href="/tags/Rest/" style="font-size: 10px;">Rest</a> <a href="/tags/TailwindCSS/" style="font-size: 16.25px;">TailwindCSS</a> <a href="/tags/Unix/" style="font-size: 10px;">Unix</a> <a href="/tags/Vim/" style="font-size: 12.5px;">Vim</a> <a href="/tags/hexo/" style="font-size: 11.25px;">hexo</a> <a href="/tags/pip/" style="font-size: 11.25px;">pip</a> <a href="/tags/pypi/" style="font-size: 10px;">pypi</a> <a href="/tags/xadmin/" style="font-size: 10px;">xadmin</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E7%BD%91%E6%98%93%E4%BA%91%E9%9F%B3%E4%B9%90/" style="font-size: 10px;">网易云音乐</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 11.25px;">面试题</a> <a href="/tags/%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8/" style="font-size: 10px;">音乐播放器</a>
    </div>
    
  </div>

    
</aside>
    <div class="nexmoe-copyright">
        &copy; 2023 MarkHoo
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        <br><a target="_blank" href="https://beian.miit.gov.cn">苏ICP备17044309号</a><br><a target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"><img src="https://i.dawnlab.me/c0268c1e6cfd0863d6ba35be1575941a.png" width="150px"></a><script data-ad-client="ca-pub-2058306854838448" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
            <div class="nexmoe-post">

  <article>
      
          <div class="nexmoe-post-cover" style="padding-bottom: 45.83333333333333%;"> 
              <img data-src="https://s2.loli.net/2023/08/30/SfpNaZsg3IW5MDz.jpg" data-sizes="auto" alt="使用 Phoenix LiveView 构建 Instagram (6)" class="lazyload">
              <h1>使用 Phoenix LiveView 构建 Instagram (6)</h1>
          </div>
      
      
      <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2023年09月03日</a>
    <a><i class="nexmoefont icon-areachart"></i>5.3k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 31 分钟</a>
</div>

      

      <blockquote>
<p>使用PETAL(Phoenix、Elixir、TailwindCSS、AlpineJS、LiveView)技术栈构建一个简化版的Instagram Web应用程序</p>
</blockquote>
<span id="more"></span>

<p>在第 5 部分中，我们添加了 show-post 页面，在这部分中，我们将在主页上进行工作。您可以赶上Instagram 克隆 GitHub Repo。</p>
<p>首先，我们在 posts 上下文中添加一个函数来获取 feed，然后添加另一个函数来获取 feed 的总数 open <code>lib/instagram_clone/posts.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">Returns the list of paginated posts of a given user id</span><br><span class="hljs-string">And posts of following list of given user id</span><br><span class="hljs-string">With user and likes preloaded</span><br><span class="hljs-string">With 2 most recent comments preloaded with user and likes</span><br><span class="hljs-string">User, page, and per_page are given with the socket assigns</span><br><span class="hljs-string">## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">    iex&gt; get_accounts_feed(following_list, assigns)</span><br><span class="hljs-string">    [%&#123;photo_url: &quot;&quot;, url_id: &quot;&quot;&#125;, ...]</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_accounts_feed</span></span>(following_list, assigns) <span class="hljs-keyword">do</span><br>  user = assigns.current_user<br>  page = assigns.page<br>  per_page = assigns.per_page<br>  query =<br>    from c <span class="hljs-keyword">in</span> Comment,<br>    <span class="hljs-symbol">select:</span> %&#123;<span class="hljs-symbol">id:</span> c.id, <span class="hljs-symbol">row_number:</span> over(row_number(), <span class="hljs-symbol">:posts_partition</span>)&#125;,<br>    <span class="hljs-symbol">windows:</span> [<span class="hljs-symbol">posts_partition:</span> [<span class="hljs-symbol">partition_by:</span> <span class="hljs-symbol">:post_id</span>, <span class="hljs-symbol">order_by:</span> [<span class="hljs-symbol">desc:</span> <span class="hljs-symbol">:id</span>]]]<br>  comments_query =<br>    from c <span class="hljs-keyword">in</span> Comment,<br>    <span class="hljs-symbol">join:</span> r <span class="hljs-keyword">in</span> subquery(query),<br>    <span class="hljs-symbol">on:</span> c.id == r.id <span class="hljs-keyword">and</span> r.row_number &lt;= <span class="hljs-number">2</span><br><br>  Post<br>  |&gt; where([p], p.user_id <span class="hljs-keyword">in</span> ^following_list)<br>  |&gt; or_where([p], p.user_id == ^user.id)<br>  |&gt; limit(^per_page)<br>  |&gt; offset(^((page - <span class="hljs-number">1</span>) * per_page))<br>  |&gt; order_by(<span class="hljs-symbol">desc:</span> <span class="hljs-symbol">:id</span>)<br>  |&gt; preload([<span class="hljs-symbol">:user</span>, <span class="hljs-symbol">:likes</span>, <span class="hljs-symbol">comments:</span> ^&#123;comments_query, [<span class="hljs-symbol">:user</span>, <span class="hljs-symbol">:likes</span>]&#125;])<br>  |&gt; Repo.all()<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_accounts_feed_total</span></span>(following_list, assigns) <span class="hljs-keyword">do</span><br>  user = assigns.current_user<br><br>  Post<br>  |&gt; where([p], p.user_id <span class="hljs-keyword">in</span> ^following_list)<br>  |&gt; or_where([p], p.user_id == ^user.id)<br>  |&gt; select([p], count(p.id))<br>  |&gt; Repo.one()<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>我们需要以下列表，在里面<code>lib/instagram_clone/accounts.ex</code>添加以下函数：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">Returns the list of following user ids</span><br><span class="hljs-string"></span><br><span class="hljs-string">## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">    iex&gt; get_following_list(user)</span><br><span class="hljs-string">    [3, 2, 1]</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_following_list</span></span>(user) <span class="hljs-keyword">do</span><br>  Follows<br>  |&gt; select([f], f.followed_id)<br>  |&gt; where(<span class="hljs-symbol">follower_id:</span> ^user.id)<br>  |&gt; Repo.all()<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>在里面<code>lib/instagram_clone_web/live/page_live.ex</code>让我们分配提要：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><br><span class="hljs-keyword">alias</span> InstagramClone.Uploaders.Avatar<br><span class="hljs-keyword">alias</span> InstagramClone.Accounts<br><span class="hljs-keyword">alias</span> InstagramCloneWeb.UserLive.FollowComponent<br><span class="hljs-keyword">alias</span> InstagramClone.Posts<br><span class="hljs-keyword">alias</span> InstagramCloneWeb.Live.LikeComponent<br><br><span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(_params, session, socket) <span class="hljs-keyword">do</span><br>  socket = assign_defaults(session, socket)<br><br>  &#123;<span class="hljs-symbol">:ok</span>,<br>    socket<br>    |&gt; assign(<span class="hljs-symbol">page:</span> <span class="hljs-number">1</span>, <span class="hljs-symbol">per_page:</span> <span class="hljs-number">15</span>),<br>    <span class="hljs-symbol">temporary_assigns:</span> [<span class="hljs-symbol">user_feed:</span> []]&#125;<br><span class="hljs-keyword">end</span><br><br><span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_params</span></span>(_params, _uri, socket) <span class="hljs-keyword">do</span><br>  &#123;<span class="hljs-symbol">:noreply</span>,<br>    socket<br>    |&gt; assign(<span class="hljs-symbol">live_action:</span> apply_action(socket.assigns.current_user))<br>    |&gt; assign_posts()&#125;<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">apply_action</span></span>(current_user) <span class="hljs-keyword">do</span><br>  if !current_user, <span class="hljs-symbol">do:</span> <span class="hljs-symbol">:root_path</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">assign_posts</span></span>(socket) <span class="hljs-keyword">do</span><br>  if socket.assigns.current_user <span class="hljs-keyword">do</span><br>    current_user = socket.assigns.current_user<br>    following_list = Accounts.get_following_list(current_user)<br>    accounts_feed_total = Posts.get_accounts_feed_total(following_list, socket.assigns)<br><br>    socket<br>    |&gt; assign(<span class="hljs-symbol">following_list:</span> following_list)<br>    |&gt; assign(<span class="hljs-symbol">accounts_feed_total:</span> accounts_feed_total)<br>    |&gt; assign_user_feed()<br>  else<br>    socket<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">assign_user_feed</span></span>(socket, following_list) <span class="hljs-keyword">do</span><br>  user_feed = Posts.get_accounts_feed(socket.assigns.following_list, socket.assigns)<br>  socket |&gt; assign(<span class="hljs-symbol">user_feed:</span> user_feed)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>页和每页被分配给我们的挂载函数中的套接字。我们正在检查用户是否登录以获取以下列表并将其传递给分配提要函数以返回分配了提要的套接字，我们在句柄参数函数中执行此操作。</p>
<p>现在让我们为帖子提要创建一个组件，在我们的 live 文件夹中添加以下文件：</p>
<p><code>lib/instagram_clone_web/live/page_post_feed_component.ex</code> <code>lib/instagram_clone_web/live/page_post_feed_component.html.leex</code></p>
<p>里面<code>lib/instagram_clone_web/live/page_live.html.leex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= if <span class="hljs-variable">@current_user</span> <span class="hljs-keyword">do</span> %&gt;<br>  &lt;section class=<span class="hljs-string">&quot;flex&quot;</span>&gt;<br>    &lt;div id=<span class="hljs-string">&quot;user-feed&quot;</span> class=<span class="hljs-string">&quot;w-3/5&quot;</span> phx-update=<span class="hljs-string">&quot;append&quot;</span>&gt;<br>      &lt;%= <span class="hljs-keyword">for</span> post &lt;- <span class="hljs-variable">@user_feed</span> <span class="hljs-keyword">do</span> %&gt;<br>        &lt;%= live_component <span class="hljs-variable">@socket</span>,<br>          InstagramCloneWeb.Live.PagePostFeedComponent,<br>          <span class="hljs-symbol">post:</span> post,<br>          <span class="hljs-symbol">id:</span> post.id,<br>          <span class="hljs-symbol">current_user:</span> <span class="hljs-variable">@current_user</span> %&gt;<br>      &lt;% <span class="hljs-keyword">end</span> %&gt;<br>    &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp"></span><br><span class="hljs-regexp">  &lt;/section</span>&gt;<br>  <br>  &lt;div<br>    id=<span class="hljs-string">&quot;profile-posts-footer&quot;</span><br>    class=<span class="hljs-string">&quot;flex justify-center&quot;</span><br>    phx-hook=<span class="hljs-string">&quot;ProfilePostsScroll&quot;</span>&gt;<br>  &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">&lt;% else %&gt;</span><br><span class="hljs-regexp">  &lt;%= live_component @socket,</span><br><span class="hljs-regexp">    InstagramCloneWeb.PageLiveComponent,</span><br><span class="hljs-regexp">    id: 1 %&gt;</span><br><span class="hljs-regexp">&lt;% end %&gt;</span><br></code></pre></td></tr></table></figure>

<p>里面<code>lib/instagram_clone_web/live/page_post_feed_component.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.Live.PagePostFeedComponent</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_component</span><br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Uploaders.Avatar<br>  <span class="hljs-keyword">alias</span> InstagramClone.Comments<br>  <span class="hljs-keyword">alias</span> InstagramClone.Comments.Comment<br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(socket) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:ok</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">changeset:</span> Comments.change_comment(%Comment&#123;&#125;)),<br>      <span class="hljs-symbol">temporary_assigns:</span> [<span class="hljs-symbol">comments:</span> []]&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;save&quot;</span>, %&#123;<span class="hljs-string">&quot;comment&quot;</span> =&gt; comment_param&#125;, socket) <span class="hljs-keyword">do</span><br>    %&#123;<span class="hljs-string">&quot;body&quot;</span> =&gt; body&#125; = comment_param<br>    current_user = socket.assigns.current_user<br>    post = socket.assigns.post<br><br>    if body == <span class="hljs-string">&quot;&quot;</span> <span class="hljs-keyword">do</span><br>      &#123;<span class="hljs-symbol">:noreply</span>, socket&#125;<br>    else<br>      comment = Comments.create_comment(current_user, post, comment_param)<br>      &#123;<span class="hljs-symbol">:noreply</span>,<br>        socket<br>        |&gt; update(<span class="hljs-symbol">:comments</span>, <span class="hljs-keyword">fn</span> comments -&gt; [comment | comments] <span class="hljs-keyword">end</span>)<br>        |&gt; assign(<span class="hljs-symbol">changeset:</span> Comments.change_comment(%Comment&#123;&#125;))&#125;<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>我们正在设置表单变更集和临时注释，我们将使用它们来附加新注释。保存句柄功能与我们在展示页面上使用的功能相同。</p>
<p>里面<code>lib/instagram_clone_web/live/page_post_feed_component.html.leex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;div class=<span class="hljs-string">&quot;mb-16 shadow&quot;</span> id=<span class="hljs-string">&quot;post-&lt;%= @post.id %&gt;&quot;</span>&gt;<br>  &lt;div class=<span class="hljs-string">&quot;flex p-4 items-center&quot;</span>&gt;<br>    &lt;!-- Post header section --&gt;<br>    &lt;%= live_redirect <span class="hljs-symbol">to:</span> Routes.user_profile_path(<span class="hljs-variable">@socket</span>, <span class="hljs-symbol">:index</span>, <span class="hljs-variable">@post</span>.user.username) <span class="hljs-keyword">do</span> %&gt;<br>      &lt;%= img_tag Avatar.get_thumb(<span class="hljs-variable">@post</span>.user.avatar_url), <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-8 h-8 rounded-full object-cover object-center&quot;</span> %&gt;<br>    &lt;% <span class="hljs-keyword">end</span> %&gt;<br>    &lt;div class=<span class="hljs-string">&quot;ml-3&quot;</span>&gt;<br>      &lt;%= live_redirect <span class="hljs-variable">@post</span>.user.username,<br>        <span class="hljs-symbol">to:</span> Routes.user_profile_path(<span class="hljs-variable">@socket</span>, <span class="hljs-symbol">:index</span>, <span class="hljs-variable">@post</span>.user.username),<br>        <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;truncate font-bold text-sm text-gray-500 hover:underline&quot;</span> %&gt;<br>    &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">    &lt;!-- End post header section --&gt;</span><br><span class="hljs-regexp">  &lt;/div</span>&gt;<br>  &lt;!-- Post Image section --&gt;<br>  &lt;%= img_tag <span class="hljs-variable">@post</span>.photo_url,<br>          <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-full object-contain h-full shadow-sm&quot;</span> %&gt;<br>  &lt;!-- End Post Image section --&gt;<br><br>  &lt;div class=<span class="hljs-string">&quot;w-full&quot;</span>&gt;<br>    &lt;!-- Action icons section --&gt;<br>    &lt;div class=<span class="hljs-string">&quot;flex pl-4 pr-2 pt-2&quot;</span>&gt;<br>      &lt;%= live_component <span class="hljs-variable">@socket</span>,<br>          InstagramCloneWeb.Live.LikeComponent,<br>          <span class="hljs-symbol">id:</span> <span class="hljs-variable">@post</span>.id,<br>          <span class="hljs-symbol">liked:</span> <span class="hljs-variable">@post</span>,<br>          <span class="hljs-symbol">w_h:</span> <span class="hljs-string">&quot;w-8 h-8&quot;</span>,<br>          <span class="hljs-symbol">current_user:</span> <span class="hljs-variable">@current_user</span> %&gt;<br><br>      &lt;%= live_redirect <span class="hljs-symbol">to:</span> Routes.live_path(<span class="hljs-variable">@socket</span>, InstagramCloneWeb.PostLive.Show, <span class="hljs-variable">@post</span>.url_id) <span class="hljs-keyword">do</span> %&gt;<br>        &lt;div class=<span class="hljs-string">&quot;ml-4 w-8 h-8&quot;</span>&gt;<br>          &lt;svg xmlns=<span class="hljs-string">&quot;http://www.w3.org/2000/svg&quot;</span> fill=<span class="hljs-string">&quot;none&quot;</span> viewBox=<span class="hljs-string">&quot;0 0 24 24&quot;</span> stroke=<span class="hljs-string">&quot;currentColor&quot;</span>&gt;<br>            &lt;path stroke-linecap=<span class="hljs-string">&quot;round&quot;</span> stroke-linejoin=<span class="hljs-string">&quot;round&quot;</span> stroke-width=<span class="hljs-string">&quot;1&quot;</span> d=<span class="hljs-string">&quot;M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z&quot;</span> /&gt;<br>          &lt;<span class="hljs-regexp">/svg&gt;</span><br><span class="hljs-regexp">        &lt;/div</span>&gt;<br>      &lt;% <span class="hljs-keyword">end</span> %&gt;<br>      &lt;div class=<span class="hljs-string">&quot;ml-4 w-8 h-8 cursor-pointer&quot;</span>&gt;<br>        &lt;svg xmlns=<span class="hljs-string">&quot;http://www.w3.org/2000/svg&quot;</span> fill=<span class="hljs-string">&quot;none&quot;</span> viewBox=<span class="hljs-string">&quot;0 0 24 24&quot;</span> stroke=<span class="hljs-string">&quot;currentColor&quot;</span>&gt;<br>          &lt;path stroke-linecap=<span class="hljs-string">&quot;round&quot;</span> stroke-linejoin=<span class="hljs-string">&quot;round&quot;</span> stroke-width=<span class="hljs-string">&quot;1&quot;</span> d=<span class="hljs-string">&quot;M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z&quot;</span> /&gt;<br>        &lt;<span class="hljs-regexp">/svg&gt;</span><br><span class="hljs-regexp">      &lt;/div</span>&gt;<br>      &lt;div class=<span class="hljs-string">&quot;w-8 h-8 ml-auto cursor-pointer&quot;</span>&gt;<br>        &lt;svg xmlns=<span class="hljs-string">&quot;http://www.w3.org/2000/svg&quot;</span> fill=<span class="hljs-string">&quot;none&quot;</span> viewBox=<span class="hljs-string">&quot;0 0 24 24&quot;</span> stroke=<span class="hljs-string">&quot;currentColor&quot;</span>&gt;<br>          &lt;path stroke-linecap=<span class="hljs-string">&quot;round&quot;</span> stroke-linejoin=<span class="hljs-string">&quot;round&quot;</span> stroke-width=<span class="hljs-string">&quot;1&quot;</span> d=<span class="hljs-string">&quot;M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z&quot;</span> /&gt;<br>        &lt;<span class="hljs-regexp">/svg&gt;</span><br><span class="hljs-regexp">      &lt;/div</span>&gt;<br>    &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">    &lt;!-- End Action icons section --&gt;</span><br><span class="hljs-regexp"></span><br><span class="hljs-regexp">    &lt;!-- Description section --&gt;</span><br><span class="hljs-regexp">    &lt;button class=&quot;px-5 text-xs text-gray-500 font-bold focus:outline-none&quot;&gt;&lt;%= @post.total_likes %&gt; likes&lt;/button</span>&gt;<br>    &lt;!-- End Description Section --&gt;<br>  &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp"></span><br><span class="hljs-regexp">  &lt;%= if @post.description do %&gt;</span><br><span class="hljs-regexp">    &lt;!-- Description section --&gt;</span><br><span class="hljs-regexp">    &lt;div class=&quot;flex mt-2&quot;&gt;</span><br><span class="hljs-regexp">      &lt;div class=&quot;px-4 w-11/</span><span class="hljs-number">12</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">        &lt;%= live_redirect @post.user.username,</span><br><span class="hljs-string">        to: Routes.user_profile_path(@socket, :index, @post.user.username),</span><br><span class="hljs-string">        class: &quot;</span>font-bold text-sm text-gray<span class="hljs-number">-500</span> <span class="hljs-symbol">hover:</span>underline<span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">        &lt;span class=&quot;</span>text-sm text-gray<span class="hljs-number">-700</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">          &lt;p class=&quot;</span>inline<span class="hljs-string">&quot;&gt;&lt;%= @post.description %&gt;&lt;/p&gt;&lt;/span&gt;</span><br><span class="hljs-string">        &lt;/span&gt;</span><br><span class="hljs-string">      &lt;/div&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string">  &lt;!-- End Description Section --&gt;</span><br><span class="hljs-string">  &lt;% end %&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &lt;%= if @post.total_comments &gt; 2 do %&gt;</span><br><span class="hljs-string">    &lt;%= live_redirect to: Routes.live_path(@socket, InstagramCloneWeb.PostLive.Show, @post.url_id) do %&gt;</span><br><span class="hljs-string">      &lt;h6 class=&quot;</span>px<span class="hljs-number">-5</span> text-sm text-gray<span class="hljs-number">-400</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">        View all &lt;%= @post.total_comments %&gt; comments</span><br><span class="hljs-string">      &lt;/h6&gt;</span><br><span class="hljs-string">    &lt;% end %&gt;</span><br><span class="hljs-string">  &lt;% end %&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">  &lt;section id=&quot;</span>comments<span class="hljs-string">&quot; phx-update=&quot;</span>append<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">    &lt;%= for comment &lt;- @post.comments do %&gt;</span><br><span class="hljs-string">      &lt;div class=&quot;</span>flex<span class="hljs-string">&quot; id=&quot;</span>comment-&lt;%= comment.id %&gt;<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">        &lt;div class=&quot;</span>px<span class="hljs-number">-4</span> w<span class="hljs-number">-11</span>/<span class="hljs-number">12</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">          &lt;%= live_redirect comment.user.username,</span><br><span class="hljs-string">                to: Routes.user_profile_path(@socket, :index, comment.user.username),</span><br><span class="hljs-string">                class: &quot;</span>truncate font-bold text-sm text-gray<span class="hljs-number">-500</span> <span class="hljs-symbol">hover:</span>underline<span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">          &lt;span class=&quot;</span>text-sm text-gray<span class="hljs-number">-700</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">            &lt;p class=&quot;</span>inline<span class="hljs-string">&quot;&gt;&lt;%= comment.body %&gt;&lt;/p&gt;</span><br><span class="hljs-string">          &lt;/span&gt;</span><br><span class="hljs-string">        &lt;/div&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        &lt;%= live_component @socket,</span><br><span class="hljs-string">            InstagramCloneWeb.Live.LikeComponent,</span><br><span class="hljs-string">            id: comment.id,</span><br><span class="hljs-string">            liked: comment,</span><br><span class="hljs-string">            w_h: &quot;</span>w<span class="hljs-number">-5</span> h<span class="hljs-number">-5</span><span class="hljs-string">&quot;,</span><br><span class="hljs-string">            current_user: @current_user %&gt;</span><br><span class="hljs-string">      &lt;/div&gt;</span><br><span class="hljs-string">    &lt;% end %&gt;</span><br><span class="hljs-string">    &lt;%= for comment &lt;- @comments do %&gt;</span><br><span class="hljs-string">      &lt;div class=&quot;</span>flex<span class="hljs-string">&quot; id=&quot;</span>comment-&lt;%= comment.id %&gt;<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">        &lt;div class=&quot;</span>px<span class="hljs-number">-4</span> w<span class="hljs-number">-11</span>/<span class="hljs-number">12</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">          &lt;%= live_redirect comment.user.username,</span><br><span class="hljs-string">                to: Routes.user_profile_path(@socket, :index, comment.user.username),</span><br><span class="hljs-string">                class: &quot;</span>truncate font-bold text-sm text-gray<span class="hljs-number">-500</span> <span class="hljs-symbol">hover:</span>underline<span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">          &lt;span class=&quot;</span>text-sm text-gray<span class="hljs-number">-700</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">            &lt;p class=&quot;</span>inline<span class="hljs-string">&quot;&gt;&lt;%= comment.body %&gt;&lt;/p&gt;</span><br><span class="hljs-string">          &lt;/span&gt;</span><br><span class="hljs-string">        &lt;/div&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        &lt;%= live_component @socket,</span><br><span class="hljs-string">            InstagramCloneWeb.Live.LikeComponent,</span><br><span class="hljs-string">            id: comment.id,</span><br><span class="hljs-string">            liked: comment,</span><br><span class="hljs-string">            w_h: &quot;</span>w<span class="hljs-number">-5</span> h<span class="hljs-number">-5</span><span class="hljs-string">&quot;,</span><br><span class="hljs-string">            current_user: @current_user %&gt;</span><br><span class="hljs-string">      &lt;/div&gt;</span><br><span class="hljs-string">    &lt;% end %&gt;</span><br><span class="hljs-string">  &lt;/section&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">  &lt;h6 class=&quot;</span>px<span class="hljs-number">-5</span> py<span class="hljs-number">-2</span> text-xs text-gray<span class="hljs-number">-400</span><span class="hljs-string">&quot;&gt;&lt;%= Timex.from_now(@post.inserted_at) %&gt;&lt;/h6&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &lt;!-- Comment input section --&gt;</span><br><span class="hljs-string">  &lt;%= f = form_for @changeset, &quot;</span><span class="hljs-comment">#&quot;,</span><br>	<span class="hljs-symbol">id:</span> <span class="hljs-variable">@id</span>,<br>    <span class="hljs-symbol">phx_submit:</span> <span class="hljs-string">&quot;save&quot;</span>,<br>    <span class="hljs-symbol">phx_target:</span> <span class="hljs-variable">@myself</span>,<br>    <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;p-2 flex items-center mt-3 border-t-2 border-gray-100&quot;</span>,<br>    <span class="hljs-symbol">x_data:</span> <span class="hljs-string">&quot;&#123;</span><br><span class="hljs-string">      disableSubmit: true,</span><br><span class="hljs-string">      inputText: null,</span><br><span class="hljs-string">      displayCommentBtn: (refs) =&gt; &#123;</span><br><span class="hljs-string">        refs.cbtn.classList.remove(&#x27;opacity-30&#x27;)</span><br><span class="hljs-string">        refs.cbtn.classList.remove(&#x27;cursor-not-allowed&#x27;)</span><br><span class="hljs-string">      &#125;,</span><br><span class="hljs-string">      disableCommentBtn: (refs) =&gt; &#123;</span><br><span class="hljs-string">        refs.cbtn.classList.add(&#x27;opacity-30&#x27;)</span><br><span class="hljs-string">        refs.cbtn.classList.add(&#x27;cursor-not-allowed&#x27;)</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">    &#125;&quot;</span> %&gt;<br>    &lt;div class=<span class="hljs-string">&quot;w-full&quot;</span>&gt;<br>      &lt;%= textarea f, <span class="hljs-symbol">:body</span>,<br>        <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-full border-0 focus:ring-transparent resize-none&quot;</span>,<br>        <span class="hljs-symbol">rows:</span> <span class="hljs-number">1</span>,<br>        <span class="hljs-symbol">placeholder:</span> <span class="hljs-string">&quot;Add a comment...&quot;</span>,<br>        <span class="hljs-symbol">aria_label:</span> <span class="hljs-string">&quot;Add a comment...&quot;</span>,<br>        <span class="hljs-symbol">autocorrect:</span> <span class="hljs-string">&quot;off&quot;</span>,<br>        <span class="hljs-symbol">autocomplete:</span> <span class="hljs-string">&quot;off&quot;</span>,<br>        <span class="hljs-symbol">x_model:</span> <span class="hljs-string">&quot;inputText&quot;</span>,<br>        <span class="hljs-string">&quot;@input&quot;</span>: <span class="hljs-string">&quot;[</span><br><span class="hljs-string">          (inputText.length != 0) ? [disableSubmit = false, displayCommentBtn($refs)] : [disableSubmit = true, disableCommentBtn($refs)]</span><br><span class="hljs-string">        ]&quot;</span> %&gt;<br>    &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">    &lt;div&gt;</span><br><span class="hljs-regexp">      &lt;%= submit &quot;Post&quot;,</span><br><span class="hljs-regexp">        phx_disable_with: &quot;Posting...&quot;,</span><br><span class="hljs-regexp">        class: &quot;text-light-blue-500 opacity-30 cursor-not-allowed font-bold pb-2 text-sm focus:outline-none&quot;,</span><br><span class="hljs-regexp">        x_ref: &quot;cbtn&quot;,</span><br><span class="hljs-regexp">        &quot;@click&quot;: &quot;inputText = null&quot;,</span><br><span class="hljs-regexp">        &quot;x_bind:disabled&quot;: &quot;disableSubmit&quot; %&gt;</span><br><span class="hljs-regexp">    &lt;/div</span>&gt;<br>  &lt;<span class="hljs-regexp">/form&gt;</span><br><span class="hljs-regexp">&lt;/div</span>&gt;<br></code></pre></td></tr></table></figure>

<p>我们使用与显示页面上使用的相同的表单来添加新评论，并且循环遍历帖子评论和临时评论，以便在添加新评论时能够更新评论。</p>
<p>当我们喜欢帖子或评论时，我们需要处理从 Like 组件发送的消息，我们还必须处理用钩子触发的事件以加载更多帖子，更新<code>lib/instagram_clone_web/live/page_live.ex</code>为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.PageLive</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_view</span><br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Uploaders.Avatar<br>  <span class="hljs-keyword">alias</span> InstagramClone.Accounts<br>  <span class="hljs-keyword">alias</span> InstagramCloneWeb.UserLive.FollowComponent<br>  <span class="hljs-keyword">alias</span> InstagramClone.Posts<br>  <span class="hljs-keyword">alias</span> InstagramCloneWeb.Live.LikeComponent<br><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(_params, session, socket) <span class="hljs-keyword">do</span><br>    socket = assign_defaults(session, socket)<br><br>    &#123;<span class="hljs-symbol">:ok</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">page:</span> <span class="hljs-number">1</span>, <span class="hljs-symbol">per_page:</span> <span class="hljs-number">15</span>),<br>      <span class="hljs-symbol">temporary_assigns:</span> [<span class="hljs-symbol">user_feed:</span> []]&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_params</span></span>(_params, _uri, socket) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:noreply</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">live_action:</span> apply_action(socket.assigns.current_user))<br>      |&gt; assign_posts()&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;load-more-profile-posts&quot;</span>, _, socket) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:noreply</span>, socket |&gt; load_posts&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">load_posts</span></span>(socket) <span class="hljs-keyword">do</span><br>    total_posts = socket.assigns.accounts_feed_total<br>    page = socket.assigns.page<br>    per_page = socket.assigns.per_page<br>    total_pages = ceil(total_posts / per_page)<br><br>    if page == total_pages <span class="hljs-keyword">do</span><br>      socket<br>    else<br>      socket<br>      |&gt; update(<span class="hljs-symbol">:page</span>, &amp;(&amp;<span class="hljs-number">1</span> + <span class="hljs-number">1</span>))<br>      |&gt; assign_user_feed()<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_info</span></span>(&#123;LikeComponent, <span class="hljs-symbol">:update_comment_likes</span>, _&#125;, socket) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:noreply</span>, socket&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_info</span></span>(&#123;LikeComponent, <span class="hljs-symbol">:update_post_likes</span>, post&#125;, socket) <span class="hljs-keyword">do</span><br>    post_feed = Posts.get_post_feed!(post.id)<br>    &#123;<span class="hljs-symbol">:noreply</span>,<br>      socket<br>      |&gt; update(<span class="hljs-symbol">:user_feed</span>, <span class="hljs-keyword">fn</span> user_feed -&gt; [post_feed | user_feed] <span class="hljs-keyword">end</span>)&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">apply_action</span></span>(current_user) <span class="hljs-keyword">do</span><br>    if !current_user, <span class="hljs-symbol">do:</span> <span class="hljs-symbol">:root_path</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">assign_posts</span></span>(socket) <span class="hljs-keyword">do</span><br>    if socket.assigns.current_user <span class="hljs-keyword">do</span><br>      current_user = socket.assigns.current_user<br>      following_list = Accounts.get_following_list(current_user)<br>      accounts_feed_total = Posts.get_accounts_feed_total(following_list, socket.assigns)<br><br>      socket<br>      |&gt; assign(<span class="hljs-symbol">following_list:</span> following_list)<br>      |&gt; assign(<span class="hljs-symbol">accounts_feed_total:</span> accounts_feed_total)<br>      |&gt; assign_user_feed()<br>    else<br>      socket<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">assign_user_feed</span></span>(socket) <span class="hljs-keyword">do</span><br>    user_feed = Posts.get_accounts_feed(socket.assigns.following_list, socket.assigns)<br>    socket |&gt; assign(<span class="hljs-symbol">user_feed:</span> user_feed)<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>让我们对 Like 组件进行一些更改，因为我们在帖子和评论之间共享它，将文件移动到 post_live 文件夹外部的 live 文件夹并将模块重命名为以下内​​容：</p>
<p><code>lib/instagram_clone_web/live/like_component.ex</code></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span>  <span class="hljs-title">InstagramCloneWeb.Live.LikeComponent</span></span>  <span class="hljs-keyword">do</span><br></code></pre></td></tr></table></figure>

<p><code>lib/instagram_clone_web/live/post_live/show.html.leex</code>在第 70 行内部重命名该组件：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><br>...<br>        InstagramCloneWeb.Live.LikeComponent,<br><br>...<br></code></pre></td></tr></table></figure>

<p>第 24 行内部<code>lib/instagram_clone_web/live/post_live/comment_component.html.leex</code>也重命名了该组件：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><br>...<br><br>        InstagramCloneWeb.PostLive.LikeComponent,<br>        <br>...<br></code></pre></td></tr></table></figure>

<p>在内部<code>lib/instagram_clone_web/live/like_component.ex</code>，让我们更新<code>send_msg()</code>以将 like 作为变量发送，而不仅仅是 id：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><br>...<br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">send_msg</span></span>(liked) <span class="hljs-keyword">do</span><br>    msg = get_struct_msg_atom(liked)<br>    send(<span class="hljs-keyword">self</span>(), &#123;__MODULE__, msg, liked&#125;)<br>  <span class="hljs-keyword">end</span><br><br>...<br></code></pre></td></tr></table></figure>

<p>同样在 内部<code>lib/instagram_clone_web/live/like_component.ex</code>，让我们删除该<code>liked?()</code>函数，然后检查用户 ID 是否在第 61 行的用户 ID 列表中：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><br>...<br><br>    if assigns.current_user.id <span class="hljs-keyword">in</span> assigns.liked.likes <span class="hljs-keyword">do</span> <span class="hljs-comment"># LINE 61</span><br><br><br><br>  <span class="hljs-comment"># DELETE THIS FUNCTION WE WON&quot;T NEED ANYMORE</span><br>  <span class="hljs-comment"># Enum.any?(likes, fn l -&gt;</span><br>  <span class="hljs-comment">#   l.user_id == user_id</span><br>  <span class="hljs-comment"># end)</span><br>...<br></code></pre></td></tr></table></figure>

<p>在第 30 行，我们更新以检查数据库：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><br>...<br><br>    if Likes.liked?(current_user.id, liked.id) <span class="hljs-keyword">do</span><br>...<br></code></pre></td></tr></table></figure>

<p>我们新更新的文件应如下所示：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.Live.LikeComponent</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_component</span><br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Likes<br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span></span>(assigns, socket) <span class="hljs-keyword">do</span><br>    get_btn_status(socket, assigns)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">render</span></span>(assigns) <span class="hljs-keyword">do</span><br>    <span class="hljs-string">~L&quot;&quot;&quot;</span><br><span class="hljs-string">    &lt;button</span><br><span class="hljs-string">      phx-target=&quot;&lt;%= @myself %&gt;&quot;</span><br><span class="hljs-string">      phx-click=&quot;</span>toggle-status<span class="hljs-string">&quot;</span><br><span class="hljs-string">      class=&quot;</span>&lt;%= <span class="hljs-variable">@w_h</span> %&gt; <span class="hljs-symbol">focus:</span>outline-none<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">      &lt;%= @icon %&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;/button&gt;</span><br><span class="hljs-string">    &quot;</span><span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;toggle-status&quot;</span>, _params, socket) <span class="hljs-keyword">do</span><br>    current_user = socket.assigns.current_user<br>    liked = socket.assigns.liked<br><br>    if Likes.liked?(current_user.id, liked.id) <span class="hljs-keyword">do</span><br>      unlike(socket, current_user.id, liked)<br>    else<br>      like(socket, current_user, liked)<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">like</span></span>(socket, current_user, liked) <span class="hljs-keyword">do</span><br>    Likes.create_like(current_user, liked)<br>    send_msg(liked)<br><br>    &#123;<span class="hljs-symbol">:noreply</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">icon:</span> unlike_icon(socket.assigns))&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">unlike</span></span>(socket, current_user_id, liked) <span class="hljs-keyword">do</span><br>    Likes.unlike(current_user_id, liked)<br>    send_msg(liked)<br><br>    &#123;<span class="hljs-symbol">:noreply</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">icon:</span> like_icon(socket.assigns))&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">send_msg</span></span>(liked) <span class="hljs-keyword">do</span><br>    msg = get_struct_msg_atom(liked)<br>    send(<span class="hljs-keyword">self</span>(), &#123;__MODULE__, msg, liked&#125;)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_btn_status</span></span>(socket, assigns) <span class="hljs-keyword">do</span><br>    if assigns.current_user.id <span class="hljs-keyword">in</span> assigns.liked.likes <span class="hljs-keyword">do</span><br>      get_socket_assigns(socket, assigns, unlike_icon(assigns))<br>    else<br>      get_socket_assigns(socket, assigns, like_icon(assigns))<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_socket_assigns</span></span>(socket, assigns, icon) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:ok</span>,<br>      socket<br>      |&gt; assign(assigns)<br>      |&gt; assign(<span class="hljs-symbol">icon:</span> icon)&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_struct_name</span></span>(struct) <span class="hljs-keyword">do</span><br>    struct.__struct__<br>    |&gt; Module.split()<br>    |&gt; List.last()<br>    |&gt; String.downcase()<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_struct_msg_atom</span></span>(struct) <span class="hljs-keyword">do</span><br>    name = get_struct_name(struct)<br>    update_struct_likes = <span class="hljs-string">&quot;update_<span class="hljs-subst">#&#123;name&#125;</span>_likes&quot;</span><br>    String.to_atom(update_struct_likes)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">like_icon</span></span>(assigns) <span class="hljs-keyword">do</span><br>    <span class="hljs-string">~L&quot;&quot;&quot;</span><br><span class="hljs-string">    &lt;svg xmlns=&quot;</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/www.w3.org/</span><span class="hljs-number">2000</span>/svg<span class="hljs-string">&quot; fill=&quot;</span>none<span class="hljs-string">&quot; viewBox=&quot;</span>0 0 <span class="hljs-number">24</span> <span class="hljs-number">24</span><span class="hljs-string">&quot; stroke=&quot;</span>currentColor<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      &lt;path stroke-linecap=&quot;</span>round<span class="hljs-string">&quot; stroke-linejoin=&quot;</span>round<span class="hljs-string">&quot; stroke-width=&quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot; d=&quot;</span>M4.<span class="hljs-number">318</span> <span class="hljs-number">6.318</span>a4.<span class="hljs-number">5</span> <span class="hljs-number">4.5</span> 0 000 <span class="hljs-number">6.364</span>L12 <span class="hljs-number">20.364</span>l7.<span class="hljs-number">682</span><span class="hljs-number">-7.682</span>a4.<span class="hljs-number">5</span> <span class="hljs-number">4.5</span> 0 00<span class="hljs-number">-6.364</span><span class="hljs-number">-6.364</span>L12 <span class="hljs-number">7.636</span>l<span class="hljs-number">-1.318</span><span class="hljs-number">-1.318</span>a4.<span class="hljs-number">5</span> <span class="hljs-number">4.5</span> 0 00<span class="hljs-number">-6.364</span> 0z<span class="hljs-string">&quot; /&gt;</span><br><span class="hljs-string">    &lt;/svg&gt;</span><br><span class="hljs-string">    &quot;</span><span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">unlike_icon</span></span>(assigns) <span class="hljs-keyword">do</span><br>    <span class="hljs-string">~L&quot;&quot;&quot;</span><br><span class="hljs-string">    &lt;svg class=&quot;</span>text-red<span class="hljs-number">-600</span><span class="hljs-string">&quot; xmlns=&quot;</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/www.w3.org/</span><span class="hljs-number">2000</span>/svg<span class="hljs-string">&quot; viewBox=&quot;</span>0 0 <span class="hljs-number">20</span> <span class="hljs-number">20</span><span class="hljs-string">&quot; fill=&quot;</span>currentColor<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      &lt;path fill-rule=&quot;</span>evenodd<span class="hljs-string">&quot; d=&quot;</span>M3.<span class="hljs-number">172</span> <span class="hljs-number">5.172</span>a4 <span class="hljs-number">4</span> 0 015.<span class="hljs-number">656</span> 0L10 <span class="hljs-number">6.343</span>l1.<span class="hljs-number">172</span><span class="hljs-number">-1.171</span>a4 <span class="hljs-number">4</span> 0 <span class="hljs-number">115.656</span> <span class="hljs-number">5.656</span>L10 <span class="hljs-number">17.657</span>l<span class="hljs-number">-6.828</span><span class="hljs-number">-6.829</span>a4 <span class="hljs-number">4</span> 0 010<span class="hljs-number">-5.656</span>z<span class="hljs-string">&quot; clip-rule=&quot;</span>evenodd<span class="hljs-string">&quot; /&gt;</span><br><span class="hljs-string">    &lt;/svg&gt;</span><br><span class="hljs-string">    &quot;</span><span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>现在，当我们预加载点赞时，我们只需发送 id 列表、打开，<code>lib/instagram_clone/posts.ex</code>并且在我们收到帖子的每个功能上，我们必须更新预加载点赞的方式：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramClone.Posts</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-variable">@moduledoc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  The Posts context.</span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br><br>  <span class="hljs-keyword">import</span> Ecto.Query, <span class="hljs-symbol">warn:</span> <span class="hljs-keyword">false</span><br>  <span class="hljs-keyword">alias</span> InstagramClone.Repo<br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Posts.Post<br>  <span class="hljs-keyword">alias</span> InstagramClone.Accounts.User<br>  <span class="hljs-keyword">alias</span> InstagramClone.Comments.Comment<br>  <span class="hljs-keyword">alias</span> InstagramClone.Likes.Like<br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Returns the list of posts.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; list_posts()</span><br><span class="hljs-string">      [%Post&#123;&#125;, ...]</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">list_posts</span></span> <span class="hljs-keyword">do</span><br>    Repo.all(Post)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Returns the list of paginated posts of a given user id.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; list_user_posts(page: 1, per_page: 10, user_id: 1)</span><br><span class="hljs-string">      [%&#123;photo_url: &quot;&quot;, url_id: &quot;&quot;&#125;, ...]</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">list_profile_posts</span></span>(<span class="hljs-symbol">page:</span> page, <span class="hljs-symbol">per_page:</span> per_page, <span class="hljs-symbol">user_id:</span> user_id) <span class="hljs-keyword">do</span><br>    Post<br>    |&gt; select([p], map(p, [<span class="hljs-symbol">:url_id</span>, <span class="hljs-symbol">:photo_url</span>]))<br>    |&gt; where(<span class="hljs-symbol">user_id:</span> ^user_id)<br>    |&gt; limit(^per_page)<br>    |&gt; offset(^((page - <span class="hljs-number">1</span>) * per_page))<br>    |&gt; order_by(<span class="hljs-symbol">desc:</span> <span class="hljs-symbol">:id</span>)<br>    |&gt; Repo.all<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Returns the list of paginated posts of a given user id</span><br><span class="hljs-string">  And posts of following list of given user id</span><br><span class="hljs-string">  With user and likes preloaded</span><br><span class="hljs-string">  With 2 most recent comments preloaded with user and likes</span><br><span class="hljs-string">  User, page, and per_page are given with the socket assigns</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; get_accounts_feed(following_list, assigns)</span><br><span class="hljs-string">      [%&#123;photo_url: &quot;&quot;, url_id: &quot;&quot;&#125;, ...]</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_accounts_feed</span></span>(following_list, assigns) <span class="hljs-keyword">do</span><br>    user = assigns.current_user<br>    page = assigns.page<br>    per_page = assigns.per_page<br>    query =<br>      from c <span class="hljs-keyword">in</span> Comment,<br>      <span class="hljs-symbol">select:</span> %&#123;<span class="hljs-symbol">id:</span> c.id, <span class="hljs-symbol">row_number:</span> over(row_number(), <span class="hljs-symbol">:posts_partition</span>)&#125;,<br>      <span class="hljs-symbol">windows:</span> [<span class="hljs-symbol">posts_partition:</span> [<span class="hljs-symbol">partition_by:</span> <span class="hljs-symbol">:post_id</span>, <span class="hljs-symbol">order_by:</span> [<span class="hljs-symbol">desc:</span> <span class="hljs-symbol">:id</span>]]]<br>    comments_query =<br>      from c <span class="hljs-keyword">in</span> Comment,<br>      <span class="hljs-symbol">join:</span> r <span class="hljs-keyword">in</span> subquery(query),<br>      <span class="hljs-symbol">on:</span> c.id == r.id <span class="hljs-keyword">and</span> r.row_number &lt;= <span class="hljs-number">2</span><br>    likes_query = Like |&gt; select([l], l.user_id)<br><br>    Post<br>    |&gt; where([p], p.user_id <span class="hljs-keyword">in</span> ^following_list)<br>    |&gt; or_where([p], p.user_id == ^user.id)<br>    |&gt; limit(^per_page)<br>    |&gt; offset(^((page - <span class="hljs-number">1</span>) * per_page))<br>    |&gt; order_by(<span class="hljs-symbol">desc:</span> <span class="hljs-symbol">:id</span>)<br>    |&gt; preload([<span class="hljs-symbol">:user</span>, <span class="hljs-symbol">likes:</span> ^likes_query, <span class="hljs-symbol">comments:</span> ^&#123;comments_query, [<span class="hljs-symbol">:user</span>, <span class="hljs-symbol">likes:</span> likes_query]&#125;])<br>    |&gt; Repo.all()<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Gets a single post.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  Raises `Ecto.NoResultsError` if the Post does not exist.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; get_post!(123)</span><br><span class="hljs-string">      %Post&#123;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; get_post!(456)</span><br><span class="hljs-string">      ** (Ecto.NoResultsError)</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_post!</span></span>(id) <span class="hljs-keyword">do</span><br>    likes_query = Like |&gt; select([l], l.user_id)<br><br>    Repo.get!(Post, id)<br>    |&gt; Repo.preload([<span class="hljs-symbol">:user</span>, <span class="hljs-symbol">likes:</span> likes_query])<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_post_feed!</span></span>(id) <span class="hljs-keyword">do</span><br>    query =<br>      from c <span class="hljs-keyword">in</span> Comment,<br>      <span class="hljs-symbol">select:</span> %&#123;<span class="hljs-symbol">id:</span> c.id, <span class="hljs-symbol">row_number:</span> over(row_number(), <span class="hljs-symbol">:posts_partition</span>)&#125;,<br>      <span class="hljs-symbol">windows:</span> [<span class="hljs-symbol">posts_partition:</span> [<span class="hljs-symbol">partition_by:</span> <span class="hljs-symbol">:post_id</span>, <span class="hljs-symbol">order_by:</span> [<span class="hljs-symbol">desc:</span> <span class="hljs-symbol">:id</span>]]]<br>    comments_query =<br>      from c <span class="hljs-keyword">in</span> Comment,<br>      <span class="hljs-symbol">join:</span> r <span class="hljs-keyword">in</span> subquery(query),<br>      <span class="hljs-symbol">on:</span> c.id == r.id <span class="hljs-keyword">and</span> r.row_number &lt;= <span class="hljs-number">2</span><br>    likes_query = Like |&gt; select([l], l.user_id)<br><br>    Post<br>    |&gt; preload([<span class="hljs-symbol">:user</span>, <span class="hljs-symbol">likes:</span> ^likes_query, <span class="hljs-symbol">comments:</span> ^&#123;comments_query, [<span class="hljs-symbol">:user</span>, <span class="hljs-symbol">likes:</span> likes_query]&#125;])<br>    |&gt; Repo.get!(id)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_post_by_url!</span></span>(id) <span class="hljs-keyword">do</span><br>    likes_query = Like |&gt; select([l], l.user_id)<br><br>    Repo.get_by!(Post, <span class="hljs-symbol">url_id:</span> id)<br>    |&gt; Repo.preload([<span class="hljs-symbol">:user</span>, <span class="hljs-symbol">likes:</span> likes_query])<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Creates a post.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; create_post(%&#123;field: value&#125;)</span><br><span class="hljs-string">      &#123;:ok, %Post&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; create_post(%&#123;field: bad_value&#125;)</span><br><span class="hljs-string">      &#123;:error, %Ecto.Changeset&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_post</span></span>(%Post&#123;&#125; = post, attrs \\ %&#123;&#125;, user) <span class="hljs-keyword">do</span><br>    post = Ecto.build_assoc(user, <span class="hljs-symbol">:posts</span>, put_url_id(post))<br>    changeset = Post.changeset(post, attrs)<br>    update_posts_count = from(u <span class="hljs-keyword">in</span> User, <span class="hljs-symbol">where:</span> u.id == ^user.id)<br><br>    Ecto.Multi.new()<br>    |&gt; Ecto.Multi.update_all(<span class="hljs-symbol">:update_posts_count</span>, update_posts_count, <span class="hljs-symbol">inc:</span> [<span class="hljs-symbol">posts_count:</span> <span class="hljs-number">1</span>])<br>    |&gt; Ecto.Multi.insert(<span class="hljs-symbol">:post</span>, changeset)<br>    |&gt; Repo.transaction()<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-comment"># Generates a base64-encoding 8 bytes</span><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">put_url_id</span></span>(post) <span class="hljs-keyword">do</span><br>    url_id = Base.encode64(<span class="hljs-symbol">:crypto</span>.strong_rand_bytes(<span class="hljs-number">8</span>), <span class="hljs-symbol">padding:</span> <span class="hljs-keyword">false</span>)<br><br>    %Post&#123;post | <span class="hljs-symbol">url_id:</span> url_id&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Updates a post.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; update_post(post, %&#123;field: new_value&#125;)</span><br><span class="hljs-string">      &#123;:ok, %Post&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; update_post(post, %&#123;field: bad_value&#125;)</span><br><span class="hljs-string">      &#123;:error, %Ecto.Changeset&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_post</span></span>(%Post&#123;&#125; = post, attrs) <span class="hljs-keyword">do</span><br>    post<br>    |&gt; Post.changeset(attrs)<br>    |&gt; Repo.update()<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Deletes a post.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; delete_post(post)</span><br><span class="hljs-string">      &#123;:ok, %Post&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; delete_post(post)</span><br><span class="hljs-string">      &#123;:error, %Ecto.Changeset&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete_post</span></span>(%Post&#123;&#125; = post) <span class="hljs-keyword">do</span><br>    Repo.delete(post)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Returns an `%Ecto.Changeset&#123;&#125;` for tracking post changes.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; change_post(post)</span><br><span class="hljs-string">      %Ecto.Changeset&#123;data: %Post&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">change_post</span></span>(%Post&#123;&#125; = post, attrs \\ %&#123;&#125;) <span class="hljs-keyword">do</span><br>    Post.changeset(post, attrs)<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>我们还必须对注释执行相同的操作，打开<code>lib/instagram_clone/comments.ex</code>文件并将其更新为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramClone.Comments</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-variable">@moduledoc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  The Comments context.</span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br><br>  <span class="hljs-keyword">import</span> Ecto.Query, <span class="hljs-symbol">warn:</span> <span class="hljs-keyword">false</span><br>  <span class="hljs-keyword">alias</span> InstagramClone.Repo<br>  <span class="hljs-keyword">alias</span> InstagramClone.Likes.Like<br>  <span class="hljs-keyword">alias</span> InstagramClone.Comments.Comment<br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Returns the list of comments.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; list_comments()</span><br><span class="hljs-string">      [%Comment&#123;&#125;, ...]</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">list_comments</span></span> <span class="hljs-keyword">do</span><br>    Repo.all(Comment)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">list_post_comments</span></span>(assigns, <span class="hljs-symbol">public:</span> public) <span class="hljs-keyword">do</span><br>    user = assigns.current_user<br>    post_id = assigns.post.id<br>    per_page = assigns.per_page<br>    page = assigns.page<br>    likes_query = Like |&gt; select([l], l.user_id)<br><br>    Comment<br>    |&gt; where(<span class="hljs-symbol">post_id:</span> ^post_id)<br>    |&gt; get_post_comments_sorting(public, user)<br>    |&gt; limit(^per_page)<br>    |&gt; offset(^((page - <span class="hljs-number">1</span>) * per_page))<br>    |&gt; preload([<span class="hljs-symbol">:user</span>, <span class="hljs-symbol">likes:</span> ^likes_query])<br>    |&gt; Repo.all<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_post_comments_sorting</span></span>(<span class="hljs-keyword">module</span>, public, user) <span class="hljs-keyword">do</span><br>    if public <span class="hljs-keyword">do</span><br>      order_by(<span class="hljs-keyword">module</span>, <span class="hljs-symbol">asc:</span> <span class="hljs-symbol">:id</span>)<br>    else<br>      order_by(<span class="hljs-keyword">module</span>, fragment(<span class="hljs-string">&quot;(CASE WHEN user_id = ? then 1 else 2 end)&quot;</span>, ^user.id))<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Gets a single comment.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  Raises `Ecto.NoResultsError` if the Comment does not exist.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; get_comment!(123)</span><br><span class="hljs-string">      %Comment&#123;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; get_comment!(456)</span><br><span class="hljs-string">      ** (Ecto.NoResultsError)</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_comment!</span></span>(id) <span class="hljs-keyword">do</span><br>    likes_query = Like |&gt; select([l], l.user_id)<br><br>    Repo.get!(Comment, id)<br>    |&gt; Repo.preload([<span class="hljs-symbol">:user</span>, <span class="hljs-symbol">likes:</span> likes_query])<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Creates a comment.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; create_comment(%&#123;field: value&#125;)</span><br><span class="hljs-string">      &#123;:ok, %Comment&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; create_comment(%&#123;field: bad_value&#125;)</span><br><span class="hljs-string">      &#123;:error, %Ecto.Changeset&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_comment</span></span>(user, post, attrs \\ %&#123;&#125;) <span class="hljs-keyword">do</span><br>    update_total_comments = post.__struct__ |&gt; where(<span class="hljs-symbol">id:</span> ^post.id)<br>    comment_attrs = %Comment&#123;&#125; |&gt; Comment.changeset(attrs)<br>    comment =<br>      comment_attrs<br>      |&gt; Ecto.Changeset.put_assoc(<span class="hljs-symbol">:user</span>, user)<br>      |&gt; Ecto.Changeset.put_assoc(<span class="hljs-symbol">:post</span>, post)<br><br>    Ecto.Multi.new()<br>    |&gt; Ecto.Multi.update_all(<span class="hljs-symbol">:update_total_comments</span>, update_total_comments, <span class="hljs-symbol">inc:</span> [<span class="hljs-symbol">total_comments:</span> <span class="hljs-number">1</span>])<br>    |&gt; Ecto.Multi.insert(<span class="hljs-symbol">:comment</span>, comment)<br>    |&gt; Repo.transaction()<br>    |&gt; <span class="hljs-keyword">case</span> <span class="hljs-keyword">do</span><br>      &#123;<span class="hljs-symbol">:ok</span>, %&#123;<span class="hljs-symbol">comment:</span> comment&#125;&#125; -&gt;<br>        likes_query = Like |&gt; select([l], l.user_id)<br>        comment |&gt; Repo.preload(<span class="hljs-symbol">likes:</span> likes_query)<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Updates a comment.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; update_comment(comment, %&#123;field: new_value&#125;)</span><br><span class="hljs-string">      &#123;:ok, %Comment&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; update_comment(comment, %&#123;field: bad_value&#125;)</span><br><span class="hljs-string">      &#123;:error, %Ecto.Changeset&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_comment</span></span>(%Comment&#123;&#125; = comment, attrs) <span class="hljs-keyword">do</span><br>    comment<br>    |&gt; Comment.changeset(attrs)<br>    |&gt; Repo.update()<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Deletes a comment.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; delete_comment(comment)</span><br><span class="hljs-string">      &#123;:ok, %Comment&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; delete_comment(comment)</span><br><span class="hljs-string">      &#123;:error, %Ecto.Changeset&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete_comment</span></span>(%Comment&#123;&#125; = comment) <span class="hljs-keyword">do</span><br>    Repo.delete(comment)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Returns an `%Ecto.Changeset&#123;&#125;` for tracking comment changes.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; change_comment(comment)</span><br><span class="hljs-string">      %Ecto.Changeset&#123;data: %Comment&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">change_comment</span></span>(%Comment&#123;&#125; = comment, attrs \\ %&#123;&#125;) <span class="hljs-keyword">do</span><br>    Comment.changeset(comment, attrs)<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>内部<code>lib/instagram_clone_web/live/post_live/show.ex</code>更新第 6 行：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><br>...<br><br>  <span class="hljs-keyword">alias</span> InstagramCloneWeb.Live.LikeComponent<br><br>...<br></code></pre></td></tr></table></figure>

<p>里面<code>lib/instagram_clone_web/live/post_live/show.html.leex</code>更新第70行和行：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><br>...<br><br>              InstagramCloneWeb.Live.LikeComponent,<br><br>...<br></code></pre></td></tr></table></figure>

<p>内部<code>lib/instagram_clone_web/live/post_live/comment_component.html.leex</code>更新第 24 行：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><br>...<br><br>        InstagramCloneWeb.Live.LikeComponent,<br><br>...<br></code></pre></td></tr></table></figure>

<p>更新<code>lib/instagram_clone/likes.ex</code>如下：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramClone.Likes</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">import</span> Ecto.Query, <span class="hljs-symbol">warn:</span> <span class="hljs-keyword">false</span><br>  <span class="hljs-keyword">alias</span> InstagramClone.Repo<br>  <span class="hljs-keyword">alias</span> InstagramClone.Likes.Like<br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_like</span></span>(user, liked) <span class="hljs-keyword">do</span><br>    user = Ecto.build_assoc(user, <span class="hljs-symbol">:likes</span>)<br>    like = Ecto.build_assoc(liked, <span class="hljs-symbol">:likes</span>, user)<br>    update_total_likes = liked.__struct__ |&gt; where(<span class="hljs-symbol">id:</span> ^liked.id)<br><br>    Ecto.Multi.new()<br>    |&gt; Ecto.Multi.insert(<span class="hljs-symbol">:like</span>, like)<br>    |&gt; Ecto.Multi.update_all(<span class="hljs-symbol">:update_total_likes</span>, update_total_likes, <span class="hljs-symbol">inc:</span> [<span class="hljs-symbol">total_likes:</span> <span class="hljs-number">1</span>])<br>    |&gt; Repo.transaction()<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unlike</span></span>(user_id, liked) <span class="hljs-keyword">do</span><br>    like = liked?(user_id, liked.id)<br>    update_total_likes = liked.__struct__ |&gt; where(<span class="hljs-symbol">id:</span> ^liked.id)<br><br>    Ecto.Multi.new()<br>    |&gt; Ecto.Multi.delete(<span class="hljs-symbol">:like</span>, like)<br>    |&gt; Ecto.Multi.update_all(<span class="hljs-symbol">:update_total_likes</span>, update_total_likes, <span class="hljs-symbol">inc:</span> [<span class="hljs-symbol">total_likes:</span> <span class="hljs-number">-1</span>])<br>    |&gt; Repo.transaction()<br>  <span class="hljs-keyword">end</span><br><br><br>  <span class="hljs-comment"># Returns nil if not found</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">liked?</span></span>(user_id, liked_id) <span class="hljs-keyword">do</span><br>    Repo.get_by(Like, [<span class="hljs-symbol">user_id:</span> user_id, <span class="hljs-symbol">liked_id:</span> liked_id])<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>让我们添加一个包含 5 个随机用户建议的侧边栏，在里面<code>lib/instagram_clone/accounts.ex</code>添加以下函数：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">random_5</span></span>(user) <span class="hljs-keyword">do</span><br>  following_list = get_following_list(user)<br><br>  User<br>  |&gt; where([u], u.id <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> ^following_list)<br>  |&gt; where([u], u.id != ^user.id)<br>  |&gt; order_by(<span class="hljs-symbol">desc:</span> fragment(<span class="hljs-string">&quot;Random()&quot;</span>))<br>  |&gt; limit(<span class="hljs-number">5</span>)<br>  |&gt; Repo.all()<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>在里面<code>lib/instagram_clone_web/live/page_live.ex</code>添加一个<code>handle_info()</code>并将私有<code>assign_posts()</code>函数更新为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><br>...<br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_info</span></span>(&#123;FollowComponent, <span class="hljs-symbol">:update_totals</span>, _&#125;, socket) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:noreply</span>, socket&#125;<br>  <span class="hljs-keyword">end</span><br>  <br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">assign_posts</span></span>(socket) <span class="hljs-keyword">do</span><br>    if socket.assigns.current_user <span class="hljs-keyword">do</span><br>      current_user = socket.assigns.current_user<br>      random_5_users = Accounts.random_5(current_user)<br><br>      socket<br>      |&gt; assign(<span class="hljs-symbol">users:</span> random_5_users)<br>      |&gt; assign_user_feed()<br>    else<br>      socket<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>现在要显示带有随机用户的侧边栏，请将 Inside 更新<code>lib/instagram_clone_web/live/page_live.html.leex</code>为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= if <span class="hljs-variable">@current_user</span> <span class="hljs-keyword">do</span> %&gt;<br>  &lt;section class=<span class="hljs-string">&quot;flex&quot;</span>&gt;<br>    &lt;div id=<span class="hljs-string">&quot;user-feed&quot;</span> class=<span class="hljs-string">&quot;w-3/5&quot;</span> phx-update=<span class="hljs-string">&quot;append&quot;</span>&gt;<br>      &lt;%= <span class="hljs-keyword">for</span> post &lt;- <span class="hljs-variable">@user_feed</span> <span class="hljs-keyword">do</span> %&gt;<br>        &lt;%= live_component <span class="hljs-variable">@socket</span>,<br>          InstagramCloneWeb.Live.PagePostFeedComponent,<br>          <span class="hljs-symbol">post:</span> post,<br>          <span class="hljs-symbol">id:</span> post.id,<br>          <span class="hljs-symbol">current_user:</span> <span class="hljs-variable">@current_user</span> %&gt;<br>      &lt;% <span class="hljs-keyword">end</span> %&gt;<br>    &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp"></span><br><span class="hljs-regexp"></span><br><span class="hljs-regexp">    &lt;div&gt;</span><br><span class="hljs-regexp">      &lt;sidebar class=&quot;fixed w-1/</span><span class="hljs-number">4</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">        &lt;section class=&quot;</span> ml-auto pl<span class="hljs-number">-8</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">          &lt;div class=&quot;</span>flex items-center<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">            &lt;!-- Post header section --&gt;</span><br><span class="hljs-string">            &lt;%= live_redirect to: Routes.user_profile_path(@socket, :index, @current_user.username) do %&gt;</span><br><span class="hljs-string">              &lt;%= img_tag Avatar.get_thumb(@current_user.avatar_url), class: &quot;</span>w<span class="hljs-number">-14</span> h<span class="hljs-number">-14</span> rounded-full object-cover object-center<span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">            &lt;% end %&gt;</span><br><span class="hljs-string">            &lt;div class=&quot;</span>ml<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">              &lt;%= live_redirect @current_user.username,</span><br><span class="hljs-string">                to: Routes.user_profile_path(@socket, :index, @current_user.username),</span><br><span class="hljs-string">                class: &quot;</span>truncate font-bold text-sm text-gray<span class="hljs-number">-500</span> <span class="hljs-symbol">hover:</span>underline<span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">              &lt;h2 class=&quot;</span>text-sm text-gray<span class="hljs-number">-500</span><span class="hljs-string">&quot;&gt;&lt;%= @current_user.full_name %&gt;&lt;/h2&gt;</span><br><span class="hljs-string">            &lt;/div&gt;</span><br><span class="hljs-string">            &lt;!-- End post header section --&gt;</span><br><span class="hljs-string">          &lt;/div&gt;</span><br><span class="hljs-string">          &lt;h1 class=&quot;</span>text-gray<span class="hljs-number">-500</span> mt<span class="hljs-number">-5</span><span class="hljs-string">&quot;&gt;Suggestions For You&lt;/h1&gt;</span><br><span class="hljs-string">          &lt;%= for user &lt;- @users do %&gt;</span><br><span class="hljs-string">            &lt;div class=&quot;</span>flex items-center p<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">              &lt;!-- Post header section --&gt;</span><br><span class="hljs-string">              &lt;%= live_redirect to: Routes.user_profile_path(@socket, :index, user.username) do %&gt;</span><br><span class="hljs-string">                &lt;%= img_tag Avatar.get_thumb(user.avatar_url), class: &quot;</span>w<span class="hljs-number">-10</span> h<span class="hljs-number">-10</span> rounded-full object-cover object-center<span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">              &lt;% end %&gt;</span><br><span class="hljs-string">              &lt;div class=&quot;</span>ml<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">                &lt;%= live_redirect user.username,</span><br><span class="hljs-string">                  to: Routes.user_profile_path(@socket, :index, user.username),</span><br><span class="hljs-string">                  class: &quot;</span>truncate font-bold text-sm text-gray<span class="hljs-number">-500</span> <span class="hljs-symbol">hover:</span>underline<span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">                &lt;h2 class=&quot;</span>text-xs text-gray<span class="hljs-number">-500</span><span class="hljs-string">&quot;&gt;Suggested for you&lt;/h2&gt;</span><br><span class="hljs-string">              &lt;/div&gt;</span><br><span class="hljs-string">              &lt;span class=&quot;</span>ml-auto<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">                &lt;%= live_component @socket,</span><br><span class="hljs-string">                  InstagramCloneWeb.UserLive.FollowComponent,</span><br><span class="hljs-string">                  id: user.id,</span><br><span class="hljs-string">                  user: user,</span><br><span class="hljs-string">                  current_user: @current_user %&gt;</span><br><span class="hljs-string">              &lt;/span&gt;</span><br><span class="hljs-string">              &lt;!-- End post header section --&gt;</span><br><span class="hljs-string">            &lt;/div&gt;</span><br><span class="hljs-string">          &lt;% end %&gt;</span><br><span class="hljs-string">        &lt;/section&gt;</span><br><span class="hljs-string">      &lt;/sidebar&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string">  &lt;/section&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &lt;div</span><br><span class="hljs-string">    id=&quot;</span>profile-posts-footer<span class="hljs-string">&quot;</span><br><span class="hljs-string">    class=&quot;</span>flex justify-center<span class="hljs-string">&quot;</span><br><span class="hljs-string">    phx-hook=&quot;</span>ProfilePostsScroll<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">  &lt;/div&gt;</span><br><span class="hljs-string">&lt;% else %&gt;</span><br><span class="hljs-string">  &lt;%= live_component @socket,</span><br><span class="hljs-string">    InstagramCloneWeb.PageLiveComponent,</span><br><span class="hljs-string">    id: 1 %&gt;</span><br><span class="hljs-string">&lt;% end %&gt;</span><br></code></pre></td></tr></table></figure>

<p>现在就是这样，您可以通过将以下列表发送到后续组件来提高代码效率，从而无需访问数据库即可设置按钮，从而改进代码。</p>
<p>转自：<a target="_blank" rel="noopener" href="https://elixirprogrammer.com/learn/lets-build-an-instagram-clone-with-the-petal-phoenix-elixir-tailwindcss-alpinejs-liveview-stack-part-6/">Elixirprogrammer</a></p>

  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>本文作者：</strong>MarkHoo<br>
        <strong>本文链接：</strong><a href="https://blog.markhoo.com/posts/instagram-phoenix-liveview-p6/" title="https:&#x2F;&#x2F;blog.markhoo.com&#x2F;posts&#x2F;instagram-phoenix-liveview-p6&#x2F;" target="_blank" rel="noopener">https:&#x2F;&#x2F;blog.markhoo.com&#x2F;posts&#x2F;instagram-phoenix-liveview-p6&#x2F;</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 进行许可
        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
    
        <a class="nexmoefont icon-appstore-fill -link" href="/categories/Elixir/">Elixir</a>
    
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/AlpineJS/" rel="tag">AlpineJS</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Elixir/" rel="tag">Elixir</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/LiveView/" rel="tag">LiveView</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Phoenix/" rel="tag">Phoenix</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/TailwindCSS/" rel="tag">TailwindCSS</a>
    
</div>

  
      <div class="nexmoe-post-footer">
          <section class="nexmoe-comment">
    <div class="valine"></div>
<script src='https://cdn.jsdelivr.net/npm/valine'></script>
<script>
    // 使用方法 https://valine.js.org/quickstart.html
    new Valine({
        el: '.valine',
        appId: 'LnljA9jtf29oZKiQMJ6OAWJU-gzGzoHsz',
        appKey: 'wb1Mrzef0b2x540dSrcCcg5y'
    })
</script>
</section>
      </div>
  
</div>
            <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                        
                          
                          
                          
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
        </div>
    </div>
     
    <div id="nexmoe-search-space">
        <div class="search-container">
            <div class="search-header">
                <div class="search-input-container">
                    <input class="search-input" type="text" placeholder="搜索" oninput="sinput();">
                </div>
                <a class="search-close" onclick="sclose();">×</a>
            </div>
            <div class="search-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/combine/npm/lazysizes@5.1.0/lazysizes.min.js,npm/mdui@0.4.3/dist/js/mdui.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

 

<script async src="/js/app.js?v=1693394618055"></script>



<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>


    





</body>

</html>
