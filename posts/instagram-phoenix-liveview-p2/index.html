<!DOCTYPE html>

<html lang="zh-CN">

<head>
    
    <title>使用 Phoenix LiveView 构建 Instagram (2) - 和光同尘|MarkHoo_不积跬步无以至千里，不积小流无以成江海</title>
    <meta charset="UTF-8">
    <meta name="description" content="终日而思,不如须臾之所学也">
    <meta name="keywords" content="和光同尘,MarkHoo,Python,Elixir,Phoenix,SpringBoot,Django,">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    

    <link rel="shortcut icon" href="https://media.markhoo.com/image/favicon24.ico" type="image/x-icon" />
    <meta name="description" content="使用PETAL(Phoenix、Elixir、TailwindCSS、AlpineJS、LiveView)技术栈构建一个简化版的Instagram Web应用程序">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 Phoenix LiveView 构建 Instagram (2)">
<meta property="og:url" content="https://blog.markhoo.com/posts/instagram-phoenix-liveview-p2/">
<meta property="og:site_name" content="和光同尘|MarkHoo_不积跬步无以至千里，不积小流无以成江海">
<meta property="og:description" content="使用PETAL(Phoenix、Elixir、TailwindCSS、AlpineJS、LiveView)技术栈构建一个简化版的Instagram Web应用程序">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/08/30/IXqUdL51HQPWxeu.jpg">
<meta property="og:image" content="https://s2.loli.net/2023/08/30/IXqUdL51HQPWxeu.jpg">
<meta property="article:published_time" content="2023-08-30T14:43:40.000Z">
<meta property="article:modified_time" content="2023-08-30T09:03:11.681Z">
<meta property="article:author" content="MarkHoo">
<meta property="article:tag" content="Elixir">
<meta property="article:tag" content="Phoenix">
<meta property="article:tag" content="LiveView">
<meta property="article:tag" content="TailwindCSS">
<meta property="article:tag" content="AlpineJS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/08/30/IXqUdL51HQPWxeu.jpg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/npm/highlight.js@9.15.8/styles/atom-one-dark.css,npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css,gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css,npm/hexo-theme-nexmoe@latest/source/lib/mdui_043tiny/css/mdui.css,npm/hexo-theme-nexmoe@latest/source/lib/iconfont/iconfont.css?v=233" crossorigin>
    <link rel="stylesheet" href="/css/style.css?v=1693393777288">
     
    
    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1693393777288">
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="mdui-drawer-body-left">
    
    <div id="nexmoe-background">
        <div class="nexmoe-bg" style="background-image: url(https://s2.loli.net/2023/08/30/SfpNaZsg3IW5MDz.jpg)"></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="MarkHoo" class="mdui-btn mdui-btn-icon"><img src="https://media.markhoo.com/avatar.jpg" alt="MarkHoo"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="MarkHoo">
            <img src="https://media.markhoo.com/avatar.jpg" alt="MarkHoo" alt="MarkHoo">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>53</div>
        <div><span>标签</span>40</div>
        <div><span>分类</span>11</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archives" title="归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/books" title="书架">
            <i class="mdui-list-item-icon nexmoefont icon-battlenet"></i>
            <div class="mdui-list-item-content">
                书架
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about" title="关于">
            <i class="mdui-list-item-icon nexmoefont icon-coffee"></i>
            <div class="mdui-list-item-content">
                关于
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/links" title="邻居">
            <i class="mdui-list-item-icon nexmoefont icon-dribbble"></i>
            <div class="mdui-list-item-content">
                邻居
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
        
            <form id="search_form">
                <label><input class="st-default-search-input" id="search_value" name="q" type="search" placeholder="搜索" style="
                    font-size: 15px !important;
                    height: 56px !important;
                    background-image: none;
                "></label>
            </form>
         
    </div>
</div>
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://jq.qq.com/" target="_blank" mdui-tooltip="{content: 'QQ群'}" style="color: rgb(249, 174, 8);background-color: rgba(249, 174, 8, .1);">
            <i class="nexmoefont icon-QQ"></i>
        </a><a class="mdui-ripple" href="https://space.bilibili.com/182687081" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/markhoo/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
    
    
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/API/" style="font-size: 10px;">API</a> <a href="/tags/AlpineJS/" style="font-size: 16.25px;">AlpineJS</a> <a href="/tags/ArchLinux/" style="font-size: 10px;">ArchLinux</a> <a href="/tags/C-C/" style="font-size: 10px;">C/C++</a> <a href="/tags/CentOS7/" style="font-size: 15px;">CentOS7</a> <a href="/tags/Django/" style="font-size: 18.75px;">Django</a> <a href="/tags/Elixir/" style="font-size: 18.75px;">Elixir</a> <a href="/tags/EndeavourOS/" style="font-size: 10px;">EndeavourOS</a> <a href="/tags/Erlang/" style="font-size: 10px;">Erlang</a> <a href="/tags/Gin/" style="font-size: 10px;">Gin</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/Gitlab/" style="font-size: 10px;">Gitlab</a> <a href="/tags/Go/" style="font-size: 16.25px;">Go</a> <a href="/tags/Gunicorn/" style="font-size: 12.5px;">Gunicorn</a> <a href="/tags/Hugo/" style="font-size: 10px;">Hugo</a> <a href="/tags/IDE/" style="font-size: 11.25px;">IDE</a> <a href="/tags/JWT/" style="font-size: 10px;">JWT</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Linux/" style="font-size: 13.75px;">Linux</a> <a href="/tags/LiveView/" style="font-size: 16.25px;">LiveView</a> <a href="/tags/Lua/" style="font-size: 11.25px;">Lua</a> <a href="/tags/Manim/" style="font-size: 10px;">Manim</a> <a href="/tags/NeoVim/" style="font-size: 11.25px;">NeoVim</a> <a href="/tags/Nginx/" style="font-size: 13.75px;">Nginx</a> <a href="/tags/Phoenix/" style="font-size: 17.5px;">Phoenix</a> <a href="/tags/PyCharm/" style="font-size: 10px;">PyCharm</a> <a href="/tags/Python/" style="font-size: 20px;">Python</a> <a href="/tags/Rest/" style="font-size: 10px;">Rest</a> <a href="/tags/TailwindCSS/" style="font-size: 16.25px;">TailwindCSS</a> <a href="/tags/Unix/" style="font-size: 10px;">Unix</a> <a href="/tags/Vim/" style="font-size: 12.5px;">Vim</a> <a href="/tags/hexo/" style="font-size: 11.25px;">hexo</a> <a href="/tags/pip/" style="font-size: 11.25px;">pip</a> <a href="/tags/pypi/" style="font-size: 10px;">pypi</a> <a href="/tags/xadmin/" style="font-size: 10px;">xadmin</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E7%BD%91%E6%98%93%E4%BA%91%E9%9F%B3%E4%B9%90/" style="font-size: 10px;">网易云音乐</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 11.25px;">面试题</a> <a href="/tags/%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8/" style="font-size: 10px;">音乐播放器</a>
    </div>
    
  </div>

    
</aside>
    <div class="nexmoe-copyright">
        &copy; 2023 MarkHoo
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        <br><a target="_blank" href="https://beian.miit.gov.cn">苏ICP备17044309号</a><br><a target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"><img src="https://i.dawnlab.me/c0268c1e6cfd0863d6ba35be1575941a.png" width="150px"></a><script data-ad-client="ca-pub-2058306854838448" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
            <div class="nexmoe-post">

  <article>
      
          <div class="nexmoe-post-cover" style="padding-bottom: 45.83333333333333%;"> 
              <img data-src="https://s2.loli.net/2023/08/30/SfpNaZsg3IW5MDz.jpg" data-sizes="auto" alt="使用 Phoenix LiveView 构建 Instagram (2)" class="lazyload">
              <h1>使用 Phoenix LiveView 构建 Instagram (2)</h1>
          </div>
      
      
      <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2023年08月30日</a>
    <a><i class="nexmoefont icon-areachart"></i>5.2k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 29 分钟</a>
</div>

      

      <blockquote>
<p>使用PETAL(Phoenix、Elixir、TailwindCSS、AlpineJS、LiveView)技术栈构建一个简化版的Instagram Web应用程序</p>
</blockquote>
<span id="more"></span>

<p>在第 1 部分中，我们已完成所有设置并准备好基本布局，让我们开始处理用户设置。您可以赶上Instagram 克隆 GitHub Repo。</p>
<p>让我们首先创建路由，打开<code>lib/instagram_clone_web/router.ex</code>并在范围下添加以下 2 条路由:<code>require_authenticated_user</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs elixir">scope <span class="hljs-string">&quot;/&quot;</span>, InstagramCloneWeb <span class="hljs-keyword">do</span><br>  pipe_through [<span class="hljs-symbol">:browser</span>, <span class="hljs-symbol">:require_authenticated_user</span>]<br><br>  get <span class="hljs-string">&quot;/users/settings/confirm_email/:token&quot;</span>, UserSettingsController, <span class="hljs-symbol">:confirm_email</span><br>  live <span class="hljs-string">&quot;/accounts/edit&quot;</span>, UserLive.Settings<br>  live <span class="hljs-string">&quot;/accounts/password/change&quot;</span>, UserLive.PassSettings<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>然后我们需要创建这些 liveview 文件，在该文件夹内创建一个名为<code>user_live</code>under 的文件夹<code>lib/instagram_clone_web/live</code>，添加以下 4 个文件：</p>
<p><code>lib/instagram_clone_web/live/user_live/settings.ex</code> <code>lib/instagram_clone_web/live/user_live/settings.html.leex</code> <code>lib/instagram_clone_web/live/user_live/pass_settings.ex</code> <code>lib/instagram_clone_web/live/user_live/pass_settings.html.leex</code></p>
<p>在我们的导航标题中，我们需要链接到该新路线，lib/instagram_clone_web/live/header_nav_component.html.leex在第 60 行打开，将以下内容添加到<code>Settings live_patch to</code>:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= live_patch <span class="hljs-symbol">to:</span>  Routes.live_path(<span class="hljs-variable">@socket</span>, InstagramCloneWeb.UserLive.Settings)  <span class="hljs-keyword">do</span>  %&gt;<br>  &lt;li  class=<span class="hljs-string">&quot;py-2 px-4 hover:bg-gray-50&quot;</span>&gt;Settings&lt;<span class="hljs-regexp">/li&gt;</span><br><span class="hljs-regexp">&lt;%  end  %&gt;</span><br></code></pre></td></tr></table></figure>

<p>现在，当我们访问该链接时，我们应该会出现错误，因为文件是空的，因此打开<code>lib/instagram_clone_web/live/user_live/settings.ex</code>并添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span>  <span class="hljs-title">InstagramCloneWeb.UserLive.Settings</span></span>  <span class="hljs-keyword">do</span><br><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb,  <span class="hljs-symbol">:live_view</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span>  <span class="hljs-title">mount</span></span>(_params, session, socket) <span class="hljs-keyword">do</span><br>    socket =  assign_defaults(session, socket)<br><br>    &#123;<span class="hljs-symbol">:ok</span>, socket&#125;<br>  <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>现在我们应该有一个空白页面，只有顶部导航栏，所以让我们开始工作吧。</p>
<p>我们将需要<code>Accounts</code>和<code>User</code>上下文，我们将为它们添加别名并分配变更集，我们的文件应如下所示：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span>  <span class="hljs-title">InstagramCloneWeb.UserLive.Settings</span></span>  <span class="hljs-keyword">do</span><br><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb,  <span class="hljs-symbol">:live_view</span><br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Accounts<br>  <span class="hljs-keyword">alias</span> InstagramClone.Accounts.User<br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span>  <span class="hljs-title">mount</span></span>(_params, session, socket) <span class="hljs-keyword">do</span><br>    socket =  assign_defaults(session, socket)<br>    changeset = Accounts.change_user(socket.assigns.current_user)<br><br>    &#123;<span class="hljs-symbol">:ok</span>, <br>      socket<br>      |&gt;  assign(<span class="hljs-symbol">changeset:</span> changeset)&#125;<br>  <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>我们需要将<code>change_user()</code>函数添加到<code>Accounts</code>上下文中，打开<code>lib/instagram_clone/accounts.ex</code>并在<code>change_user_registration()</code>函数下面添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs elixir">...<br><br><span class="hljs-function"><span class="hljs-keyword">def</span>  <span class="hljs-title">change_user</span></span>(user, attrs \\  %&#123;&#125;) <span class="hljs-keyword">do</span><br>  User.registration_changeset(user, attrs,  <span class="hljs-symbol">register_user:</span>  <span class="hljs-keyword">false</span>)<br><span class="hljs-keyword">end</span><br><br>...<br></code></pre></td></tr></table></figure>

<p>打开<code>lib/instagram_clone_web/live/user_live/settings.html.leex</code>并将表单添加到模板中：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;section class=<span class="hljs-string">&quot;border-2 flex&quot;</span> x-data=<span class="hljs-string">&quot;&#123;username: &#x27;&lt;%= @current_user.username %&gt;&#x27;&#125;&quot;</span>&gt;<br><br>  &lt;div class=<span class="hljs-string">&quot;w-full py-8&quot;</span>&gt;<br>    &lt;!-- Profile Photo --&gt;<br>    &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>      &lt;div class=<span class="hljs-string">&quot;w-1/3&quot;</span>&gt;<br>        &lt;%= img_tag <span class="hljs-variable">@current_user</span>.avatar_url, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;ml-auto w-10 h-10 rounded-full object-cover object-center&quot;</span> %&gt;<br>      &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">      &lt;div class=&quot;w-full pl-8&quot;&gt;</span><br><span class="hljs-regexp">        &lt;h1 x-text=&quot;username&quot; class=&quot;leading-none font-semibold text-lg truncate text-gray-500&quot;&gt;&lt;/h</span>1&gt;<br>      &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">    &lt;/div</span>&gt;<br>    &lt;!-- END PROFILE PHOTO --&gt;<br><br>    &lt;%= f = form_for <span class="hljs-variable">@changeset</span>, <span class="hljs-string">&quot;#&quot;</span>,<br>      <span class="hljs-symbol">phx_change:</span> <span class="hljs-string">&quot;validate&quot;</span>,<br>      <span class="hljs-symbol">phx_submit:</span> <span class="hljs-string">&quot;save&quot;</span>,<br>      <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;space-y-8 md:space-y-10&quot;</span> %&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>        &lt;%= label f, <span class="hljs-symbol">:full_name</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-1/3 text-right font-semibold&quot;</span> %&gt;<br>        &lt;div class=<span class="hljs-string">&quot;w-full pl-8 pr-20&quot;</span>&gt;<br>          &lt;%= text_input f, <span class="hljs-symbol">:full_name</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-4/6 rounded p-1 text-semibold text-gray-600 border-gray-300 focus:ring-transparent focus:border-black&quot;</span>, <span class="hljs-symbol">autocomplete:</span> <span class="hljs-string">&quot;off&quot;</span> %&gt;<br>          &lt;%= error_tag f, <span class="hljs-symbol">:full_name</span>, <span class="hljs-symbol">class:</span>  <span class="hljs-string">&quot;text-red-700 text-sm block&quot;</span> %&gt;<br>        &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">      &lt;/div</span>&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>        &lt;%= label f, <span class="hljs-symbol">:username</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-1/3 text-right font-semibold&quot;</span> %&gt;<br>        &lt;div class=<span class="hljs-string">&quot;w-full pl-8 pr-20&quot;</span>&gt;<br>          &lt;%= text_input f, <span class="hljs-symbol">:username</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-4/6 rounded p-1 text-semibold text-gray-600 border-gray-300 focus:ring-transparent focus:border-black&quot;</span>, <span class="hljs-symbol">x_model:</span> <span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-symbol">autocomplete:</span> <span class="hljs-string">&quot;off&quot;</span> %&gt;<br>          &lt;%= error_tag f, <span class="hljs-symbol">:username</span>, <span class="hljs-symbol">class:</span>  <span class="hljs-string">&quot;text-red-700 text-sm block&quot;</span> %&gt;<br>        &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">      &lt;/div</span>&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>        &lt;%= label f, <span class="hljs-symbol">:website</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-1/3 text-right font-semibold&quot;</span> %&gt;<br>        &lt;div class=<span class="hljs-string">&quot;w-full pl-8 pr-20&quot;</span>&gt;<br>          &lt;%= text_input f, <span class="hljs-symbol">:website</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-4/6 rounded p-1 text-semibold text-gray-600 border-gray-300 focus:ring-transparent focus:border-black&quot;</span>, <span class="hljs-symbol">autocomplete:</span> <span class="hljs-string">&quot;off&quot;</span> %&gt;<br>          &lt;%= error_tag f, <span class="hljs-symbol">:website</span>, <span class="hljs-symbol">class:</span>  <span class="hljs-string">&quot;text-red-700 text-sm block&quot;</span> %&gt;<br>        &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">      &lt;/div</span>&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>        &lt;%= label f, <span class="hljs-symbol">:bio</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-1/3 text-right font-semibold&quot;</span> %&gt;<br>        &lt;div class=<span class="hljs-string">&quot;w-full pl-8 pr-20&quot;</span>&gt;<br>          &lt;%= textarea f, <span class="hljs-symbol">:bio</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-4/6 rounded p-1 text-semibold text-gray-600 border-gray-300 focus:ring-transparent focus:border-black&quot;</span>, <span class="hljs-symbol">rows:</span> <span class="hljs-number">3</span>, <span class="hljs-symbol">autocomplete:</span> <span class="hljs-string">&quot;off&quot;</span> %&gt;<br>          &lt;%= error_tag f, <span class="hljs-symbol">:bio</span>, <span class="hljs-symbol">class:</span>  <span class="hljs-string">&quot;text-red-700 text-sm block&quot;</span> %&gt;<br>        &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">      &lt;/div</span>&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>        &lt;%= label f, <span class="hljs-symbol">:email</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-1/3 text-right font-semibold&quot;</span> %&gt;<br>        &lt;div class=<span class="hljs-string">&quot;w-full pl-8 pr-20&quot;</span>&gt;<br>          &lt;%= email_input f, <span class="hljs-symbol">:email</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-4/6 rounded p-1 text-semibold text-gray-600 border-gray-300 shadow-sm focus:ring-transparent focus:border-black&quot;</span>, <span class="hljs-symbol">autocomplete:</span> <span class="hljs-string">&quot;off&quot;</span> %&gt;<br>          &lt;%= error_tag f, <span class="hljs-symbol">:email</span>, <span class="hljs-symbol">class:</span>  <span class="hljs-string">&quot;text-red-700 text-sm block&quot;</span> %&gt;<br>        &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">      &lt;/div</span>&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>        &lt;label class=<span class="hljs-string">&quot;block w-1/3 font-semibold text-right&quot;</span>&gt;&lt;<span class="hljs-regexp">/label&gt;</span><br><span class="hljs-regexp">        &lt;div class=&quot;w-full pl-8 pr-20&quot;&gt;</span><br><span class="hljs-regexp">          &lt;%= submit &quot;Submit&quot;, phx_disable_with: &quot;Saving...&quot;, class: &quot;w-16 py-1 px-1 border-none shadow rounded font-semibold text-sm text-gray-50 hover:bg-light-blue-600 bg-light-blue-500 cursor-pointer&quot; %&gt;</span><br><span class="hljs-regexp">        &lt;/div</span>&gt;<br>      &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">    &lt;/form</span>&gt;<br>  &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">&lt;/section</span>&gt;<br></code></pre></td></tr></table></figure>

<p>我们添加了表单的基本布局，当您使用 AlpineJs 输入用户名时，用户名标题会更新。现在我们需要将<code>validate()</code>和<code>save()</code>函数添加到我们的<code>lib/instagram_clone_web/live/user_live/settings.ex</code>实时查看文档中，但我们首先将我们分配<code>:page_title</code>给我们的挂载函数：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(_params, session, socket) <span class="hljs-keyword">do</span><br>  socket = assign_defaults(session, socket)<br>  changeset = Accounts.change_user(socket.assigns.current_user)<br><br>  &#123;<span class="hljs-symbol">:ok</span>,<br>    socket<br>    |&gt; assign(<span class="hljs-symbol">changeset:</span> changeset)<br>    |&gt; assign(<span class="hljs-symbol">page_title:</span> <span class="hljs-string">&quot;Edit Profile&quot;</span>)&#125; <span class="hljs-comment">#This was added</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>然后打开<code>lib/instagram_clone_web/templates/layout/root.html.leex</code>并更新页面标题后缀：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= live_title_tag assigns[<span class="hljs-symbol">:page_title</span>]  ||  <span class="hljs-string">&quot;InstagramClone&quot;</span>,  <span class="hljs-symbol">suffix:</span>  <span class="hljs-string">&quot; · InstagramClone&quot;</span>  %&gt;<br></code></pre></td></tr></table></figure>

<p>现在让我们将处理表单的函数添加到我们的<code>lib/instagram_clone_web/live/user_live/settings.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;validate&quot;</span>, %&#123;<span class="hljs-string">&quot;user&quot;</span> =&gt; user_params&#125;, socket) <span class="hljs-keyword">do</span><br>  changeset =<br>    socket.assigns.current_user<br>    |&gt; Accounts.change_user(user_params)<br>    |&gt; Map.put(<span class="hljs-symbol">:action</span>, <span class="hljs-symbol">:validate</span>)<br><br>  &#123;<span class="hljs-symbol">:noreply</span>, socket |&gt; assign(<span class="hljs-symbol">changeset:</span> changeset)&#125;<br><span class="hljs-keyword">end</span><br><br><span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;save&quot;</span>, %&#123;<span class="hljs-string">&quot;user&quot;</span> =&gt; user_params&#125;, socket) <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">case</span> Accounts.update_user(socket.assigns.current_user, user_params) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:ok</span>, _user&#125; -&gt;<br>      &#123;<span class="hljs-symbol">:noreply</span>,<br>        socket<br>        |&gt; put_flash(<span class="hljs-symbol">:info</span>, <span class="hljs-string">&quot;User updated successfully&quot;</span>)<br>        |&gt; push_redirect(<span class="hljs-symbol">to:</span> Routes.live_path(socket, InstagramWeb.UserLive.Settings))&#125;<br><br>    &#123;<span class="hljs-symbol">:error</span>, %Ecto.Changeset&#123;&#125; = changeset&#125; -&gt;<br>      &#123;<span class="hljs-symbol">:noreply</span>, assign(socket, <span class="hljs-symbol">:changeset</span>, changeset)&#125;<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>现在我们需要将<code>update_user()</code>函数添加到<code>Accounts</code>上下文中：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs elixir">...<br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_user</span></span>(user, attrs) <span class="hljs-keyword">do</span><br>    user<br>    |&gt; User.registration_changeset(attrs, <span class="hljs-symbol">register_user:</span> <span class="hljs-keyword">false</span>)<br>    |&gt; Repo.update()<br>  <span class="hljs-keyword">end</span><br><br>...<br></code></pre></td></tr></table></figure>

<p>我们对用户名的唯一约束不起作用，因为我们没有在迁移中添加唯一索引，所以我们现在就这样做。在我们的终端中，让我们生成一个迁移<code>$ mix ecto.gen.migration add_users_unique_username_index</code>，然后打开生成的迁移<code>priv/repo/migrations/20210414220125_add_users_unique_username_index.exs</code>并添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramClone.Repo.Migrations.AddUsersUniqueUsernameIndex</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> Ecto.Migration<br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">change</span></span> <span class="hljs-keyword">do</span><br>    create unique_index(<span class="hljs-symbol">:users</span>, [<span class="hljs-symbol">:username</span>])<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>然后返回我们的终端并运行迁移<code>$ mix ecto.migrate</code></p>
<p>现在让我们更新我们的注册变更<code>lib/instagram_clone/accounts/user.ex</code>集<code>unsafe_validate_unique(:username, InstagramClone.Repo)</code></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs elixir">...<br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">registration_changeset</span></span>(user, attrs, opts \\ []) <span class="hljs-keyword">do</span><br>    user<br>    |&gt; cast(attrs, [<span class="hljs-symbol">:email</span>, <span class="hljs-symbol">:password</span>, <span class="hljs-symbol">:username</span>, <span class="hljs-symbol">:full_name</span>, <span class="hljs-symbol">:avatar_url</span>, <span class="hljs-symbol">:bio</span>, <span class="hljs-symbol">:website</span>])<br>    |&gt; validate_required([<span class="hljs-symbol">:username</span>, <span class="hljs-symbol">:full_name</span>])<br>    |&gt; validate_length(<span class="hljs-symbol">:username</span>, <span class="hljs-symbol">min:</span> <span class="hljs-number">5</span>, <span class="hljs-symbol">max:</span> <span class="hljs-number">30</span>)<br>    |&gt; validate_format(<span class="hljs-symbol">:username</span>, <span class="hljs-string">~r/^[a-zA-Z0-9_.-]*$/</span>, <span class="hljs-symbol">message:</span> <span class="hljs-string">&quot;Please use letters and numbers without space(only characters allowed _ . -)&quot;</span>)<br>    |&gt; unique_constraint(<span class="hljs-symbol">:username</span>)<br>    |&gt; unsafe_validate_unique(<span class="hljs-symbol">:username</span>, InstagramClone.Repo) <span class="hljs-comment"># --&gt; This was added</span><br>    |&gt; validate_length(<span class="hljs-symbol">:full_name</span>, <span class="hljs-symbol">min:</span> <span class="hljs-number">4</span>, <span class="hljs-symbol">max:</span> <span class="hljs-number">30</span>)<br>    |&gt; validate_email()<br>    |&gt; validate_password(opts)<br> <span class="hljs-keyword">end</span><br><br>...<br></code></pre></td></tr></table></figure>

<p><code>:timer.sleep(9000)</code>另外，在测试时，我意识到我在尝试延迟实时验证时犯了一个错误，<code>lib/instagram_clone_web/live/page_live.ex</code>所以让我们从<code>validate()</code>函数中删除该行，因为它会与表单产生冲突：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;validate&quot;</span>, %&#123;<span class="hljs-string">&quot;user&quot;</span> =&gt; user_params&#125;, socket) <span class="hljs-keyword">do</span><br>  changeset =<br>    %User&#123;&#125;<br>    |&gt; User.registration_changeset(user_params)<br>    |&gt; Map.put(<span class="hljs-symbol">:action</span>, <span class="hljs-symbol">:validate</span>)<br>  <span class="hljs-comment">#:timer.sleep(9000) &lt;-- REMOVE THIS LINE</span><br>  &#123;<span class="hljs-symbol">:noreply</span>, socket |&gt; assign(<span class="hljs-symbol">changeset:</span> changeset)&#125;<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="https://s2.loli.net/2023/08/30/IXqUdL51HQPWxeu.jpg" alt="instagram-phoenix-p2-1.jpg" class="lazyload"></p>
<p>完成后，我们应该能够毫无问题地编辑配置文件，所以现在让我们开始上传头像文件。</p>
<h2 id="头像上传"><a href="#头像上传" class="headerlink" title="头像上传"></a>头像上传</h2><p>打开<code>lib/instagram_clone_web/live/user_live/settings.ex</code>并允许在实时视图中上传，新的更新文件应如下所示：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.UserLive.Settings</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_view</span><br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Accounts<br>  <span class="hljs-keyword">alias</span> InstagramClone.Accounts.User<br>  <span class="hljs-comment">#Files extensions accepted to be uploaded</span><br>  <span class="hljs-variable">@extension_whitelist</span> <span class="hljs-string">~w(.jpg .jpeg .png)</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(_params, session, socket) <span class="hljs-keyword">do</span><br>    socket = assign_defaults(session, socket)<br>    changeset = Accounts.change_user(socket.assigns.current_user)<br><br>    &#123;<span class="hljs-symbol">:ok</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">changeset:</span> changeset)<br>      |&gt; assign(<span class="hljs-symbol">page_title:</span> <span class="hljs-string">&quot;Edit Profile&quot;</span>)<br>      |&gt; allow_upload(<span class="hljs-symbol">:avatar_url</span>,<br>      <span class="hljs-symbol">accept:</span> <span class="hljs-variable">@extension_whitelist</span>,<br>      <span class="hljs-symbol">max_file_size:</span> <span class="hljs-number">9_000_000</span>,<br>      <span class="hljs-symbol">progress:</span> &amp;handle_progress/<span class="hljs-number">3</span>,<span class="hljs-comment">#Function that will handle automatic uploads</span><br>      <span class="hljs-symbol">auto_upload:</span> <span class="hljs-keyword">true</span>)&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;validate&quot;</span>, %&#123;<span class="hljs-string">&quot;user&quot;</span> =&gt; user_params&#125;, socket) <span class="hljs-keyword">do</span><br>    changeset =<br>      socket.assigns.current_user<br>      |&gt; Accounts.change_user(user_params)<br>      |&gt; Map.put(<span class="hljs-symbol">:action</span>, <span class="hljs-symbol">:validate</span>)<br><br>    &#123;<span class="hljs-symbol">:noreply</span>, socket |&gt; assign(<span class="hljs-symbol">changeset:</span> changeset)&#125;<br>  <span class="hljs-keyword">end</span><br>  <span class="hljs-comment"># Updates the socket when the upload form changes, triguers handle_progress()</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;upload_avatar&quot;</span>, _params, socket) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:noreply</span>, socket&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;save&quot;</span>, %&#123;<span class="hljs-string">&quot;user&quot;</span> =&gt; user_params&#125;, socket) <span class="hljs-keyword">do</span><br>    <span class="hljs-keyword">case</span> Accounts.update_user(socket.assigns.current_user, user_params) <span class="hljs-keyword">do</span><br>      &#123;<span class="hljs-symbol">:ok</span>, _user&#125; -&gt;<br>        &#123;<span class="hljs-symbol">:noreply</span>,<br>          socket<br>          |&gt; put_flash(<span class="hljs-symbol">:info</span>, <span class="hljs-string">&quot;User updated successfully&quot;</span>)<br>          |&gt; push_redirect(<span class="hljs-symbol">to:</span> Routes.live_path(socket, InstagramCloneWeb.UserLive.Settings))&#125;<br><br>      &#123;<span class="hljs-symbol">:error</span>, %Ecto.Changeset&#123;&#125; = changeset&#125; -&gt;<br>        &#123;<span class="hljs-symbol">:noreply</span>, assign(socket, <span class="hljs-symbol">:changeset</span>, changeset)&#125;<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br>  <span class="hljs-comment"># This will handle the upload</span><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">handle_progress</span></span>(<span class="hljs-symbol">:avatar_url</span>, entry, socket) <span class="hljs-keyword">do</span><br><br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>打开<code>lib/instagram_clone_web/live/user_live/settings.html.leex</code>并在用户名标题下方添加上传表单，并将该表单<code>@uploads</code>分配给我们的套接字：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;section class=<span class="hljs-string">&quot;border-2 flex&quot;</span> x-data=<span class="hljs-string">&quot;&#123;username: &#x27;&lt;%= @current_user.username %&gt;&#x27;&#125;&quot;</span>&gt;<br><br>  &lt;div class=<span class="hljs-string">&quot;w-full py-8&quot;</span>&gt;<br>    &lt;%= <span class="hljs-keyword">for</span> &#123;_ref, err&#125; &lt;- <span class="hljs-variable">@uploads</span>.avatar_url.errors <span class="hljs-keyword">do</span> %&gt;<br>      &lt;p class=<span class="hljs-string">&quot;text-red-500 w-full text-center&quot;</span>&gt;<br>        &lt;%= Phoenix.Naming.humanize(err) %&gt;<br>      &lt;<span class="hljs-regexp">/p&gt;</span><br><span class="hljs-regexp">    &lt;% end %&gt;</span><br><span class="hljs-regexp">    &lt;!-- Profile Photo --&gt;</span><br><span class="hljs-regexp">    &lt;div class=&quot;flex items-center&quot;&gt;</span><br><span class="hljs-regexp">      &lt;div class=&quot;w-1/</span><span class="hljs-number">3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">        &lt;%= img_tag @current_user.avatar_url, class: &quot;</span>ml-auto w<span class="hljs-number">-10</span> h<span class="hljs-number">-10</span> rounded-full object-cover object-center<span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">      &lt;/div&gt;</span><br><span class="hljs-string">      &lt;div class=&quot;</span>w-full pl<span class="hljs-number">-8</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">        &lt;h1 x-text=&quot;</span>username<span class="hljs-string">&quot; class=&quot;</span>leading-none font-semibold text-lg truncate text-gray<span class="hljs-number">-500</span><span class="hljs-string">&quot;&gt;&lt;/h1&gt;</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        &lt;!-- THIS WAS ADDED --&gt;</span><br><span class="hljs-string">        &lt;div  class=&quot;</span>relative<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">          &lt;%= form_for @changeset,  &quot;</span><span class="hljs-comment">#&quot;,</span><br>            <span class="hljs-symbol">phx_change:</span>  <span class="hljs-string">&quot;upload_avatar&quot;</span>  %&gt;<br>            &lt;%= live_file_input <span class="hljs-variable">@uploads</span>.avatar_url,  <span class="hljs-symbol">class:</span>  <span class="hljs-string">&quot;cursor-pointer relative block opacity-0 z-40 -left-24&quot;</span>  %&gt;<br>            &lt;div  class=<span class="hljs-string">&quot;text-center absolute top-0 left-0 m-auto&quot;</span>&gt;<br>              &lt;span  class=<span class="hljs-string">&quot;font-semibold text-sm text-light-blue-500&quot;</span>&gt;<br>                Change Profile Photo<br>              &lt;<span class="hljs-regexp">/span&gt;</span><br><span class="hljs-regexp">            &lt;/div</span>&gt;<br>          &lt;<span class="hljs-regexp">/form&gt;</span><br><span class="hljs-regexp">        &lt;/div</span>&gt;<br>        &lt;!-- THIS WAS ADDED END --&gt;<br>        <br>      &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">    &lt;/div</span>&gt;<br>    &lt;!-- END PROFILE PHOTO --&gt;<br><br>    &lt;%= f = form_for <span class="hljs-variable">@changeset</span>, <span class="hljs-string">&quot;#&quot;</span>,<br>      <span class="hljs-symbol">phx_change:</span> <span class="hljs-string">&quot;validate&quot;</span>,<br>      <span class="hljs-symbol">phx_submit:</span> <span class="hljs-string">&quot;save&quot;</span>,<br>      <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;space-y-8 md:space-y-10&quot;</span> %&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>        &lt;%= label f, <span class="hljs-symbol">:full_name</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-1/3 text-right font-semibold&quot;</span> %&gt;<br>        &lt;div class=<span class="hljs-string">&quot;w-full pl-8 pr-20&quot;</span>&gt;<br>          &lt;%= text_input f, <span class="hljs-symbol">:full_name</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-4/6 rounded p-1 text-semibold text-gray-600 border-gray-300 focus:ring-transparent focus:border-black&quot;</span>, <span class="hljs-symbol">autocomplete:</span> <span class="hljs-string">&quot;off&quot;</span> %&gt;<br>          &lt;%= error_tag f, <span class="hljs-symbol">:full_name</span>, <span class="hljs-symbol">class:</span>  <span class="hljs-string">&quot;text-red-700 text-sm block&quot;</span> %&gt;<br>        &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">      &lt;/div</span>&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>        &lt;%= label f, <span class="hljs-symbol">:username</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-1/3 text-right font-semibold&quot;</span> %&gt;<br>        &lt;div class=<span class="hljs-string">&quot;w-full pl-8 pr-20&quot;</span>&gt;<br>          &lt;%= text_input f, <span class="hljs-symbol">:username</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-4/6 rounded p-1 text-semibold text-gray-600 border-gray-300 focus:ring-transparent focus:border-black&quot;</span>, <span class="hljs-symbol">x_model:</span> <span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-symbol">autocomplete:</span> <span class="hljs-string">&quot;off&quot;</span> %&gt;<br>          &lt;%= error_tag f, <span class="hljs-symbol">:username</span>, <span class="hljs-symbol">class:</span>  <span class="hljs-string">&quot;text-red-700 text-sm block&quot;</span> %&gt;<br>        &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">      &lt;/div</span>&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>        &lt;%= label f, <span class="hljs-symbol">:website</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-1/3 text-right font-semibold&quot;</span> %&gt;<br>        &lt;div class=<span class="hljs-string">&quot;w-full pl-8 pr-20&quot;</span>&gt;<br>          &lt;%= text_input f, <span class="hljs-symbol">:website</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-4/6 rounded p-1 text-semibold text-gray-600 border-gray-300 focus:ring-transparent focus:border-black&quot;</span>, <span class="hljs-symbol">autocomplete:</span> <span class="hljs-string">&quot;off&quot;</span> %&gt;<br>          &lt;%= error_tag f, <span class="hljs-symbol">:website</span>, <span class="hljs-symbol">class:</span>  <span class="hljs-string">&quot;text-red-700 text-sm block&quot;</span> %&gt;<br>        &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">      &lt;/div</span>&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>        &lt;%= label f, <span class="hljs-symbol">:bio</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-1/3 text-right font-semibold&quot;</span> %&gt;<br>        &lt;div class=<span class="hljs-string">&quot;w-full pl-8 pr-20&quot;</span>&gt;<br>          &lt;%= textarea f, <span class="hljs-symbol">:bio</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-4/6 rounded p-1 text-semibold text-gray-600 border-gray-300 focus:ring-transparent focus:border-black&quot;</span>, <span class="hljs-symbol">rows:</span> <span class="hljs-number">3</span>, <span class="hljs-symbol">autocomplete:</span> <span class="hljs-string">&quot;off&quot;</span> %&gt;<br>          &lt;%= error_tag f, <span class="hljs-symbol">:bio</span>, <span class="hljs-symbol">class:</span>  <span class="hljs-string">&quot;text-red-700 text-sm block&quot;</span> %&gt;<br>        &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">      &lt;/div</span>&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>        &lt;%= label f, <span class="hljs-symbol">:email</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-1/3 text-right font-semibold&quot;</span> %&gt;<br>        &lt;div class=<span class="hljs-string">&quot;w-full pl-8 pr-20&quot;</span>&gt;<br>          &lt;%= email_input f, <span class="hljs-symbol">:email</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-4/6 rounded p-1 text-semibold text-gray-600 border-gray-300 shadow-sm focus:ring-transparent focus:border-black&quot;</span>, <span class="hljs-symbol">autocomplete:</span> <span class="hljs-string">&quot;off&quot;</span> %&gt;<br>          &lt;%= error_tag f, <span class="hljs-symbol">:email</span>, <span class="hljs-symbol">class:</span>  <span class="hljs-string">&quot;text-red-700 text-sm block&quot;</span> %&gt;<br>        &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">      &lt;/div</span>&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>        &lt;label class=<span class="hljs-string">&quot;block w-1/3 font-semibold text-right&quot;</span>&gt;&lt;<span class="hljs-regexp">/label&gt;</span><br><span class="hljs-regexp">        &lt;div class=&quot;w-full pl-8 pr-20&quot;&gt;</span><br><span class="hljs-regexp">          &lt;%= submit &quot;Submit&quot;, phx_disable_with: &quot;Saving...&quot;, class: &quot;w-16 py-1 px-1 border-none shadow rounded font-semibold text-sm text-gray-50 hover:bg-light-blue-600 bg-light-blue-500 cursor-pointer&quot; %&gt;</span><br><span class="hljs-regexp">        &lt;/div</span>&gt;<br>      &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">    &lt;/form</span>&gt;<br>  &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">&lt;/section</span>&gt;<br></code></pre></td></tr></table></figure>

<p>现在让我们创建一个模块来帮助我们处理头像上传。在下面<code>lib/instagram_clone_web/live</code>添加一个名为 的文件夹<code>uploaders</code>，并在该文件夹内添加一个名为 的文件<code>avatar.ex</code>。我们将调整头像的大小，因此让我们添加 Mogrify 依赖项来处理它，确保安装了 ImageMagick，打开<code>mix.exs</code>并添加到我们的项目依赖项<code>&#123;:mogrify, &quot;~&gt; 0.8.0&quot;&#125;</code>，然后在我们的终端中<code>$ mix deps.get &amp;&amp; mix deps.compile</code>。</p>
<p>现在打开<code>lib/instagram_clone_web/live/uploaders/avatar.ex</code>并添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramClone.Uploaders.Avatar</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">alias</span> InstagramCloneWeb.Router.Helpers, <span class="hljs-symbol">as:</span> Routes<br>  <br>  <span class="hljs-comment"># We are going to upload locally so this would be the name of the folder</span><br>  <span class="hljs-variable">@upload_directory_name</span> <span class="hljs-string">&quot;uploads&quot;</span><br>  <span class="hljs-variable">@upload_directory_path</span> <span class="hljs-string">&quot;priv/static/uploads&quot;</span><br>  <br>  <span class="hljs-comment"># Returns the extensions associated with a given MIME type.</span><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">ext</span></span>(entry) <span class="hljs-keyword">do</span><br>    [ext | _] = MIME.extensions(entry.client_type)<br>    ext<br>  <span class="hljs-keyword">end</span><br>  <br>  <span class="hljs-comment"># Returns the url path</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_avatar_url</span></span>(socket, entry) <span class="hljs-keyword">do</span><br>    Routes.static_path(socket, <span class="hljs-string">&quot;/<span class="hljs-subst">#&#123;<span class="hljs-variable">@upload_directory_name</span>&#125;</span>/<span class="hljs-subst">#&#123;entry.uuid&#125;</span>.<span class="hljs-subst">#&#123;ext(entry)&#125;</span>&quot;</span>)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span></span>(socket, old_url, entry) <span class="hljs-keyword">do</span><br>    <span class="hljs-comment"># Creates the upload directry path if not exists </span><br>    if !File.exists?(<span class="hljs-variable">@upload_directory_path</span>), <span class="hljs-symbol">do:</span> File.mkdir!(<span class="hljs-variable">@upload_directory_path</span>)<br>    <br>    <span class="hljs-comment"># Consumes an individual uploaded entry</span><br>    Phoenix.LiveView.consume_uploaded_entry(socket, entry, <span class="hljs-keyword">fn</span> %&#123;&#125; = meta -&gt;<br>      <span class="hljs-comment"># Destination paths for avatar thumbs</span><br>      dest = Path.join(<span class="hljs-variable">@upload_directory_path</span>, <span class="hljs-string">&quot;<span class="hljs-subst">#&#123;entry.uuid&#125;</span>.<span class="hljs-subst">#&#123;ext(entry)&#125;</span>&quot;</span>)<br>      dest_thumb = Path.join(<span class="hljs-variable">@upload_directory_path</span>, <span class="hljs-string">&quot;thumb_<span class="hljs-subst">#&#123;entry.uuid&#125;</span>.<span class="hljs-subst">#&#123;ext(entry)&#125;</span>&quot;</span>)<br>      <br>      <span class="hljs-comment"># meta.path is the temporary file path</span><br>      mogrify_thumbnail(meta.path, dest, <span class="hljs-number">300</span>)<br>      mogrify_thumbnail(meta.path, dest_thumb, <span class="hljs-number">150</span>)<br>      <br>      <span class="hljs-comment"># Removes Old Urls Paths</span><br>      rm_file(old_url)<br>      old_url |&gt; get_thumb() |&gt; rm_file()<br>    <span class="hljs-keyword">end</span>)<br><br>    <span class="hljs-symbol">:ok</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_thumb</span></span>(avatar_url) <span class="hljs-keyword">do</span><br>    file_name = String.replace_leading(avatar_url, <span class="hljs-string">&quot;/uploads/&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>    [<span class="hljs-string">&quot;/<span class="hljs-subst">#&#123;<span class="hljs-variable">@upload_directory_name</span>&#125;</span>&quot;</span>, <span class="hljs-string">&quot;thumb_<span class="hljs-subst">#&#123;file_name&#125;</span>&quot;</span>] |&gt; Path.join()<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rm_file</span></span>(old_avatar_url) <span class="hljs-keyword">do</span><br>    url = String.replace_leading(old_avatar_url, <span class="hljs-string">&quot;/uploads/&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>    path = [<span class="hljs-variable">@upload_directory_path</span>, url] |&gt; Path.join()<br><br>    if File.exists?(path),  <span class="hljs-symbol">do:</span> File.rm!(path)<br>  <span class="hljs-keyword">end</span><br>  <br>  <span class="hljs-comment"># Resize the file with a given path, destination, and size</span><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">mogrify_thumbnail</span></span>(src_path, dst_path, size) <span class="hljs-keyword">do</span><br>    try <span class="hljs-keyword">do</span><br>      Mogrify.open(src_path)<br>      |&gt; Mogrify.resize_to_limit(<span class="hljs-string">&quot;<span class="hljs-subst">#&#123;size&#125;</span>x<span class="hljs-subst">#&#123;size&#125;</span>&quot;</span>)<br>      |&gt; Mogrify.save(<span class="hljs-symbol">path:</span> dst_path)<br>    rescue<br>      File.Error -&gt; &#123;<span class="hljs-symbol">:error</span>, <span class="hljs-symbol">:invalid_src_path</span>&#125;<br>      error -&gt; &#123;<span class="hljs-symbol">:error</span>, error&#125;<br>    else<br>      _image -&gt; &#123;<span class="hljs-symbol">:ok</span>, dst_path&#125;<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>在文件顶部打开<code>lib/instagram_clone_web/live/user_live/settings.ex</code>新创建的模块的别名，并使用以下内容更新我们的函数：<code>Avataralias InstagramClone.Uploaders.Avatarhandle_progress()</code></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs elixir"> <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">handle_progress</span></span>(<span class="hljs-symbol">:avatar_url</span>, entry, socket) <span class="hljs-keyword">do</span><br><span class="hljs-comment"># If file is already uploaded to tmp folder</span><br>   if entry.done? <span class="hljs-keyword">do</span><br>     avatar_url = Avatar.get_avatar_url(socket, entry)<br>     user_params = %&#123;<span class="hljs-string">&quot;avatar_url&quot;</span> =&gt; avatar_url&#125;<br>     <span class="hljs-keyword">case</span> Accounts.update_user(socket.assigns.current_user, user_params) <span class="hljs-keyword">do</span><br>       &#123;<span class="hljs-symbol">:ok</span>, _user&#125; -&gt;<br>         Avatar.update(socket, socket.assigns.current_user.avatar_url, entry)<br>         <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">           We have to update the current user and assign it back to the socket </span><br><span class="hljs-string">           to get the header nav thumbnail automatically updated</span><br><span class="hljs-string">         &quot;&quot;&quot;</span><br>         current_user = Accounts.get_user!(socket.assigns.current_user.id)<br>         &#123;<span class="hljs-symbol">:noreply</span>,<br>           socket<br>           |&gt; put_flash(<span class="hljs-symbol">:info</span>, <span class="hljs-string">&quot;Avatar updated successfully&quot;</span>)<br>           |&gt; assign(<span class="hljs-symbol">current_user:</span> current_user)&#125;<br>       &#123;<span class="hljs-symbol">:error</span>, %Ecto.Changeset&#123;&#125; = changeset&#125; -&gt;<br>         &#123;<span class="hljs-symbol">:noreply</span>, assign(socket, <span class="hljs-symbol">:changeset</span>, changeset)&#125;<br>     <span class="hljs-keyword">end</span><br>   else<br>     &#123;<span class="hljs-symbol">:noreply</span>, socket&#125;<br>   <span class="hljs-keyword">end</span><br> <span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>最后，我们需要提供上传目录中将要创建的文件，打开<code>lib/instagram_clone_web/endpoint.ex</code>并更新静态插件中的第 27 行：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-symbol">only:</span>  <span class="hljs-string">~w(css fonts images js favicon.ico robots.txt uploads)</span><br></code></pre></td></tr></table></figure>

<p>现在一切都应该工作得很好，但我们正在上传缩略图，所以让我们在模板中使用它，打开<code>lib/instagram_clone_web/live/header_nav_component.html.leex</code>并更新第 43 行以使用我们的缩略图 URL：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= img_tag InstagramClone.Uploaders.Avatar.get_thumb(<span class="hljs-variable">@current_user</span>.avatar_url), <span class="hljs-symbol">class:</span>  <span class="hljs-string">&quot;w-full h-full object-cover object-center&quot;</span>  %&gt;<br></code></pre></td></tr></table></figure>

<p>同时打开<code>lib/instagram_clone_web/live/user_live/settings.html.leex</code>并更新第 7 行以使用我们的缩略图：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= img_tag Avatar.get_thumb(<span class="hljs-variable">@current_user</span>.avatar_url),  <span class="hljs-symbol">class:</span>  <span class="hljs-string">&quot;ml-auto w-10 h-10 rounded-full object-cover object-center&quot;</span>  %&gt;<br></code></pre></td></tr></table></figure>

<h2 id="密码更改设置"><a href="#密码更改设置" class="headerlink" title="密码更改设置"></a>密码更改设置</h2><p>现在剩下的唯一一件事就是更改密码，我们将需要一个侧面导航栏，因此让我们创建一个组件来处理它，因为它将与密码更改 LiveView 共享。在下面<code>lib/instagram_clone_web/live/user_live</code>添加以下2个文件：</p>
<p><code>lib/instagram_clone_web/live/user_live/settings_sidebar_component.ex</code> <code>lib/instagram_clone_web/live/user_live/settings_sidebar_component.html.leex</code></p>
<p>添加<code>lib/instagram_clone_web/live/user_live/settings_sidebar_component.ex</code>以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span>  <span class="hljs-title">InstagramCloneWeb.UserLive.SettingsSidebarComponent</span></span>  <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb,  <span class="hljs-symbol">:live_component</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>添加<code>lib/instagram_clone_web/live/user_live/settings_sidebar_component.html.leex</code>以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;div class=<span class="hljs-string">&quot;w-1/4 border-r-2&quot;</span>&gt;<br>  &lt;ul&gt;<br>    &lt;%= live_patch content_tag(<span class="hljs-symbol">:li</span>, <span class="hljs-string">&quot;Edit Profile&quot;</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;p-4 <span class="hljs-subst">#&#123;selected_link?(<span class="hljs-variable">@current_uri_path</span>,  <span class="hljs-variable">@settings_path</span>)&#125;</span>&quot;</span>),  <span class="hljs-symbol">to:</span>  <span class="hljs-variable">@settings_path</span> %&gt;<br>    &lt;%= live_patch content_tag(<span class="hljs-symbol">:li</span>, <span class="hljs-string">&quot;Change Password&quot;</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;p-4 <span class="hljs-subst">#&#123;selected_link?(<span class="hljs-variable">@current_uri_path</span>,  <span class="hljs-variable">@pass_settings_path</span>)&#125;</span>&quot;</span>),  <span class="hljs-symbol">to:</span>  <span class="hljs-variable">@pass_settings_path</span> %&gt;<br>  &lt;<span class="hljs-regexp">/ul&gt;</span><br><span class="hljs-regexp">&lt;/div</span>&gt;<br></code></pre></td></tr></table></figure>

<p><code>render_helpers.ex</code>在 下创建一个名为<code>lib/instagram_clone_web/live</code>. 打开<code>lib/instagram_clone_web/live/render_helpers.ex</code>并执行以下操作：:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span>  <span class="hljs-title">InstagramCloneWeb.RenderHelpers</span></span>  <span class="hljs-keyword">do</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span>  <span class="hljs-title">selected_link?</span></span>(current_uri, menu_link) <span class="hljs-keyword">when</span> current_uri == menu_link <span class="hljs-keyword">do</span><br>    <span class="hljs-string">&quot;border-l-2 border-black -ml-0.5 text-gray-900 font-semibold&quot;</span><br>  <span class="hljs-keyword">end</span><br><br>  <br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span>  <span class="hljs-title">selected_link?</span></span>(_current_uri,  _menu_link) <span class="hljs-keyword">do</span><br>    <span class="hljs-string">&quot;hover:border-l-2 -ml-0.5 hover:border-gray-300 hover:bg-gray-50&quot;</span><br>  <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>这些功能将帮助我们为侧面导航栏中的链接获取正确的样式。现在我们需要在模板中提供这些函数，打开<code>lib/instagram_clone_web.ex</code>视图助手函数并将其更新为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">view_helpers</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">quote</span> <span class="hljs-keyword">do</span><br>    <span class="hljs-comment"># Use all HTML functionality (forms, tags, etc)</span><br>    <span class="hljs-keyword">use</span> Phoenix.HTML<br><br>    <span class="hljs-comment"># Import LiveView helpers (live_render, live_component, live_patch, etc)</span><br>    <span class="hljs-keyword">import</span> Phoenix.LiveView.Helpers<br><br>    <span class="hljs-comment"># Import basic rendering functionality (render, render_layout, etc)</span><br>    <span class="hljs-keyword">import</span> Phoenix.View<br><br>    <span class="hljs-keyword">import</span> InstagramCloneWeb.ErrorHelpers<br>    <span class="hljs-keyword">import</span> InstagramCloneWeb.Gettext<br>    <span class="hljs-keyword">import</span> InstagramCloneWeb.RenderHelpers <span class="hljs-comment"># &lt;-- THIS LINE WAS ADDED</span><br>    <span class="hljs-keyword">alias</span> InstagramCloneWeb.Router.Helpers, <span class="hljs-symbol">as:</span> Routes<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>让我们将路径分配给套接字，打开<code>lib/instagram_clone_web/live/user_live/settings.ex</code>并在安装中添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(_params, session, socket) <span class="hljs-keyword">do</span><br>  socket = assign_defaults(session, socket)<br>  changeset = Accounts.change_user(socket.assigns.current_user)<br>  <span class="hljs-comment"># THIS WAS ADDED</span><br>  settings_path = Routes.live_path(socket, __MODULE__)<br>  pass_settings_path = Routes.live_path(socket, InstagramCloneWeb.UserLive.PassSettings)<br><br><br>  &#123;<span class="hljs-symbol">:ok</span>,<br>    socket<br>    |&gt; assign(<span class="hljs-symbol">changeset:</span> changeset)<br>    |&gt; assign(<span class="hljs-symbol">page_title:</span> <span class="hljs-string">&quot;Edit Profile&quot;</span>)<br>    |&gt; assign(<span class="hljs-symbol">settings_path:</span> settings_path, <span class="hljs-symbol">pass_settings_path:</span> pass_settings_path)<span class="hljs-comment"># &lt;-- THIS WAS ADDED</span><br>    |&gt; allow_upload(<span class="hljs-symbol">:avatar_url</span>,<br>    <span class="hljs-symbol">accept:</span> <span class="hljs-variable">@extension_whitelist</span>,<br>    <span class="hljs-symbol">max_file_size:</span> <span class="hljs-number">9_000_000</span>,<br>    <span class="hljs-symbol">progress:</span> &amp;handle_progress/<span class="hljs-number">3</span>,<br>    <span class="hljs-symbol">auto_upload:</span> <span class="hljs-keyword">true</span>)&#125;<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p><code>lib/instagram_clone_web/live/user_live/settings.html.leex</code>在标签开头下方顶部的部分标签内打开，让我们插入我们的组件：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= live_component <span class="hljs-variable">@socket</span>, InstagramCloneWeb.UserLive.SettingsSidebarComponent,  <br>  <span class="hljs-symbol">settings_path:</span>  <span class="hljs-variable">@settings_path</span>,  <br>  <span class="hljs-symbol">pass_settings_path:</span>  <span class="hljs-variable">@pass_settings_path</span>,  <br>  <span class="hljs-symbol">current_uri_path:</span>  <span class="hljs-variable">@current_uri_path</span> %&gt;<br></code></pre></td></tr></table></figure>

<p>打开<code>lib/instagram_clone_web/live/user_live/pass_settings.ex</code>添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.UserLive.PassSettings</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_view</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(_params, session, socket) <span class="hljs-keyword">do</span><br>    socket = assign_defaults(session, socket)<br>    settings_path = Routes.live_path(socket, InstagramCloneWeb.UserLive.Settings)<br>    pass_settings_path = Routes.live_path(socket, __MODULE__)<br><br>    &#123;<span class="hljs-symbol">:ok</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">settings_path:</span> settings_path, <span class="hljs-symbol">pass_settings_path:</span> pass_settings_path)&#125;<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>然后打开<code>lib/instagram_clone_web/live/user_live/pass_settings.html.leex</code>添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;section class=<span class="hljs-string">&quot;border-2 flex&quot;</span>&gt;<br>  &lt;%= live_component <span class="hljs-variable">@socket</span>, InstagramCloneWeb.UserLive.SettingsSidebarComponent,<br>    <span class="hljs-symbol">settings_path:</span> <span class="hljs-variable">@settings_path</span>,<br>    <span class="hljs-symbol">pass_settings_path:</span> <span class="hljs-variable">@pass_settings_path</span>,<br>    <span class="hljs-symbol">current_uri_path:</span> <span class="hljs-variable">@current_uri_path</span> %&gt;<br>&lt;<span class="hljs-regexp">/section&gt;</span><br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="https://s2.loli.net/2023/08/30/IXqUdL51HQPWxeu.jpg" alt="instagram-phoenix-p2-1.jpg" class="lazyload"></p>
<p>让我们将表单添加到<code>lib/instagram_clone_web/live/user_live/pass_settings.html.leex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;section class=<span class="hljs-string">&quot;border-2 flex&quot;</span>&gt;<br>  &lt;%= live_component <span class="hljs-variable">@socket</span>, InstagramCloneWeb.UserLive.SettingsSidebarComponent,<br>    <span class="hljs-symbol">settings_path:</span> <span class="hljs-variable">@settings_path</span>,<br>    <span class="hljs-symbol">pass_settings_path:</span> <span class="hljs-variable">@pass_settings_path</span>,<br>    <span class="hljs-symbol">current_uri_path:</span> <span class="hljs-variable">@current_uri_path</span> %&gt;<br><br>  &lt;div class=<span class="hljs-string">&quot;w-full py-5&quot;</span>&gt;<br>    &lt;!-- Profile Photo --&gt;<br>    &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>      &lt;div class=<span class="hljs-string">&quot;w-1/3&quot;</span>&gt;<br>        &lt;%= img_tag Avatar.get_thumb(<span class="hljs-variable">@current_user</span>.avatar_url), <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;ml-auto w-10 h-10 rounded-full object-cover object-center&quot;</span> %&gt;<br>      &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">      &lt;div class=&quot;w-full pl-8&quot;&gt;</span><br><span class="hljs-regexp">        &lt;h1 class=&quot;font-semibold text-xl truncate text-gray-600&quot;&gt;&lt;%= @current_user.username %&gt;&lt;/h</span>1&gt;<br>      &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">    &lt;/div</span>&gt;<br>    &lt;!-- End Profile Photo --&gt;<br>    &lt;%= f = form_for <span class="hljs-variable">@changeset</span>, <span class="hljs-string">&quot;#&quot;</span>,<br>      <span class="hljs-symbol">phx_submit:</span> <span class="hljs-string">&quot;save&quot;</span>,<br>      <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;space-y-5 md:space-y-8&quot;</span>  %&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;md:flex items-center&quot;</span>&gt;<br>        &lt;%= label f, <span class="hljs-symbol">:old_password</span>, <span class="hljs-string">&quot;Old Password&quot;</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-1/3 text-right font-semibold&quot;</span>, <span class="hljs-symbol">for:</span> <span class="hljs-string">&quot;current_password_for_password&quot;</span> %&gt;<br>        &lt;div class=<span class="hljs-string">&quot;w-full pl-8 pr-20&quot;</span>&gt;<br>          &lt;%= password_input f, <span class="hljs-symbol">:current_password</span>, <span class="hljs-symbol">required:</span> <span class="hljs-keyword">true</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-4/6 rounded p-1 text-semibold text-gray-600 border-gray-300 focus:ring-transparent focus:border-black&quot;</span> %&gt;<br>          &lt;%= error_tag f, <span class="hljs-symbol">:current_password</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;text-red-700 text-sm block&quot;</span> %&gt;<br>        &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">      &lt;/div</span>&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>        &lt;%= label f, <span class="hljs-symbol">:password</span>, <span class="hljs-string">&quot;New Password&quot;</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-1/3 text-right font-semibold&quot;</span> %&gt;<br>        &lt;div class=<span class="hljs-string">&quot;w-full pl-8 pr-20&quot;</span>&gt;<br>          &lt;%= password_input f, <span class="hljs-symbol">:password</span>, <span class="hljs-symbol">required:</span> <span class="hljs-keyword">true</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-4/6 rounded p-1 text-semibold text-gray-600 border-gray-300 focus:ring-transparent focus:border-black&quot;</span> %&gt;<br>          &lt;%= error_tag f, <span class="hljs-symbol">:password</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;text-red-700 text-sm block&quot;</span> %&gt;<br>        &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">      &lt;/div</span>&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;md:flex items-center&quot;</span>&gt;<br>        &lt;%= label f, <span class="hljs-symbol">:password_confirmation</span>, <span class="hljs-string">&quot;Confirm New Password&quot;</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-1/3 text-right font-semibold&quot;</span> %&gt;<br>        &lt;div class=<span class="hljs-string">&quot;w-full pl-8 pr-20&quot;</span>&gt;<br>          &lt;%= password_input f, <span class="hljs-symbol">:password_confirmation</span>, <span class="hljs-symbol">required:</span> <span class="hljs-keyword">true</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-4/6 rounded p-1 text-semibold text-gray-600 border-gray-300 focus:ring-transparent focus:border-black&quot;</span> %&gt;<br>          &lt;%= error_tag f, <span class="hljs-symbol">:password_confirmation</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;text-red-700 text-sm block&quot;</span> %&gt;<br>        &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">      &lt;/div</span>&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>        &lt;label class=<span class="hljs-string">&quot;w-1/3&quot;</span>&gt;&lt;<span class="hljs-regexp">/label&gt;</span><br><span class="hljs-regexp">        &lt;div class=&quot;w-full pl-8 pr-20&quot;&gt;</span><br><span class="hljs-regexp">          &lt;%= submit &quot;Change Password&quot;, phx_disable_with: &quot;Saving...&quot;, class: &quot;py-1 px-2 border-none shadow rounded font-semibold text-sm text-gray-50 hover:bg-light-blue-600 bg-light-blue-500 cursor-pointer&quot; %&gt;</span><br><span class="hljs-regexp">        &lt;/div</span>&gt;<br>      &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp"></span><br><span class="hljs-regexp">      &lt;div class=&quot;flex items-center&quot;&gt;</span><br><span class="hljs-regexp">        &lt;label class=&quot;w-1/</span><span class="hljs-number">3</span><span class="hljs-string">&quot;&gt;&lt;/label&gt;</span><br><span class="hljs-string">        &lt;div class=&quot;</span>w-full pl<span class="hljs-number">-8</span> pr<span class="hljs-number">-20</span> text-right<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">          &lt;%= link &quot;</span>Forgot Password?<span class="hljs-string">&quot;, to: Routes.user_reset_password_path(@socket, :new), class: &quot;</span>font-semibold text-xs <span class="hljs-symbol">hover:</span>text-light-blue<span class="hljs-number">-600</span> text-light-blue<span class="hljs-number">-500</span> cursor-pointer <span class="hljs-symbol">hover:</span>underline<span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">        &lt;/div&gt;</span><br><span class="hljs-string">      &lt;/div&gt;</span><br><span class="hljs-string">    &lt;/form&gt;</span><br><span class="hljs-string">  &lt;/div&gt;</span><br><span class="hljs-string">&lt;/section&gt;</span><br></code></pre></td></tr></table></figure>

<p>最后更新<code>lib/instagram_clone_web/live/user_live/pass_settings.ex</code>如下：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.UserLive.PassSettings</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_view</span><br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Accounts<br>  <span class="hljs-keyword">alias</span> InstagramClone.Accounts.User<br>  <span class="hljs-keyword">alias</span> InstagramClone.Uploaders.Avatar<br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(_params, session, socket) <span class="hljs-keyword">do</span><br>    socket = assign_defaults(session, socket)<br>    settings_path = Routes.live_path(socket, InstagramCloneWeb.UserLive.Settings)<br>    pass_settings_path = Routes.live_path(socket, __MODULE__)<br>    user = socket.assigns.current_user<br><br>    &#123;<span class="hljs-symbol">:ok</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">settings_path:</span> settings_path, <span class="hljs-symbol">pass_settings_path:</span> pass_settings_path)<br>      |&gt; assign(<span class="hljs-symbol">:page_title</span>, <span class="hljs-string">&quot;Change Password&quot;</span>)<br>      |&gt; assign(<span class="hljs-symbol">changeset:</span> Accounts.change_user_password(user))&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;save&quot;</span>, %&#123;<span class="hljs-string">&quot;user&quot;</span> =&gt; params&#125;, socket) <span class="hljs-keyword">do</span><br>    %&#123;<span class="hljs-string">&quot;current_password&quot;</span> =&gt; password&#125; = params<br>    <span class="hljs-keyword">case</span> Accounts.update_user_password(socket.assigns.current_user, password, params) <span class="hljs-keyword">do</span><br>      &#123;<span class="hljs-symbol">:ok</span>, _user&#125; -&gt;<br>        &#123;<span class="hljs-symbol">:noreply</span>,<br>          socket<br>          |&gt; put_flash(<span class="hljs-symbol">:info</span>, <span class="hljs-string">&quot;Password updated successfully.&quot;</span>)<br>          |&gt; push_redirect(<span class="hljs-symbol">to:</span> socket.assigns.pass_settings_path)&#125;<br><br>      &#123;<span class="hljs-symbol">:error</span>, changeset&#125; -&gt;<br>        &#123;<span class="hljs-symbol">:noreply</span>, assign(socket, <span class="hljs-symbol">:changeset</span>, changeset)&#125;<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>转到<code>lib/instagram_clone/accounts.ex</code>第 208 行，并更新<code>update_user_password()</code>为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-function"><span class="hljs-keyword">def</span>  <span class="hljs-title">update_user_password</span></span>(user, password, attrs) <span class="hljs-keyword">do</span><br>  user<br>  |&gt; User.password_changeset(attrs)<br>  |&gt; User.validate_current_password(password)<br>  |&gt; Repo.update()<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>在下一部分中，我们将处理用户的个人资料。</p>
<p>转自：<a target="_blank" rel="noopener" href="https://elixirprogrammer.com/learn/lets-build-an-instagram-clone-with-the-petal-phoenix-elixir-tailwindcss-alpinejs-liveview-stack-part-2/">Elixirprogrammer</a></p>

  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>本文作者：</strong>MarkHoo<br>
        <strong>本文链接：</strong><a href="https://blog.markhoo.com/posts/instagram-phoenix-liveview-p2/" title="https:&#x2F;&#x2F;blog.markhoo.com&#x2F;posts&#x2F;instagram-phoenix-liveview-p2&#x2F;" target="_blank" rel="noopener">https:&#x2F;&#x2F;blog.markhoo.com&#x2F;posts&#x2F;instagram-phoenix-liveview-p2&#x2F;</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 进行许可
        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
    
        <a class="nexmoefont icon-appstore-fill -link" href="/categories/Elixir/">Elixir</a>
    
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/AlpineJS/" rel="tag">AlpineJS</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Elixir/" rel="tag">Elixir</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/LiveView/" rel="tag">LiveView</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Phoenix/" rel="tag">Phoenix</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/TailwindCSS/" rel="tag">TailwindCSS</a>
    
</div>

  
      <div class="nexmoe-post-footer">
          <section class="nexmoe-comment">
    <div class="valine"></div>
<script src='https://cdn.jsdelivr.net/npm/valine'></script>
<script>
    // 使用方法 https://valine.js.org/quickstart.html
    new Valine({
        el: '.valine',
        appId: 'LnljA9jtf29oZKiQMJ6OAWJU-gzGzoHsz',
        appKey: 'wb1Mrzef0b2x540dSrcCcg5y'
    })
</script>
</section>
      </div>
  
</div>
            <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                        
                          
                          
                              <button class="mdui-fab catalog" style="overflow:unset;">
                                  <i class="nexmoefont icon-i-catalog"></i>
                                  <div class="nexmoe-toc">
                                      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%B4%E5%83%8F%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.</span> <span class="toc-text">头像上传</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E6%9B%B4%E6%94%B9%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">密码更改设置</span></a></li></ol>
                                  </div>
                              </button>
                          
                          
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
        </div>
    </div>
     
    <div id="nexmoe-search-space">
        <div class="search-container">
            <div class="search-header">
                <div class="search-input-container">
                    <input class="search-input" type="text" placeholder="搜索" oninput="sinput();">
                </div>
                <a class="search-close" onclick="sclose();">×</a>
            </div>
            <div class="search-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/combine/npm/lazysizes@5.1.0/lazysizes.min.js,npm/mdui@0.4.3/dist/js/mdui.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

 

<script async src="/js/app.js?v=1693393777294"></script>


	<script async src="/js/search.js?v=1693393777294"></script>


<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>


    





</body>

</html>
