<!DOCTYPE html>

<html lang="zh-CN">

<head>
    
    <title>使用 Phoenix LiveView 构建 Instagram (8) - 和光同尘|MarkHoo_不积跬步无以至千里，不积小流无以成江海</title>
    <meta charset="UTF-8">
    <meta name="description" content="终日而思,不如须臾之所学也">
    <meta name="keywords" content="和光同尘,MarkHoo,Python,Elixir,Phoenix,SpringBoot,Django,">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    

    <link rel="shortcut icon" href="https://media.markhoo.com/image/favicon24.ico" type="image/x-icon" />
    <meta name="description" content="使用PETAL(Phoenix、Elixir、TailwindCSS、AlpineJS、LiveView)技术栈构建一个简化版的Instagram Web应用程序">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 Phoenix LiveView 构建 Instagram (8)">
<meta property="og:url" content="https://blog.markhoo.com/posts/instagram-phoenix-liveview-p8/">
<meta property="og:site_name" content="和光同尘|MarkHoo_不积跬步无以至千里，不积小流无以成江海">
<meta property="og:description" content="使用PETAL(Phoenix、Elixir、TailwindCSS、AlpineJS、LiveView)技术栈构建一个简化版的Instagram Web应用程序">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/08/30/HsUZd98oIOCv1BF.gif">
<meta property="og:image" content="https://s2.loli.net/2023/08/30/C4e5IgxpowSkv2i.gif">
<meta property="article:published_time" content="2023-09-05T14:43:40.000Z">
<meta property="article:modified_time" content="2023-08-30T10:53:18.101Z">
<meta property="article:author" content="MarkHoo">
<meta property="article:tag" content="Elixir">
<meta property="article:tag" content="Phoenix">
<meta property="article:tag" content="LiveView">
<meta property="article:tag" content="TailwindCSS">
<meta property="article:tag" content="AlpineJS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/08/30/HsUZd98oIOCv1BF.gif">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/npm/highlight.js@9.15.8/styles/atom-one-dark.css,npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css,gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css,npm/hexo-theme-nexmoe@latest/source/lib/mdui_043tiny/css/mdui.css,npm/hexo-theme-nexmoe@latest/source/lib/iconfont/iconfont.css?v=233" crossorigin>
    <link rel="stylesheet" href="/css/style.css?v=1693394617966">
     
    
    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1693394617967">
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="mdui-drawer-body-left">
    
    <div id="nexmoe-background">
        <div class="nexmoe-bg" style="background-image: url(https://s2.loli.net/2023/08/30/SfpNaZsg3IW5MDz.jpg)"></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="MarkHoo" class="mdui-btn mdui-btn-icon"><img src="https://media.markhoo.com/avatar.jpg" alt="MarkHoo"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="MarkHoo">
            <img src="https://media.markhoo.com/avatar.jpg" alt="MarkHoo" alt="MarkHoo">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>53</div>
        <div><span>标签</span>40</div>
        <div><span>分类</span>11</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archives" title="归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/books" title="书架">
            <i class="mdui-list-item-icon nexmoefont icon-battlenet"></i>
            <div class="mdui-list-item-content">
                书架
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about" title="关于">
            <i class="mdui-list-item-icon nexmoefont icon-coffee"></i>
            <div class="mdui-list-item-content">
                关于
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/links" title="邻居">
            <i class="mdui-list-item-icon nexmoefont icon-dribbble"></i>
            <div class="mdui-list-item-content">
                邻居
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=site:markhoo.com" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
            </form>
         
    </div>
</div>
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://jq.qq.com/" target="_blank" mdui-tooltip="{content: 'QQ群'}" style="color: rgb(249, 174, 8);background-color: rgba(249, 174, 8, .1);">
            <i class="nexmoefont icon-QQ"></i>
        </a><a class="mdui-ripple" href="https://space.bilibili.com/182687081" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/markhoo/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
    
    
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/API/" style="font-size: 10px;">API</a> <a href="/tags/AlpineJS/" style="font-size: 16.25px;">AlpineJS</a> <a href="/tags/ArchLinux/" style="font-size: 10px;">ArchLinux</a> <a href="/tags/C-C/" style="font-size: 10px;">C/C++</a> <a href="/tags/CentOS7/" style="font-size: 15px;">CentOS7</a> <a href="/tags/Django/" style="font-size: 18.75px;">Django</a> <a href="/tags/Elixir/" style="font-size: 18.75px;">Elixir</a> <a href="/tags/EndeavourOS/" style="font-size: 10px;">EndeavourOS</a> <a href="/tags/Erlang/" style="font-size: 10px;">Erlang</a> <a href="/tags/Gin/" style="font-size: 10px;">Gin</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/Gitlab/" style="font-size: 10px;">Gitlab</a> <a href="/tags/Go/" style="font-size: 16.25px;">Go</a> <a href="/tags/Gunicorn/" style="font-size: 12.5px;">Gunicorn</a> <a href="/tags/Hugo/" style="font-size: 10px;">Hugo</a> <a href="/tags/IDE/" style="font-size: 11.25px;">IDE</a> <a href="/tags/JWT/" style="font-size: 10px;">JWT</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Linux/" style="font-size: 13.75px;">Linux</a> <a href="/tags/LiveView/" style="font-size: 16.25px;">LiveView</a> <a href="/tags/Lua/" style="font-size: 11.25px;">Lua</a> <a href="/tags/Manim/" style="font-size: 10px;">Manim</a> <a href="/tags/NeoVim/" style="font-size: 11.25px;">NeoVim</a> <a href="/tags/Nginx/" style="font-size: 13.75px;">Nginx</a> <a href="/tags/Phoenix/" style="font-size: 17.5px;">Phoenix</a> <a href="/tags/PyCharm/" style="font-size: 10px;">PyCharm</a> <a href="/tags/Python/" style="font-size: 20px;">Python</a> <a href="/tags/Rest/" style="font-size: 10px;">Rest</a> <a href="/tags/TailwindCSS/" style="font-size: 16.25px;">TailwindCSS</a> <a href="/tags/Unix/" style="font-size: 10px;">Unix</a> <a href="/tags/Vim/" style="font-size: 12.5px;">Vim</a> <a href="/tags/hexo/" style="font-size: 11.25px;">hexo</a> <a href="/tags/pip/" style="font-size: 11.25px;">pip</a> <a href="/tags/pypi/" style="font-size: 10px;">pypi</a> <a href="/tags/xadmin/" style="font-size: 10px;">xadmin</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E7%BD%91%E6%98%93%E4%BA%91%E9%9F%B3%E4%B9%90/" style="font-size: 10px;">网易云音乐</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 11.25px;">面试题</a> <a href="/tags/%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8/" style="font-size: 10px;">音乐播放器</a>
    </div>
    
  </div>

    
</aside>
    <div class="nexmoe-copyright">
        &copy; 2023 MarkHoo
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        <br><a target="_blank" href="https://beian.miit.gov.cn">苏ICP备17044309号</a><br><a target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"><img src="https://i.dawnlab.me/c0268c1e6cfd0863d6ba35be1575941a.png" width="150px"></a><script data-ad-client="ca-pub-2058306854838448" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
            <div class="nexmoe-post">

  <article>
      
          <div class="nexmoe-post-cover" style="padding-bottom: 45.83333333333333%;"> 
              <img data-src="https://s2.loli.net/2023/08/30/SfpNaZsg3IW5MDz.jpg" data-sizes="auto" alt="使用 Phoenix LiveView 构建 Instagram (8)" class="lazyload">
              <h1>使用 Phoenix LiveView 构建 Instagram (8)</h1>
          </div>
      
      
      <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2023年09月05日</a>
    <a><i class="nexmoefont icon-areachart"></i>4.4k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 25 分钟</a>
</div>

      

      <blockquote>
<p>使用PETAL(Phoenix、Elixir、TailwindCSS、AlpineJS、LiveView)技术栈构建一个简化版的Instagram Web应用程序</p>
</blockquote>
<span id="more"></span>

<p>在第 7 部分中，我们在顶部标题导航菜单中添加了搜索功能，在这部分中，我们将研究书签功能，并在以下内容向我们的主页添加新帖子时通知用户。您可以赶上Instagram 克隆 GitHub Repo。</p>
<p>当我们尝试创建未选择图像的新帖子时，让我们处理错误，为此，我们需要在内部的保存句柄函数中正确进行模式匹配<code>lib/instagram_clone_web/live/post_live/new.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;save&quot;</span>, %&#123;<span class="hljs-string">&quot;post&quot;</span> =&gt; post_params&#125;, socket) <span class="hljs-keyword">do</span><br>    post = PostUploader.put_image_url(socket, %Post&#123;&#125;)<br><br>    <span class="hljs-keyword">case</span> Posts.create_post(post, post_params, socket.assigns.current_user) <span class="hljs-keyword">do</span><br>      &#123;<span class="hljs-symbol">:ok</span>, %&#123;<span class="hljs-symbol">post:</span> post&#125;&#125; -&gt; <span class="hljs-comment"># &lt;- THIS LINE WAS UPDATED</span><br>        PostUploader.save(socket)<br><br>        &#123;<span class="hljs-symbol">:noreply</span>,<br>         socket<br>         |&gt; put_flash(<span class="hljs-symbol">:info</span>, <span class="hljs-string">&quot;Post created successfully&quot;</span>)<br>         |&gt; push_redirect(<span class="hljs-symbol">to:</span> Routes.user_profile_path(socket, <span class="hljs-symbol">:index</span>, socket.assigns.current_user.username))&#125;<br>         |&gt; push_redirect(<span class="hljs-symbol">to:</span> Routes.live_path(socket, InstagramCloneWeb.PostLive.Show, post.url_id))&#125;<br><br>      &#123;<span class="hljs-symbol">:error</span>, <span class="hljs-symbol">:post</span>, %Ecto.Changeset&#123;&#125; = changeset, %&#123;&#125;&#125; -&gt; <span class="hljs-comment"># &lt;- THIS LINE WAS UPDATED</span><br>        &#123;<span class="hljs-symbol">:noreply</span>, assign(socket, <span class="hljs-symbol">changeset:</span> changeset)&#125;<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>因为我们用来<code>Ecto.Multi</code>更新用户的帖子计数并创建帖子，所以在结果中我们必须进行相应的模式匹配。</p>
<p>现在，在<code>lib/instagram_clone_web/live/post_live/new.html.leex</code>第 23 行中添加一个 div 来显示错误:<code>photo_url</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;div class=<span class="hljs-string">&quot;flex justify-center&quot;</span>&gt;<br>    &lt;%= error_tag f, <span class="hljs-symbol">:photo_url</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;text-red-700 block&quot;</span> %&gt;<br>  &lt;<span class="hljs-regexp">/div&gt;</span><br></code></pre></td></tr></table></figure>

<p>每次创建新帖子时，我们都会使用 phoenix pubsub 向主页实时视图发送消息，这样我们就可以显示一个 div，单击该 div 将重新加载实时视图。里面<code>lib/instagram_clone/posts.ex</code>添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">@pubsub_topic</span> <span class="hljs-string">&quot;new_posts_added&quot;</span><br><br> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pubsub_topic</span></span>, <span class="hljs-symbol">do:</span> <span class="hljs-variable">@pubsub_topic</span><br><br> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">subscribe</span></span> <span class="hljs-keyword">do</span><br>   InstagramCloneWeb.Endpoint.subscribe(<span class="hljs-variable">@pubsub_topic</span>)<br> <span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>在里面<code>lib/instagram_clone_web/live/post_live/new.ex</code>让我们发送消息：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;save&quot;</span>, %&#123;<span class="hljs-string">&quot;post&quot;</span> =&gt; post_params&#125;, socket) <span class="hljs-keyword">do</span><br>   post = PostUploader.put_image_url(socket, %Post&#123;&#125;)<br><br>   <span class="hljs-keyword">case</span> Posts.create_post(post, post_params, socket.assigns.current_user) <span class="hljs-keyword">do</span><br>     &#123;<span class="hljs-symbol">:ok</span>, %&#123;<span class="hljs-symbol">post:</span> post&#125;&#125; -&gt; <span class="hljs-comment"># &lt;- THIS LINE WAS UPDATED</span><br>       PostUploader.save(socket)<br>	<br>	send_msg(post)<br>	<br>       &#123;<span class="hljs-symbol">:noreply</span>,<br>        socket<br>        |&gt; put_flash(<span class="hljs-symbol">:info</span>, <span class="hljs-string">&quot;Post created successfully&quot;</span>)<br>        |&gt; push_redirect(<span class="hljs-symbol">to:</span> Routes.user_profile_path(socket, <span class="hljs-symbol">:index</span>, socket.assigns.current_user.username))&#125;<br>        |&gt; push_redirect(<span class="hljs-symbol">to:</span> Routes.live_path(socket, InstagramCloneWeb.PostLive.Show, post.url_id))&#125;<br><br>     &#123;<span class="hljs-symbol">:error</span>, <span class="hljs-symbol">:post</span>, %Ecto.Changeset&#123;&#125; = changeset, %&#123;&#125;&#125; -&gt; <span class="hljs-comment"># &lt;- THIS LINE WAS UPDATED</span><br>       &#123;<span class="hljs-symbol">:noreply</span>, assign(socket, <span class="hljs-symbol">changeset:</span> changeset)&#125;<br>   <span class="hljs-keyword">end</span><br> <span class="hljs-keyword">end</span><br><br> <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">send_msg</span></span>(post) <span class="hljs-keyword">do</span><br>   <span class="hljs-comment"># Broadcast that new post was added</span><br>   InstagramCloneWeb.Endpoint.broadcast_from(<br>     <span class="hljs-keyword">self</span>(),<br>     Posts.pubsub_topic,<br>     <span class="hljs-string">&quot;new_post&quot;</span>,<br>     %&#123;<br>       <span class="hljs-symbol">post:</span> post<br>     &#125;<br>   )<br> <span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>在里面<code>lib/instagram_clone_web/live/page_live.ex</code>让我们处理将要发送的消息：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-keyword">alias</span>  InstagramClone.Posts.Post<br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(_params, session, socket) <span class="hljs-keyword">do</span><br>    socket = assign_defaults(session, socket)<br>    if connected?(socket), <span class="hljs-symbol">do:</span> Posts.subscribe<br><br>    &#123;<span class="hljs-symbol">:ok</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">page_title:</span> <span class="hljs-string">&quot;InstagraClone&quot;</span>)<br>      |&gt; assign(<span class="hljs-symbol">new_posts_added:</span> <span class="hljs-keyword">false</span>)<br>      |&gt; assign(<span class="hljs-symbol">page:</span> <span class="hljs-number">1</span>, <span class="hljs-symbol">per_page:</span> <span class="hljs-number">15</span>),<br>      <span class="hljs-symbol">temporary_assigns:</span> [<span class="hljs-symbol">user_feed:</span> []]&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_info</span></span>(%&#123;<span class="hljs-symbol">event:</span> <span class="hljs-string">&quot;new_post&quot;</span>, <span class="hljs-symbol">payload:</span> %&#123;<span class="hljs-symbol">post:</span> %Post&#123;<span class="hljs-symbol">user_id:</span> post_user_id&#125;&#125;&#125;, socket) <span class="hljs-keyword">do</span><br>    if post_user_id <span class="hljs-keyword">in</span> socket.assigns.following_list <span class="hljs-keyword">do</span><br>      &#123;<span class="hljs-symbol">:noreply</span>, socket |&gt; assign(<span class="hljs-symbol">new_posts_added:</span> <span class="hljs-keyword">true</span>)&#125;<br>    else<br>      &#123;<span class="hljs-symbol">:noreply</span>, socket&#125;<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>在我们的 mount 函数中，我们订阅 pubsub 主题并分配页面标题，并<code>new_posts_added</code>确定是否必须在模板中显示 div。在我们的例子中<code>handle_info</code>，我们接收用户的消息和模式匹配以获取用户 ID，然后检查该用户 ID 是否在分配给套接字的当前用户的以下列表中，如果是，则设为<code>new_posts_addedtrue</code>在我们下面的列表中。</p>
<p>在第 2 行中<code>lib/instagram_clone_web/live/page_live.html.leex</code>添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= if <span class="hljs-variable">@new_posts_added</span> <span class="hljs-keyword">do</span> %&gt;<br>   &lt;div class=<span class="hljs-string">&quot;flex justify-center w-3/5 sticky top-14&quot;</span>&gt;<br>     &lt;%= live_redirect <span class="hljs-symbol">to:</span> Routes.page_path(<span class="hljs-variable">@socket</span>, <span class="hljs-symbol">:index</span>), <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;user-profile-follow-btn&quot;</span> <span class="hljs-keyword">do</span> %&gt;<br>       &lt;svg xmlns=<span class="hljs-string">&quot;http://www.w3.org/2000/svg&quot;</span> class=<span class="hljs-string">&quot;h-5 w-5 inline&quot;</span> fill=<span class="hljs-string">&quot;none&quot;</span> viewBox=<span class="hljs-string">&quot;0 0 24 24&quot;</span> stroke=<span class="hljs-string">&quot;currentColor&quot;</span>&gt;<br>         &lt;path stroke-linecap=<span class="hljs-string">&quot;round&quot;</span> stroke-linejoin=<span class="hljs-string">&quot;round&quot;</span> stroke-width=<span class="hljs-string">&quot;2&quot;</span> d=<span class="hljs-string">&quot;M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15&quot;</span> /&gt;<br>       &lt;<span class="hljs-regexp">/svg&gt;</span><br><span class="hljs-regexp">       Load New Posts</span><br><span class="hljs-regexp">     &lt;% end %&gt;</span><br><span class="hljs-regexp">   &lt;/div</span>&gt;<br> &lt;% <span class="hljs-keyword">end</span> %&gt;<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="https://s2.loli.net/2023/08/30/HsUZd98oIOCv1BF.gif" alt="instagram-phoenix-p8-1.gif" class="lazyload"></p>
<p>现在，当我们关注的用户在我们的主页上添加新帖子时，我们会收到通知。</p>
<h2 id="帖子书签"><a href="#帖子书签" class="headerlink" title="帖子书签"></a>帖子书签</h2><p>转到终端，让我们创建一个架构来处理帖子书签：</p>
<p><code>mix phx.gen.schema Posts.Bookmarks posts_bookmarks user_id:references:users post_id:references:posts</code></p>
<p>在生成的迁移中：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramClone.Repo.Migrations.CreatePostsBookmarks</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> Ecto.Migration<br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">change</span></span> <span class="hljs-keyword">do</span><br>    create table(<span class="hljs-symbol">:posts_bookmarks</span>) <span class="hljs-keyword">do</span><br>      add <span class="hljs-symbol">:user_id</span>, references(<span class="hljs-symbol">:users</span>, <span class="hljs-symbol">on_delete:</span> <span class="hljs-symbol">:delete_all</span>)<br>      add <span class="hljs-symbol">:post_id</span>, references(<span class="hljs-symbol">:posts</span>, <span class="hljs-symbol">on_delete:</span> <span class="hljs-symbol">:delete_all</span>)<br><br>      timestamps()<br>    <span class="hljs-keyword">end</span><br><br>    create index(<span class="hljs-symbol">:posts_bookmarks</span>, [<span class="hljs-symbol">:user_id</span>])<br>    create index(<span class="hljs-symbol">:posts_bookmarks</span>, [<span class="hljs-symbol">:post_id</span>])<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>里面<code>lib/instagram_clone/posts/bookmarks.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramClone.Posts.Bookmarks</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> Ecto.Schema<br><br>  schema <span class="hljs-string">&quot;posts_bookmarks&quot;</span> <span class="hljs-keyword">do</span><br>    belongs_to <span class="hljs-symbol">:user</span>, InstagramClone.Accounts.User<br>    belongs_to <span class="hljs-symbol">:post</span>, InstagramClone.Posts.Post<br><br>    timestamps()<br>  <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>里面<code>lib/instagram_clone/accounts/user.ex和lib/instagram_clone/posts/post.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">has_many <span class="hljs-symbol">:posts_bookmarks</span>, InstagramClone.Posts.Bookmarks<br></code></pre></td></tr></table></figure>

<p>更新<code>lib/instagram_clone/posts.ex</code>如下：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramClone.Posts</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-variable">@moduledoc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  The Posts context.</span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br><br>  <span class="hljs-keyword">import</span> Ecto.Query, <span class="hljs-symbol">warn:</span> <span class="hljs-keyword">false</span><br>  <span class="hljs-keyword">alias</span> InstagramClone.Repo<br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Posts.Post<br>  <span class="hljs-keyword">alias</span> InstagramClone.Accounts.User<br>  <span class="hljs-keyword">alias</span> InstagramClone.Comments.Comment<br>  <span class="hljs-keyword">alias</span> InstagramClone.Likes.Like<br>  <span class="hljs-keyword">alias</span> InstagramClone.Posts.Bookmarks<br><br>  <span class="hljs-variable">@pubsub_topic</span> <span class="hljs-string">&quot;new_posts_added&quot;</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pubsub_topic</span></span>, <span class="hljs-symbol">do:</span> <span class="hljs-variable">@pubsub_topic</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">subscribe</span></span> <span class="hljs-keyword">do</span><br>    InstagramCloneWeb.Endpoint.subscribe(<span class="hljs-variable">@pubsub_topic</span>)<br>  <span class="hljs-keyword">end</span><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Returns the list of posts.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; list_posts()</span><br><span class="hljs-string">      [%Post&#123;&#125;, ...]</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">list_posts</span></span> <span class="hljs-keyword">do</span><br>    Repo.all(Post)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Returns the list of paginated posts of a given user id.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; list_user_posts(page: 1, per_page: 10, user_id: 1)</span><br><span class="hljs-string">      [%&#123;photo_url: &quot;&quot;, url_id: &quot;&quot;&#125;, ...]</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">list_profile_posts</span></span>(<span class="hljs-symbol">page:</span> page, <span class="hljs-symbol">per_page:</span> per_page, <span class="hljs-symbol">user_id:</span> user_id) <span class="hljs-keyword">do</span><br>    Post<br>    |&gt; select([p], map(p, [<span class="hljs-symbol">:url_id</span>, <span class="hljs-symbol">:photo_url</span>]))<br>    |&gt; where(<span class="hljs-symbol">user_id:</span> ^user_id)<br>    |&gt; limit(^per_page)<br>    |&gt; offset(^((page - <span class="hljs-number">1</span>) * per_page))<br>    |&gt; order_by(<span class="hljs-symbol">desc:</span> <span class="hljs-symbol">:id</span>)<br>    |&gt; Repo.all<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">list_saved_profile_posts</span></span>(<span class="hljs-symbol">page:</span> page, <span class="hljs-symbol">per_page:</span> per_page, <span class="hljs-symbol">user_id:</span> user_id) <span class="hljs-keyword">do</span><br>    Bookmarks<br>    |&gt; where(<span class="hljs-symbol">user_id:</span> ^user_id)<br>    |&gt; join(<span class="hljs-symbol">:inner</span>, [b], p <span class="hljs-keyword">in</span> assoc(b, <span class="hljs-symbol">:post</span>))<br>    |&gt; select([b, p], %&#123;<span class="hljs-symbol">url_id:</span> p.url_id, <span class="hljs-symbol">photo_url:</span> p.photo_url&#125;)<br>    |&gt; limit(^per_page)<br>    |&gt; offset(^((page - <span class="hljs-number">1</span>) * per_page))<br>    |&gt; order_by(<span class="hljs-symbol">desc:</span> <span class="hljs-symbol">:id</span>)<br>    |&gt; Repo.all<br>  <span class="hljs-keyword">end</span><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Returns the list of paginated posts of a given user id</span><br><span class="hljs-string">  And posts of following list of given user id</span><br><span class="hljs-string">  With user and likes preloaded</span><br><span class="hljs-string">  With 2 most recent comments preloaded with user and likes</span><br><span class="hljs-string">  User, page, and per_page are given with the socket assigns</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; get_accounts_feed(following_list, assigns)</span><br><span class="hljs-string">      [%&#123;photo_url: &quot;&quot;, url_id: &quot;&quot;&#125;, ...]</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_accounts_feed</span></span>(following_list, assigns) <span class="hljs-keyword">do</span><br>    user = assigns.current_user<br>    page = assigns.page<br>    per_page = assigns.per_page<br>    query =<br>      from c <span class="hljs-keyword">in</span> Comment,<br>      <span class="hljs-symbol">select:</span> %&#123;<span class="hljs-symbol">id:</span> c.id, <span class="hljs-symbol">row_number:</span> over(row_number(), <span class="hljs-symbol">:posts_partition</span>)&#125;,<br>      <span class="hljs-symbol">windows:</span> [<span class="hljs-symbol">posts_partition:</span> [<span class="hljs-symbol">partition_by:</span> <span class="hljs-symbol">:post_id</span>, <span class="hljs-symbol">order_by:</span> [<span class="hljs-symbol">desc:</span> <span class="hljs-symbol">:id</span>]]]<br>    comments_query =<br>      from c <span class="hljs-keyword">in</span> Comment,<br>      <span class="hljs-symbol">join:</span> r <span class="hljs-keyword">in</span> subquery(query),<br>      <span class="hljs-symbol">on:</span> c.id == r.id <span class="hljs-keyword">and</span> r.row_number &lt;= <span class="hljs-number">2</span><br>    likes_query = Like |&gt; select([l], l.user_id)<br>    bookmarks_query = Bookmarks |&gt; select([b], b.user_id)<br><br>    Post<br>    |&gt; where([p], p.user_id <span class="hljs-keyword">in</span> ^following_list)<br>    |&gt; or_where([p], p.user_id == ^user.id)<br>    |&gt; limit(^per_page)<br>    |&gt; offset(^((page - <span class="hljs-number">1</span>) * per_page))<br>    |&gt; order_by(<span class="hljs-symbol">desc:</span> <span class="hljs-symbol">:id</span>)<br>    |&gt; preload([<span class="hljs-symbol">:user</span>, <span class="hljs-symbol">posts_bookmarks:</span> ^bookmarks_query, <span class="hljs-symbol">likes:</span> ^likes_query, <span class="hljs-symbol">comments:</span> ^&#123;comments_query, [<span class="hljs-symbol">:user</span>, <span class="hljs-symbol">likes:</span> likes_query]&#125;])<br>    |&gt; Repo.all()<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_accounts_feed_total</span></span>(following_list, assigns) <span class="hljs-keyword">do</span><br>    user = assigns.current_user<br><br>    Post<br>    |&gt; where([p], p.user_id <span class="hljs-keyword">in</span> ^following_list)<br>    |&gt; or_where([p], p.user_id == ^user.id)<br>    |&gt; select([p], count(p.id))<br>    |&gt; Repo.one()<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Gets a single post.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  Raises `Ecto.NoResultsError` if the Post does not exist.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; get_post!(123)</span><br><span class="hljs-string">      %Post&#123;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; get_post!(456)</span><br><span class="hljs-string">      ** (Ecto.NoResultsError)</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_post!</span></span>(id) <span class="hljs-keyword">do</span><br>    likes_query = Like |&gt; select([l], l.user_id)<br>    bookmarks_query = Bookmarks |&gt; select([b], b.user_id)<br><br>    Repo.get!(Post, id)<br>    |&gt; Repo.preload([<span class="hljs-symbol">:user</span>, <span class="hljs-symbol">posts_bookmarks:</span> bookmarks_query, <span class="hljs-symbol">likes:</span> likes_query])<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_post_feed!</span></span>(id) <span class="hljs-keyword">do</span><br>    query =<br>      from c <span class="hljs-keyword">in</span> Comment,<br>      <span class="hljs-symbol">select:</span> %&#123;<span class="hljs-symbol">id:</span> c.id, <span class="hljs-symbol">row_number:</span> over(row_number(), <span class="hljs-symbol">:posts_partition</span>)&#125;,<br>      <span class="hljs-symbol">windows:</span> [<span class="hljs-symbol">posts_partition:</span> [<span class="hljs-symbol">partition_by:</span> <span class="hljs-symbol">:post_id</span>, <span class="hljs-symbol">order_by:</span> [<span class="hljs-symbol">desc:</span> <span class="hljs-symbol">:id</span>]]]<br>    comments_query =<br>      from c <span class="hljs-keyword">in</span> Comment,<br>      <span class="hljs-symbol">join:</span> r <span class="hljs-keyword">in</span> subquery(query),<br>      <span class="hljs-symbol">on:</span> c.id == r.id <span class="hljs-keyword">and</span> r.row_number &lt;= <span class="hljs-number">2</span><br>    likes_query = Like |&gt; select([l], l.user_id)<br>    bookmarks_query = Bookmarks |&gt; select([b], b.user_id)<br><br>    Post<br>    |&gt; preload([<span class="hljs-symbol">:user</span>, <span class="hljs-symbol">posts_bookmarks:</span> ^bookmarks_query, <span class="hljs-symbol">likes:</span> ^likes_query, <span class="hljs-symbol">comments:</span> ^&#123;comments_query, [<span class="hljs-symbol">:user</span>, <span class="hljs-symbol">likes:</span> likes_query]&#125;])<br>    |&gt; Repo.get!(id)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_post_by_url!</span></span>(id) <span class="hljs-keyword">do</span><br>    likes_query = Like |&gt; select([l], l.user_id)<br>    bookmarks_query = Bookmarks |&gt; select([b], b.user_id)<br><br>    Repo.get_by!(Post, <span class="hljs-symbol">url_id:</span> id)<br>    |&gt; Repo.preload([<span class="hljs-symbol">:user</span>, <span class="hljs-symbol">posts_bookmarks:</span> bookmarks_query, <span class="hljs-symbol">likes:</span> likes_query])<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Creates a post.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; create_post(%&#123;field: value&#125;)</span><br><span class="hljs-string">      &#123;:ok, %Post&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; create_post(%&#123;field: bad_value&#125;)</span><br><span class="hljs-string">      &#123;:error, %Ecto.Changeset&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_post</span></span>(%Post&#123;&#125; = post, attrs \\ %&#123;&#125;, user) <span class="hljs-keyword">do</span><br>    post = Ecto.build_assoc(user, <span class="hljs-symbol">:posts</span>, put_url_id(post))<br>    changeset = Post.changeset(post, attrs)<br>    update_posts_count = from(u <span class="hljs-keyword">in</span> User, <span class="hljs-symbol">where:</span> u.id == ^user.id)<br><br>    Ecto.Multi.new()<br>    |&gt; Ecto.Multi.update_all(<span class="hljs-symbol">:update_posts_count</span>, update_posts_count, <span class="hljs-symbol">inc:</span> [<span class="hljs-symbol">posts_count:</span> <span class="hljs-number">1</span>])<br>    |&gt; Ecto.Multi.insert(<span class="hljs-symbol">:post</span>, changeset)<br>    |&gt; Repo.transaction()<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-comment"># Generates a base64-encoding 8 bytes</span><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">put_url_id</span></span>(post) <span class="hljs-keyword">do</span><br>    url_id = Base.encode64(<span class="hljs-symbol">:crypto</span>.strong_rand_bytes(<span class="hljs-number">8</span>), <span class="hljs-symbol">padding:</span> <span class="hljs-keyword">false</span>)<br><br>    %Post&#123;post | <span class="hljs-symbol">url_id:</span> url_id&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Updates a post.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; update_post(post, %&#123;field: new_value&#125;)</span><br><span class="hljs-string">      &#123;:ok, %Post&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; update_post(post, %&#123;field: bad_value&#125;)</span><br><span class="hljs-string">      &#123;:error, %Ecto.Changeset&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_post</span></span>(%Post&#123;&#125; = post, attrs) <span class="hljs-keyword">do</span><br>    post<br>    |&gt; Post.changeset(attrs)<br>    |&gt; Repo.update()<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Deletes a post.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; delete_post(post)</span><br><span class="hljs-string">      &#123;:ok, %Post&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; delete_post(post)</span><br><span class="hljs-string">      &#123;:error, %Ecto.Changeset&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete_post</span></span>(%Post&#123;&#125; = post) <span class="hljs-keyword">do</span><br>    Repo.delete(post)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Returns an `%Ecto.Changeset&#123;&#125;` for tracking post changes.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; change_post(post)</span><br><span class="hljs-string">      %Ecto.Changeset&#123;data: %Post&#123;&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">change_post</span></span>(%Post&#123;&#125; = post, attrs \\ %&#123;&#125;) <span class="hljs-keyword">do</span><br>    Post.changeset(post, attrs)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-comment"># Returns nil if not found</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bookmarked?</span></span>(user_id, post_id) <span class="hljs-keyword">do</span><br>    Repo.get_by(Bookmarks, [<span class="hljs-symbol">user_id:</span> user_id, <span class="hljs-symbol">post_id:</span> post_id])<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_bookmark</span></span>(user, post) <span class="hljs-keyword">do</span><br>    user = Ecto.build_assoc(user, <span class="hljs-symbol">:posts_bookmarks</span>)<br>    post = Ecto.build_assoc(post, <span class="hljs-symbol">:posts_bookmarks</span>, user)<br><br>    Repo.insert(post)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unbookmark</span></span>(bookmarked?) <span class="hljs-keyword">do</span><br>    Repo.delete(bookmarked?)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">count_user_saved</span></span>(user) <span class="hljs-keyword">do</span><br>    Bookmarks<br>    |&gt; where(<span class="hljs-symbol">user_id:</span> ^user.id)<br>    |&gt; select([b], count(b.id))<br>    |&gt; Repo.one<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>添加了以下功能：</p>
<ul>
<li><code>list_saved_profile_posts/3</code>获取所有已分页的已保存帖子。</li>
<li><code>bookmarked?/2</code>检查书签是否存在。</li>
<li><code>create_bookmark/2</code>创建书签。</li>
<li><code>unbookmark/1</code>删除书签。</li>
<li><code>count_user_saved/1</code>获取给定用户的已保存帖子总数。</li>
</ul>
<p>另外，对于所有获取帖子功能，我们正在预加载帖子书签列表，因此我们可以将该列表发送到书签组件以设置我们要用于该功能的按钮。</p>
<p>在里面<code>lib/instagram_clone_web/live/post_live/</code>创建一个名为的文件<code>bookmark_component.ex</code>并添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.PostLive.BookmarkComponent</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_component</span><br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Posts<br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span></span>(assigns, socket) <span class="hljs-keyword">do</span><br>    get_btn_status(socket, assigns)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">render</span></span>(assigns) <span class="hljs-keyword">do</span><br>    <span class="hljs-string">~L&quot;&quot;&quot;</span><br><span class="hljs-string">    &lt;button</span><br><span class="hljs-string">      phx-target=&quot;&lt;%= @myself %&gt;&quot;</span><br><span class="hljs-string">      phx-click=&quot;</span>toggle-status<span class="hljs-string">&quot;</span><br><span class="hljs-string">      class=&quot;</span>h<span class="hljs-number">-8</span> w<span class="hljs-number">-8</span> ml-auto <span class="hljs-symbol">focus:</span>outline-none<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">      &lt;%= @icon %&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;/button&gt;</span><br><span class="hljs-string">    &quot;</span><span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;toggle-status&quot;</span>, _params, socket) <span class="hljs-keyword">do</span><br>    current_user = socket.assigns.current_user<br>    post = socket.assigns.post<br>    bookmarked? = Posts.bookmarked?(current_user.id, post.id)<br><br>    if bookmarked? <span class="hljs-keyword">do</span><br>      unbookmark(socket, bookmarked?)<br>    else<br>      bookmark(socket, current_user, post)<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">unbookmark</span></span>(socket, bookmarked?) <span class="hljs-keyword">do</span><br>    Posts.unbookmark(bookmarked?)<br><br>    &#123;<span class="hljs-symbol">:noreply</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">icon:</span> bookmark_icon(socket.assigns))&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">bookmark</span></span>(socket, current_user, post) <span class="hljs-keyword">do</span><br>    Posts.create_bookmark(current_user, post)<br><br>    &#123;<span class="hljs-symbol">:noreply</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">icon:</span> bookmarked_icon(socket.assigns))&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_btn_status</span></span>(socket, assigns) <span class="hljs-keyword">do</span><br>    if assigns.current_user.id <span class="hljs-keyword">in</span> assigns.post.posts_bookmarks <span class="hljs-keyword">do</span><br>      get_socket_assigns(socket, assigns, bookmarked_icon(assigns))<br>    else<br>      get_socket_assigns(socket, assigns, bookmark_icon(assigns))<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_socket_assigns</span></span>(socket, assigns, icon) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:ok</span>,<br>      socket<br>      |&gt; assign(assigns)<br>      |&gt; assign(<span class="hljs-symbol">icon:</span> icon)&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">bookmark_icon</span></span>(assigns) <span class="hljs-keyword">do</span><br>    <span class="hljs-string">~L&quot;&quot;&quot;</span><br><span class="hljs-string">    &lt;svg xmlns=&quot;</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/www.w3.org/</span><span class="hljs-number">2000</span>/svg<span class="hljs-string">&quot; fill=&quot;</span>none<span class="hljs-string">&quot; viewBox=&quot;</span>0 0 <span class="hljs-number">24</span> <span class="hljs-number">24</span><span class="hljs-string">&quot; stroke=&quot;</span>currentColor<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      &lt;path stroke-linecap=&quot;</span>round<span class="hljs-string">&quot; stroke-linejoin=&quot;</span>round<span class="hljs-string">&quot; stroke-width=&quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot; d=&quot;</span>M5 <span class="hljs-number">5</span>a2 <span class="hljs-number">2</span> 0 012<span class="hljs-number">-2</span>h10a2 <span class="hljs-number">2</span> 0 012 <span class="hljs-number">2</span>v16l<span class="hljs-number">-7</span><span class="hljs-number">-3.5</span>L5 <span class="hljs-number">21</span>V5z<span class="hljs-string">&quot; /&gt;</span><br><span class="hljs-string">    &lt;/svg&gt;</span><br><span class="hljs-string">    &quot;</span><span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">bookmarked_icon</span></span>(assigns) <span class="hljs-keyword">do</span><br>    <span class="hljs-string">~L&quot;&quot;&quot;</span><br><span class="hljs-string">    &lt;svg xmlns=&quot;</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/www.w3.org/</span><span class="hljs-number">2000</span>/svg<span class="hljs-string">&quot; viewBox=&quot;</span>0 0 <span class="hljs-number">20</span> <span class="hljs-number">20</span><span class="hljs-string">&quot; fill=&quot;</span>currentColor<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      &lt;path d=&quot;</span>M5 <span class="hljs-number">4</span>a2 <span class="hljs-number">2</span> 0 012<span class="hljs-number">-2</span>h6a2 <span class="hljs-number">2</span> 0 012 <span class="hljs-number">2</span>v14l<span class="hljs-number">-5</span><span class="hljs-number">-2.5</span>L5 <span class="hljs-number">18</span>V4z<span class="hljs-string">&quot; /&gt;</span><br><span class="hljs-string">    &lt;/svg&gt;</span><br><span class="hljs-string">    &quot;</span><span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>在第 94行将<code>lib/instagram_clone_web/live/post_live/show.html.leex</code>带有书签图标的 div 更改为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= if <span class="hljs-variable">@current_user</span> <span class="hljs-keyword">do</span> %&gt;<br>  &lt;%= live_component <span class="hljs-variable">@socket</span>,<br>      InstagramCloneWeb.PostLive.BookmarkComponent,<br>      <span class="hljs-symbol">id:</span> <span class="hljs-variable">@post</span>.id,<br>      <span class="hljs-symbol">post:</span> <span class="hljs-variable">@post</span>,<br>      <span class="hljs-symbol">current_user:</span> <span class="hljs-variable">@current_user</span> %&gt;<br>&lt;% else %&gt;<br>  &lt;%= link <span class="hljs-symbol">to:</span> Routes.user_session_path(<span class="hljs-variable">@socket</span>, <span class="hljs-symbol">:new</span>), <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-8 h-8 ml-auto focus:outline-none&quot;</span> <span class="hljs-keyword">do</span> %&gt;<br>    &lt;svg xmlns=<span class="hljs-string">&quot;http://www.w3.org/2000/svg&quot;</span> fill=<span class="hljs-string">&quot;none&quot;</span> viewBox=<span class="hljs-string">&quot;0 0 24 24&quot;</span> stroke=<span class="hljs-string">&quot;currentColor&quot;</span>&gt;<br>      &lt;path stroke-linecap=<span class="hljs-string">&quot;round&quot;</span> stroke-linejoin=<span class="hljs-string">&quot;round&quot;</span> stroke-width=<span class="hljs-string">&quot;1&quot;</span> d=<span class="hljs-string">&quot;M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z&quot;</span> /&gt;<br>    &lt;<span class="hljs-regexp">/svg&gt;</span><br><span class="hljs-regexp">  &lt;% end %&gt;</span><br><span class="hljs-regexp">&lt;% end %&gt;</span><br></code></pre></td></tr></table></figure>

<p>在第 41 行内<code>lib/instagram_clone_web/live/page_post_feed_component.html.leex</code>，将包含书签图标的 div 更改为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= live_component <span class="hljs-variable">@socket</span>,<br>        InstagramCloneWeb.PostLive.BookmarkComponent,<br>        <span class="hljs-symbol">id:</span> <span class="hljs-variable">@post</span>.id,<br>        <span class="hljs-symbol">post:</span> <span class="hljs-variable">@post</span>,<br>        <span class="hljs-symbol">current_user:</span> <span class="hljs-variable">@current_user</span> %&gt;<br></code></pre></td></tr></table></figure>

<p>在第 72 行内部<code>lib/instagram_clone_web/router.ex</code>添加以下路由：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">live <span class="hljs-string">&quot;/:username/saved&quot;</span>, UserLive.Profile, <span class="hljs-symbol">:saved</span><br></code></pre></td></tr></table></figure>

<p>第 102 行内部<code>lib/instagram_clone_web/live/header_nav_component.html.leex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= live_redirect <span class="hljs-symbol">to:</span> Routes.user_profile_path(<span class="hljs-variable">@socket</span>, <span class="hljs-symbol">:saved</span>, <span class="hljs-variable">@current_user</span>.username) <span class="hljs-keyword">do</span> %&gt;<br>  &lt;li class=<span class="hljs-string">&quot;py-2 px-4 hover:bg-gray-50&quot;</span>&gt;Saved&lt;<span class="hljs-regexp">/li&gt;</span><br><span class="hljs-regexp">&lt;% end %&gt;</span><br></code></pre></td></tr></table></figure>

<p>更新<code>lib/instagram_clone_web/live/user_live/profile.ex</code>如下：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.UserLive.Profile</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_view</span><br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Accounts<br>  <span class="hljs-keyword">alias</span> InstagramCloneWeb.UserLive.FollowComponent<br>  <span class="hljs-keyword">alias</span> InstagramClone.Posts<br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(%&#123;<span class="hljs-string">&quot;username&quot;</span> =&gt; username&#125;, session, socket) <span class="hljs-keyword">do</span><br>    socket = assign_defaults(session, socket)<br>    user = Accounts.profile(username)<br><br>    &#123;<span class="hljs-symbol">:ok</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">page:</span> <span class="hljs-number">1</span>, <span class="hljs-symbol">per_page:</span> <span class="hljs-number">15</span>)<br>      |&gt; assign(<span class="hljs-symbol">user:</span> user)<br>      |&gt; assign(<span class="hljs-symbol">page_title:</span> <span class="hljs-string">&quot;<span class="hljs-subst">#&#123;user.full_name&#125;</span> (@<span class="hljs-subst">#&#123;user.username&#125;</span>)&quot;</span>),<br>      <span class="hljs-symbol">temporary_assigns:</span> [<span class="hljs-symbol">posts:</span> []]&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">assign_posts</span></span>(socket) <span class="hljs-keyword">do</span><br>    socket<br>    |&gt; assign(<span class="hljs-symbol">posts:</span><br>      Posts.list_profile_posts(<br>        <span class="hljs-symbol">page:</span> socket.assigns.page,<br>        <span class="hljs-symbol">per_page:</span> socket.assigns.per_page,<br>        <span class="hljs-symbol">user_id:</span> socket.assigns.user.id<br>      )<br>    )<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">assign_saved_posts</span></span>(socket) <span class="hljs-keyword">do</span><br>    socket<br>    |&gt; assign(<span class="hljs-symbol">posts:</span><br>      Posts.list_saved_profile_posts(<br>        <span class="hljs-symbol">page:</span> socket.assigns.page,<br>        <span class="hljs-symbol">per_page:</span> socket.assigns.per_page,<br>        <span class="hljs-symbol">user_id:</span> socket.assigns.user.id<br>      )<br>    )<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;load-more-profile-posts&quot;</span>, _, socket) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:noreply</span>, socket |&gt; load_posts&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">load_posts</span></span>(socket) <span class="hljs-keyword">do</span><br>    total_posts = get_total_posts_count(socket)<br>    page = socket.assigns.page<br>    per_page = socket.assigns.per_page<br>    total_pages = ceil(total_posts / per_page)<br><br>    if page == total_pages <span class="hljs-keyword">do</span><br>      socket<br>    else<br>      socket<br>      |&gt; update(<span class="hljs-symbol">:page</span>, &amp;(&amp;<span class="hljs-number">1</span> + <span class="hljs-number">1</span>))<br>      |&gt; get_posts()<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_total_posts_count</span></span>(socket) <span class="hljs-keyword">do</span><br>    if socket.assigns.saved_page? <span class="hljs-keyword">do</span><br>      Posts.count_user_saved(socket.assigns.user)<br>    else<br>      socket.assigns.user.posts_count<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_posts</span></span>(socket) <span class="hljs-keyword">do</span><br>    if socket.assigns.saved_page? <span class="hljs-keyword">do</span><br>      assign_saved_posts(socket)<br>    else<br>      assign_posts(socket)<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_params</span></span>(_params, _uri, socket) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:noreply</span>, apply_action(socket, socket.assigns.live_action)&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_info</span></span>(&#123;FollowComponent, <span class="hljs-symbol">:update_totals</span>, updated_user&#125;, socket) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:noreply</span>, apply_msg_action(socket, socket.assigns.live_action, updated_user)&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">apply_msg_action</span></span>(socket, <span class="hljs-symbol">:follow_component</span>, updated_user) <span class="hljs-keyword">do</span><br>    socket |&gt; assign(<span class="hljs-symbol">user:</span> updated_user)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">apply_msg_action</span></span>(socket, _, _updated_user) <span class="hljs-keyword">do</span><br>    socket<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">apply_action</span></span>(socket, <span class="hljs-symbol">:index</span>) <span class="hljs-keyword">do</span><br>    selected_link_styles = <span class="hljs-string">&quot;text-gray-600 border-t-2 border-black -mt-0.5&quot;</span><br>    live_action = get_live_action(socket.assigns.user, socket.assigns.current_user)<br><br>    socket<br>    |&gt; assign(<span class="hljs-symbol">selected_index:</span> selected_link_styles)<br>    |&gt; assign(<span class="hljs-symbol">selected_saved:</span> <span class="hljs-string">&quot;text-gray-400&quot;</span>)<br>    |&gt; assign(<span class="hljs-symbol">saved_page?:</span> <span class="hljs-keyword">false</span>)<br>    |&gt; assign(<span class="hljs-symbol">live_action:</span> live_action)<br>    |&gt; show_saved_profile_link?()<br>    |&gt; assign_posts()<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">apply_action</span></span>(socket, <span class="hljs-symbol">:saved</span>) <span class="hljs-keyword">do</span><br>    selected_link_styles = <span class="hljs-string">&quot;text-gray-600 border-t-2 border-black -mt-0.5&quot;</span><br><br>    socket<br>    |&gt; assign(<span class="hljs-symbol">selected_index:</span> <span class="hljs-string">&quot;text-gray-400&quot;</span>)<br>    |&gt; assign(<span class="hljs-symbol">selected_saved:</span> selected_link_styles)<br>    |&gt; assign(<span class="hljs-symbol">live_action:</span> <span class="hljs-symbol">:edit_profile</span>)<br>    |&gt; assign(<span class="hljs-symbol">saved_page?:</span> <span class="hljs-keyword">true</span>)<br>    |&gt; show_saved_profile_link?()<br>    |&gt; redirect_when_not_my_saved()<br>    |&gt; assign_saved_posts()<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">apply_action</span></span>(socket, <span class="hljs-symbol">:following</span>) <span class="hljs-keyword">do</span><br>    following = Accounts.list_following(socket.assigns.user)<br>    socket |&gt; assign(<span class="hljs-symbol">following:</span> following)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">apply_action</span></span>(socket, <span class="hljs-symbol">:followers</span>) <span class="hljs-keyword">do</span><br>    followers = Accounts.list_followers(socket.assigns.user)<br>    socket |&gt; assign(<span class="hljs-symbol">followers:</span> followers)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">redirect_when_not_my_saved</span></span>(socket) <span class="hljs-keyword">do</span><br>    username = socket.assigns.current_user.username<br><br>    if socket.assigns.my_saved? <span class="hljs-keyword">do</span><br>      socket<br>    else<br>      socket<br>      |&gt; push_redirect(<span class="hljs-symbol">to:</span> Routes.user_profile_path(socket, <span class="hljs-symbol">:index</span>, username))<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">show_saved_profile_link?</span></span>(socket) <span class="hljs-keyword">do</span><br>    user = socket.assigns.user<br>    current_user = socket.assigns.current_user<br><br>    if current_user &amp;&amp; current_user.id == user.id <span class="hljs-keyword">do</span><br>      socket |&gt; assign(<span class="hljs-symbol">my_saved?:</span> <span class="hljs-keyword">true</span>)<br>    else<br>      socket |&gt; assign(<span class="hljs-symbol">my_saved?:</span> <span class="hljs-keyword">false</span>)<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_live_action</span></span>(user, current_user) <span class="hljs-keyword">do</span><br>    <span class="hljs-keyword">cond</span> <span class="hljs-keyword">do</span><br>      current_user &amp;&amp; current_user.id == user.id -&gt; <span class="hljs-symbol">:edit_profile</span><br>      current_user -&gt; <span class="hljs-symbol">:follow_component</span><br>      <span class="hljs-keyword">true</span> -&gt; <span class="hljs-symbol">:login_btn</span><br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>添加了以下功能：</p>
<ul>
<li><code>assign_posts/1</code>获取并分配个人资料保存的帖子。</li>
<li><code>apply_action(socket, :saved)</code>在保存路线页面时分配保存的帖子，并<code>live_action</code>分配<code>:edit_profile</code>以显示编辑个人资料按钮。</li>
<li><code>redirect_when_not_my_saved/1</code>当尝试直接转到不属于当前用户的已保存配置文件时重定向。</li>
<li><code>show_saved_profile_link?/1</code>指定<code>my_saved?</code>当前用户是否拥有配置文件。</li>
<li><code>get_total_posts_count/1</code>以确定我们必须获得的帖子总数。</li>
<li><code>get_posts/1</code>以确定要获取哪些帖子。</li>
</ul>
<p>我们不再在挂载函数中分配帖子，而是在索引和保存的操作中完成。此外，在这些函数中，我们分配链接样式，并<code>saved_page?</code>确定当页脚中的钩子被触发时我们必须加载更多的帖子。</p>
<p>更新<code>lib/instagram_clone_web/live/user_live/profile.html.leex</code>如下：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= if <span class="hljs-variable">@live_action</span> == <span class="hljs-symbol">:following</span> <span class="hljs-keyword">do</span> %&gt;<br>  &lt;%= live_modal <span class="hljs-variable">@socket</span>, InstagramCloneWeb.UserLive.Profile.FollowingComponent,<br>    <span class="hljs-symbol">width:</span> <span class="hljs-string">&quot;w-1/4&quot;</span>,<br>    <span class="hljs-symbol">current_user:</span> <span class="hljs-variable">@current_user</span>,<br>    <span class="hljs-symbol">following:</span> <span class="hljs-variable">@following</span>,<br>    <span class="hljs-symbol">return_to:</span> Routes.user_profile_path(<span class="hljs-variable">@socket</span>, <span class="hljs-symbol">:index</span>, <span class="hljs-variable">@user</span>.username) %&gt;<br>&lt;% <span class="hljs-keyword">end</span> %&gt;<br><br>&lt;%= if <span class="hljs-variable">@live_action</span> == <span class="hljs-symbol">:followers</span> <span class="hljs-keyword">do</span> %&gt;<br>  &lt;%= live_modal <span class="hljs-variable">@socket</span>, InstagramCloneWeb.UserLive.Profile.FollowersComponent,<br>    <span class="hljs-symbol">width:</span> <span class="hljs-string">&quot;w-1/4&quot;</span>,<br>    <span class="hljs-symbol">current_user:</span> <span class="hljs-variable">@current_user</span>,<br>    <span class="hljs-symbol">followers:</span> <span class="hljs-variable">@followers</span>,<br>    <span class="hljs-symbol">return_to:</span> Routes.user_profile_path(<span class="hljs-variable">@socket</span>, <span class="hljs-symbol">:index</span>, <span class="hljs-variable">@user</span>.username) %&gt;<br>&lt;% <span class="hljs-keyword">end</span> %&gt;<br><br>&lt;header class=<span class="hljs-string">&quot;flex justify-center px-10&quot;</span>&gt;<br>  &lt;!-- Profile Picture Section --&gt;<br>  &lt;section class=<span class="hljs-string">&quot;w-1/4&quot;</span>&gt;<br>      &lt;%= img_tag <span class="hljs-variable">@user</span>.avatar_url,<br>          <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-40 h-40 rounded-full object-cover object-center&quot;</span> %&gt;<br>  &lt;<span class="hljs-regexp">/section&gt;</span><br><span class="hljs-regexp">  &lt;!-- END Profile Picture Section --&gt;</span><br><span class="hljs-regexp"></span><br><span class="hljs-regexp">  &lt;!-- Profile Details Section --&gt;</span><br><span class="hljs-regexp">  &lt;section class=&quot;w-3/</span><span class="hljs-number">4</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">    &lt;div class=&quot;</span>flex px<span class="hljs-number">-3</span> pt<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">        &lt;h1 class=&quot;</span>truncate <span class="hljs-symbol">md:</span>overflow-clip text<span class="hljs-number">-2</span>xl <span class="hljs-symbol">md:</span>text<span class="hljs-number">-2</span>xl text-gray<span class="hljs-number">-500</span> mb<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;&lt;%= @user.username %&gt;&lt;/h1&gt;</span><br><span class="hljs-string">        &lt;span class=&quot;</span>ml<span class="hljs-number">-11</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">          &lt;%= if @live_action == :edit_profile do %&gt;</span><br><span class="hljs-string">            &lt;%= live_patch &quot;</span>Edit Profile<span class="hljs-string">&quot;,</span><br><span class="hljs-string">                to: Routes.live_path(@socket, InstagramCloneWeb.UserLive.Settings),</span><br><span class="hljs-string">                class: &quot;</span>py<span class="hljs-number">-1</span> px<span class="hljs-number">-2</span> border<span class="hljs-number">-2</span> rounded font-semibold <span class="hljs-symbol">hover:</span>bg-gray<span class="hljs-number">-50</span><span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">          &lt;% end %&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">          &lt;%= if @live_action == :follow_component do %&gt;</span><br><span class="hljs-string">            &lt;%= live_component @socket,</span><br><span class="hljs-string">                InstagramCloneWeb.UserLive.FollowComponent,</span><br><span class="hljs-string">                id: @user.id,</span><br><span class="hljs-string">                user: @user,</span><br><span class="hljs-string">                current_user: @current_user %&gt;</span><br><span class="hljs-string">          &lt;% end %&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">          &lt;%= if @live_action == :login_btn do %&gt;</span><br><span class="hljs-string">            &lt;%= link &quot;</span>Follow<span class="hljs-string">&quot;, to: Routes.user_session_path(@socket, :new), class: &quot;</span>user-profile-follow-btn<span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">          &lt;% end %&gt;</span><br><span class="hljs-string">        &lt;/span&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;div&gt;</span><br><span class="hljs-string">      &lt;ul class=&quot;</span>flex p<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">          &lt;li&gt;&lt;b&gt;&lt;%= @user.posts_count %&gt;&lt;/b&gt; Posts&lt;/li&gt;</span><br><span class="hljs-string">          &lt;%= live_patch to: Routes.user_profile_path(@socket, :followers, @user.username) do %&gt;</span><br><span class="hljs-string">            &lt;li class=&quot;</span>ml<span class="hljs-number">-11</span><span class="hljs-string">&quot;&gt;&lt;b&gt;&lt;%= @user.followers_count %&gt;&lt;/b&gt; Followers&lt;/li&gt;</span><br><span class="hljs-string">          &lt;% end %&gt;</span><br><span class="hljs-string">          &lt;%= live_patch to: Routes.user_profile_path(@socket, :following, @user.username) do %&gt;</span><br><span class="hljs-string">            &lt;li class=&quot;</span>ml<span class="hljs-number">-11</span><span class="hljs-string">&quot;&gt;&lt;b&gt;&lt;%= @user.following_count %&gt;&lt;/b&gt; Following&lt;/li&gt;</span><br><span class="hljs-string">          &lt;% end %&gt;</span><br><span class="hljs-string">      &lt;/ul&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;div class=&quot;</span>p<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      &lt;h2 class=&quot;</span>text-md text-gray<span class="hljs-number">-600</span> font-bold<span class="hljs-string">&quot;&gt;&lt;%= @user.full_name %&gt;&lt;/h2&gt;</span><br><span class="hljs-string">      &lt;%= if @user.bio do %&gt;</span><br><span class="hljs-string">        &lt;p class=&quot;</span>max-w-full <span class="hljs-keyword">break</span>-words<span class="hljs-string">&quot;&gt;&lt;%= @user.bio %&gt;&lt;/p&gt;</span><br><span class="hljs-string">      &lt;% end %&gt;</span><br><span class="hljs-string">      &lt;%= if @user.website do %&gt;</span><br><span class="hljs-string">        &lt;%= link display_website_uri(@user.website),</span><br><span class="hljs-string">          to: @user.website,</span><br><span class="hljs-string">          target: &quot;</span>_blank<span class="hljs-string">&quot;, rel: &quot;</span>noreferrer<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          class: &quot;</span>text-blue<span class="hljs-number">-700</span><span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">      &lt;% end %&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string">  &lt;/section&gt;</span><br><span class="hljs-string">  &lt;!-- END Profile Details Section --&gt;</span><br><span class="hljs-string">&lt;/header&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;section class=&quot;</span>border-t<span class="hljs-number">-2</span> mt<span class="hljs-number">-5</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">  &lt;ul class=&quot;</span>flex justify-center text-center space-x<span class="hljs-number">-20</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">    &lt;%= live_redirect to: Routes.user_profile_path(@socket, :index, @user.username) do %&gt;</span><br><span class="hljs-string">      &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm &lt;%= <span class="hljs-variable">@selected_index</span> %&gt;<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">        POSTS</span><br><span class="hljs-string">      &lt;/li&gt;</span><br><span class="hljs-string">    &lt;% end %&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-400</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      IGTV</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">    &lt;%= if @my_saved? do %&gt;</span><br><span class="hljs-string">      &lt;%= live_redirect to: Routes.user_profile_path(@socket, :saved, @user.username) do %&gt;</span><br><span class="hljs-string">        &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm &lt;%= <span class="hljs-variable">@selected_saved</span> %&gt;<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">          SAVED</span><br><span class="hljs-string">        &lt;/li&gt;</span><br><span class="hljs-string">      &lt;% end %&gt;</span><br><span class="hljs-string">    &lt;% end %&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-400</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      TAGGED</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">  &lt;/ul&gt;</span><br><span class="hljs-string">&lt;/section&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;!-- Gallery Grid --&gt;</span><br><span class="hljs-string">&lt;div id=&quot;</span>posts<span class="hljs-string">&quot; phx-update=&quot;</span>append<span class="hljs-string">&quot; class=&quot;</span>mt<span class="hljs-number">-9</span> grid gap<span class="hljs-number">-8</span> grid-cols<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">  &lt;%= for post &lt;- @posts do %&gt;</span><br><span class="hljs-string">    &lt;%= live_redirect img_tag(post.photo_url, class: &quot;</span>object-cover h<span class="hljs-number">-80</span> w-full<span class="hljs-string">&quot;),</span><br><span class="hljs-string">      id: post.url_id,</span><br><span class="hljs-string">      to: Routes.live_path(@socket, InstagramCloneWeb.PostLive.Show, post.url_id) %&gt;</span><br><span class="hljs-string">  &lt;% end %&gt;</span><br><span class="hljs-string">&lt;/div&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;div</span><br><span class="hljs-string">  id=&quot;</span>profile-posts-footer<span class="hljs-string">&quot;</span><br><span class="hljs-string">  class=&quot;</span>flex justify-center<span class="hljs-string">&quot;</span><br><span class="hljs-string">  phx-hook=&quot;</span>ProfilePostsScroll<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &lt;svg class=&quot;</span>animate-spin mr<span class="hljs-number">-3</span> h<span class="hljs-number">-8</span> w<span class="hljs-number">-8</span> text-gray<span class="hljs-number">-300</span><span class="hljs-string">&quot; xmlns=&quot;</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/www.w3.org/</span><span class="hljs-number">2000</span>/svg<span class="hljs-string">&quot; fill=&quot;</span>none<span class="hljs-string">&quot; viewBox=&quot;</span>0 0 <span class="hljs-number">24</span> <span class="hljs-number">24</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">    &lt;circle class=&quot;</span>opacity<span class="hljs-number">-25</span><span class="hljs-string">&quot; cx=&quot;</span><span class="hljs-number">12</span><span class="hljs-string">&quot; cy=&quot;</span><span class="hljs-number">12</span><span class="hljs-string">&quot; r=&quot;</span><span class="hljs-number">10</span><span class="hljs-string">&quot; stroke=&quot;</span>currentColor<span class="hljs-string">&quot; stroke-width=&quot;</span><span class="hljs-number">4</span><span class="hljs-string">&quot;&gt;&lt;/circle&gt;</span><br><span class="hljs-string">    &lt;path class=&quot;</span>opacity<span class="hljs-number">-75</span><span class="hljs-string">&quot; fill=&quot;</span>currentColor<span class="hljs-string">&quot; d=&quot;</span>M4 <span class="hljs-number">12</span>a8 <span class="hljs-number">8</span> 0 018<span class="hljs-number">-8</span>V0C5.<span class="hljs-number">373</span> 0 0 <span class="hljs-number">5.373</span> 0 <span class="hljs-number">12</span>h4zm2 <span class="hljs-number">5.291</span>A7.<span class="hljs-number">962</span> <span class="hljs-number">7.962</span> 0 014 <span class="hljs-number">12</span>H0c0 <span class="hljs-number">3.042</span> <span class="hljs-number">1.135</span> <span class="hljs-number">5.824</span> <span class="hljs-number">3</span> <span class="hljs-number">7.938</span>l3<span class="hljs-number">-2.647</span>z<span class="hljs-string">&quot;&gt;&lt;/path&gt;</span><br><span class="hljs-string">  &lt;/svg&gt;</span><br><span class="hljs-string">  Loading...</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;/div&gt;</span><br></code></pre></td></tr></table></figure>

<p>添加了帖子和保存的链接，仅当当前用户拥有该配置文件时才会显示保存的链接，并且我们在加载更多页脚中添加了一个加载图标。</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="https://s2.loli.net/2023/08/30/C4e5IgxpowSkv2i.gif" alt="instagram-phoenix-p8-2.gif" class="lazyload"></p>
<p>转自：<a target="_blank" rel="noopener" href="https://elixirprogrammer.com/learn/lets-build-an-instagram-clone-with-the-petal-phoenix-elixir-tailwindcss-alpinejs-liveview-stack-part-8/">Elixirprogrammer</a></p>

  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>本文作者：</strong>MarkHoo<br>
        <strong>本文链接：</strong><a href="https://blog.markhoo.com/posts/instagram-phoenix-liveview-p8/" title="https:&#x2F;&#x2F;blog.markhoo.com&#x2F;posts&#x2F;instagram-phoenix-liveview-p8&#x2F;" target="_blank" rel="noopener">https:&#x2F;&#x2F;blog.markhoo.com&#x2F;posts&#x2F;instagram-phoenix-liveview-p8&#x2F;</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 进行许可
        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
    
        <a class="nexmoefont icon-appstore-fill -link" href="/categories/Elixir/">Elixir</a>
    
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/AlpineJS/" rel="tag">AlpineJS</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Elixir/" rel="tag">Elixir</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/LiveView/" rel="tag">LiveView</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Phoenix/" rel="tag">Phoenix</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/TailwindCSS/" rel="tag">TailwindCSS</a>
    
</div>

  
      <div class="nexmoe-post-footer">
          <section class="nexmoe-comment">
    <div class="valine"></div>
<script src='https://cdn.jsdelivr.net/npm/valine'></script>
<script>
    // 使用方法 https://valine.js.org/quickstart.html
    new Valine({
        el: '.valine',
        appId: 'LnljA9jtf29oZKiQMJ6OAWJU-gzGzoHsz',
        appKey: 'wb1Mrzef0b2x540dSrcCcg5y'
    })
</script>
</section>
      </div>
  
</div>
            <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                        
                          
                          
                              <button class="mdui-fab catalog" style="overflow:unset;">
                                  <i class="nexmoefont icon-i-catalog"></i>
                                  <div class="nexmoe-toc">
                                      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%96%E5%AD%90%E4%B9%A6%E7%AD%BE"><span class="toc-number">1.</span> <span class="toc-text">帖子书签</span></a></li></ol>
                                  </div>
                              </button>
                          
                          
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
        </div>
    </div>
     
    <div id="nexmoe-search-space">
        <div class="search-container">
            <div class="search-header">
                <div class="search-input-container">
                    <input class="search-input" type="text" placeholder="搜索" oninput="sinput();">
                </div>
                <a class="search-close" onclick="sclose();">×</a>
            </div>
            <div class="search-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/combine/npm/lazysizes@5.1.0/lazysizes.min.js,npm/mdui@0.4.3/dist/js/mdui.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

 

<script async src="/js/app.js?v=1693394618014"></script>



<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>


    





</body>

</html>
