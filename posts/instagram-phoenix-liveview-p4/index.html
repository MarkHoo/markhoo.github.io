<!DOCTYPE html>

<html lang="zh-CN">

<head>
    
    <title>使用 Phoenix LiveView 构建 Instagram (4) - 和光同尘|MarkHoo_不积跬步无以至千里，不积小流无以成江海</title>
    <meta charset="UTF-8">
    <meta name="description" content="终日而思,不如须臾之所学也">
    <meta name="keywords" content="和光同尘,MarkHoo,Python,Elixir,Phoenix,SpringBoot,Django,">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    

    <link rel="shortcut icon" href="https://media.markhoo.com/image/favicon24.ico" type="image/x-icon" />
    <meta name="description" content="使用PETAL(Phoenix、Elixir、TailwindCSS、AlpineJS、LiveView)技术栈构建一个简化版的Instagram Web应用程序">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 Phoenix LiveView 构建 Instagram (4)">
<meta property="og:url" content="https://blog.markhoo.com/posts/instagram-phoenix-liveview-p4/">
<meta property="og:site_name" content="和光同尘|MarkHoo_不积跬步无以至千里，不积小流无以成江海">
<meta property="og:description" content="使用PETAL(Phoenix、Elixir、TailwindCSS、AlpineJS、LiveView)技术栈构建一个简化版的Instagram Web应用程序">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/08/30/uPxNBhpRSHCronw.jpg">
<meta property="og:image" content="https://s2.loli.net/2023/08/30/xYvkAoH6gG1WyVp.jpg">
<meta property="article:published_time" content="2023-09-01T14:43:40.000Z">
<meta property="article:modified_time" content="2023-08-30T09:26:45.061Z">
<meta property="article:author" content="MarkHoo">
<meta property="article:tag" content="Elixir">
<meta property="article:tag" content="Phoenix">
<meta property="article:tag" content="LiveView">
<meta property="article:tag" content="TailwindCSS">
<meta property="article:tag" content="AlpineJS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/08/30/uPxNBhpRSHCronw.jpg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/npm/highlight.js@9.15.8/styles/atom-one-dark.css,npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css,gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css,npm/hexo-theme-nexmoe@latest/source/lib/mdui_043tiny/css/mdui.css,npm/hexo-theme-nexmoe@latest/source/lib/iconfont/iconfont.css?v=233" crossorigin>
    <link rel="stylesheet" href="/css/style.css?v=1693394714813">
     
    
    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1693394714813">
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="mdui-drawer-body-left">
    
    <div id="nexmoe-background">
        <div class="nexmoe-bg" style="background-image: url(https://s2.loli.net/2023/08/30/SfpNaZsg3IW5MDz.jpg)"></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="MarkHoo" class="mdui-btn mdui-btn-icon"><img src="https://media.markhoo.com/avatar.jpg" alt="MarkHoo"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="MarkHoo">
            <img src="https://media.markhoo.com/avatar.jpg" alt="MarkHoo" alt="MarkHoo">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>53</div>
        <div><span>标签</span>40</div>
        <div><span>分类</span>11</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archives" title="归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/books" title="书架">
            <i class="mdui-list-item-icon nexmoefont icon-battlenet"></i>
            <div class="mdui-list-item-content">
                书架
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about" title="关于">
            <i class="mdui-list-item-icon nexmoefont icon-coffee"></i>
            <div class="mdui-list-item-content">
                关于
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/links" title="邻居">
            <i class="mdui-list-item-icon nexmoefont icon-dribbble"></i>
            <div class="mdui-list-item-content">
                邻居
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=site:markhoo.com" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
            </form>
         
    </div>
</div>
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://jq.qq.com/" target="_blank" mdui-tooltip="{content: 'QQ群'}" style="color: rgb(249, 174, 8);background-color: rgba(249, 174, 8, .1);">
            <i class="nexmoefont icon-QQ"></i>
        </a><a class="mdui-ripple" href="https://space.bilibili.com/182687081" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/markhoo/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
    
    
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/API/" style="font-size: 10px;">API</a> <a href="/tags/AlpineJS/" style="font-size: 16.25px;">AlpineJS</a> <a href="/tags/ArchLinux/" style="font-size: 10px;">ArchLinux</a> <a href="/tags/C-C/" style="font-size: 10px;">C/C++</a> <a href="/tags/CentOS7/" style="font-size: 15px;">CentOS7</a> <a href="/tags/Django/" style="font-size: 18.75px;">Django</a> <a href="/tags/Elixir/" style="font-size: 18.75px;">Elixir</a> <a href="/tags/EndeavourOS/" style="font-size: 10px;">EndeavourOS</a> <a href="/tags/Erlang/" style="font-size: 10px;">Erlang</a> <a href="/tags/Gin/" style="font-size: 10px;">Gin</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/Gitlab/" style="font-size: 10px;">Gitlab</a> <a href="/tags/Go/" style="font-size: 16.25px;">Go</a> <a href="/tags/Gunicorn/" style="font-size: 12.5px;">Gunicorn</a> <a href="/tags/Hugo/" style="font-size: 10px;">Hugo</a> <a href="/tags/IDE/" style="font-size: 11.25px;">IDE</a> <a href="/tags/JWT/" style="font-size: 10px;">JWT</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Linux/" style="font-size: 13.75px;">Linux</a> <a href="/tags/LiveView/" style="font-size: 16.25px;">LiveView</a> <a href="/tags/Lua/" style="font-size: 11.25px;">Lua</a> <a href="/tags/Manim/" style="font-size: 10px;">Manim</a> <a href="/tags/NeoVim/" style="font-size: 11.25px;">NeoVim</a> <a href="/tags/Nginx/" style="font-size: 13.75px;">Nginx</a> <a href="/tags/Phoenix/" style="font-size: 17.5px;">Phoenix</a> <a href="/tags/PyCharm/" style="font-size: 10px;">PyCharm</a> <a href="/tags/Python/" style="font-size: 20px;">Python</a> <a href="/tags/Rest/" style="font-size: 10px;">Rest</a> <a href="/tags/TailwindCSS/" style="font-size: 16.25px;">TailwindCSS</a> <a href="/tags/Unix/" style="font-size: 10px;">Unix</a> <a href="/tags/Vim/" style="font-size: 12.5px;">Vim</a> <a href="/tags/hexo/" style="font-size: 11.25px;">hexo</a> <a href="/tags/pip/" style="font-size: 11.25px;">pip</a> <a href="/tags/pypi/" style="font-size: 10px;">pypi</a> <a href="/tags/xadmin/" style="font-size: 10px;">xadmin</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E7%BD%91%E6%98%93%E4%BA%91%E9%9F%B3%E4%B9%90/" style="font-size: 10px;">网易云音乐</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 11.25px;">面试题</a> <a href="/tags/%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8/" style="font-size: 10px;">音乐播放器</a>
    </div>
    
  </div>

    
</aside>
    <div class="nexmoe-copyright">
        &copy; 2023 MarkHoo
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        <br><a target="_blank" href="https://beian.miit.gov.cn">苏ICP备17044309号</a><br><a target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"><img src="https://i.dawnlab.me/c0268c1e6cfd0863d6ba35be1575941a.png" width="150px"></a><script data-ad-client="ca-pub-2058306854838448" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
            <div class="nexmoe-post">

  <article>
      
          <div class="nexmoe-post-cover" style="padding-bottom: 45.83333333333333%;"> 
              <img data-src="https://s2.loli.net/2023/08/30/SfpNaZsg3IW5MDz.jpg" data-sizes="auto" alt="使用 Phoenix LiveView 构建 Instagram (4)" class="lazyload">
              <h1>使用 Phoenix LiveView 构建 Instagram (4)</h1>
          </div>
      
      
      <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2023年09月01日</a>
    <a><i class="nexmoefont icon-areachart"></i>2.6k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 14 分钟</a>
</div>

      

      <blockquote>
<p>使用PETAL(Phoenix、Elixir、TailwindCSS、AlpineJS、LiveView)技术栈构建一个简化版的Instagram Web应用程序</p>
</blockquote>
<span id="more"></span>

<p>在第 3 部分中，我们添加了个人资料页面以及关注和显示帐户的功能，在这部分中，我们将处理用户的帖子。您可以赶上Instagram 克隆 GitHub Repo。</p>
<p>让我们首先添加一个路由来显示用于添加帖子的表单，打开<code>lib/instagram_clone_web/router.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs elixir">scope <span class="hljs-string">&quot;/&quot;</span>, InstagramCloneWeb <span class="hljs-keyword">do</span><br>  pipe_through <span class="hljs-symbol">:browser</span><br><br>  live <span class="hljs-string">&quot;/&quot;</span>, PageLive, <span class="hljs-symbol">:index</span><br>  live <span class="hljs-string">&quot;/:username&quot;</span>, UserLive.Profile, <span class="hljs-symbol">:index</span><br>  live <span class="hljs-string">&quot;/p/:id&quot;</span>, PostLive.Show <span class="hljs-comment"># &lt;-- THIS LINE WAS ADDED</span><br><span class="hljs-keyword">end</span><br><br><br>scope <span class="hljs-string">&quot;/&quot;</span>, InstagramCloneWeb <span class="hljs-keyword">do</span><br>  pipe_through [<span class="hljs-symbol">:browser</span>, <span class="hljs-symbol">:require_authenticated_user</span>]<br><br>  get <span class="hljs-string">&quot;/users/settings/confirm_email/:token&quot;</span>, UserSettingsController, <span class="hljs-symbol">:confirm_email</span><br>  live <span class="hljs-string">&quot;/accounts/edit&quot;</span>, UserLive.Settings<br>  live <span class="hljs-string">&quot;/accounts/password/change&quot;</span>, UserLive.PassSettings<br>  live <span class="hljs-string">&quot;/:username/following&quot;</span>, UserLive.Profile, <span class="hljs-symbol">:following</span><br>  live <span class="hljs-string">&quot;/:username/followers&quot;</span>, UserLive.Profile, <span class="hljs-symbol">:followers</span><br>  live <span class="hljs-string">&quot;/p/new&quot;</span>, PostLive.New <span class="hljs-comment"># &lt;-- THIS LINE WAS ADDED</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>在文件夹中创建我们的实时视图文件<code>lib/instagram_clone_web/live/post_live</code>：</p>
<p><code>lib/instagram_clone_web/live/post_live/new.ex</code> <code>lib/instagram_clone_web/live/post_live/new.html.leex</code> <code>lib/instagram_clone_web/live/post_live/show.ex</code> <code>lib/instagram_clone_web/live/post_live/show.html.leex</code></p>
<p>里面<code>lib/instagram_clone_web/live/post_live/new.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.PostLive.New</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_view</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(_params, session, socket) <span class="hljs-keyword">do</span><br>    socket = assign_defaults(session, socket)<br><br>    &#123;<span class="hljs-symbol">:ok</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">page_title:</span> <span class="hljs-string">&quot;New Post&quot;</span>)&#125;<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>打开<code>lib/instagram_clone_web/live/header_nav_component.html.leex</code>在第18行，使用我们的新route：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><br>&lt;%= live_redirect <span class="hljs-symbol">to:</span> Routes.live_path(<span class="hljs-variable">@socket</span>, InstagramCloneWeb.PostLive.New)  <span class="hljs-keyword">do</span>  %&gt;<br><br></code></pre></td></tr></table></figure>

<p>让我们创建一个帖子上下文，转到终端：</p>
<p><code>$ mix phx.gen.context Posts Post posts url_id:string description:text photo_url:string user_id:references:users total_likes:integer total_comments:integer</code></p>
<p>打开生成的迁移并添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramClone.Repo.Migrations.CreatePosts</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> Ecto.Migration<br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">change</span></span> <span class="hljs-keyword">do</span><br>    create table(<span class="hljs-symbol">:posts</span>) <span class="hljs-keyword">do</span><br>      add <span class="hljs-symbol">:url_id</span>, <span class="hljs-symbol">:string</span><br>      add <span class="hljs-symbol">:description</span>, <span class="hljs-symbol">:text</span><br>      add <span class="hljs-symbol">:photo_url</span>, <span class="hljs-symbol">:string</span><br>      add <span class="hljs-symbol">:total_likes</span>, <span class="hljs-symbol">:integer</span>, <span class="hljs-symbol">default:</span> 0<br>      add <span class="hljs-symbol">:total_comments</span>, <span class="hljs-symbol">:integer</span>, <span class="hljs-symbol">default:</span> 0<br>      add <span class="hljs-symbol">:user_id</span>, references(<span class="hljs-symbol">:users</span>, <span class="hljs-symbol">on_delete:</span> <span class="hljs-symbol">:nothing</span>)<br><br>      timestamps()<br>    <span class="hljs-keyword">end</span><br><br>    create index(<span class="hljs-symbol">:posts</span>, [<span class="hljs-symbol">:user_id</span>])<br>    create unique_index(<span class="hljs-symbol">:posts</span>, [<span class="hljs-symbol">:url_id</span>])<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>返回终端：<code>$ mix ecto.migrate</code></p>
<p>我们还可以在终端中将帖子计数添加到用户架构中：</p>
<p><code>$ mix ecto.gen.migration adds_posts_count_to_users</code></p>
<p>打开生成的迁移并添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramClone.Repo.Migrations.AddsPostsCountToUsers</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> Ecto.Migration<br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">change</span></span> <span class="hljs-keyword">do</span><br>    alter table(<span class="hljs-symbol">:users</span>) <span class="hljs-keyword">do</span><br>      add <span class="hljs-symbol">:posts_count</span>, <span class="hljs-symbol">:integer</span>, <span class="hljs-symbol">default:</span> 0<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>返回终端：<code>$ mix ecto.migrate</code></p>
<p>打开<code>lib/instagram_clone/accounts/user.ex</code>并将架构编辑为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><br><span class="hljs-variable">@derive</span> &#123;Inspect,  <span class="hljs-symbol">except:</span>  [<span class="hljs-symbol">:password</span>]&#125;<br>schema <span class="hljs-string">&quot;users&quot;</span>  <span class="hljs-keyword">do</span><br>  field <span class="hljs-symbol">:email</span>,  <span class="hljs-symbol">:string</span><br>  field <span class="hljs-symbol">:password</span>,  <span class="hljs-symbol">:string</span>,  <span class="hljs-symbol">virtual:</span>  <span class="hljs-keyword">true</span><br>  field <span class="hljs-symbol">:hashed_password</span>,  <span class="hljs-symbol">:string</span><br>  field <span class="hljs-symbol">:confirmed_at</span>,  <span class="hljs-symbol">:naive_datetime</span><br>  field <span class="hljs-symbol">:username</span>,  <span class="hljs-symbol">:string</span><br>  field <span class="hljs-symbol">:full_name</span>,  <span class="hljs-symbol">:strin</span><br>  field <span class="hljs-symbol">:avatar_url</span>,  <span class="hljs-symbol">:string</span>,  <span class="hljs-symbol">default:</span>  <span class="hljs-string">&quot;/images/default-avatar.png&quot;</span><br>  field <span class="hljs-symbol">:bio</span>,  <span class="hljs-symbol">:string</span><br>  field <span class="hljs-symbol">:website</span>,  <span class="hljs-symbol">:string</span><br>  field <span class="hljs-symbol">:followers_count</span>, <span class="hljs-symbol">:integer</span>, <span class="hljs-symbol">default:</span> 0<br>  field <span class="hljs-symbol">:following_count</span>, <span class="hljs-symbol">:integer</span>, <span class="hljs-symbol">default:</span> 0<br>  field <span class="hljs-symbol">:posts_count</span>,  <span class="hljs-symbol">:integer</span>,  <span class="hljs-symbol">default:</span>  0 <span class="hljs-comment"># &lt;-- THIS LINE WAS ADDED</span><br>  has_many <span class="hljs-symbol">:following</span>, Follows,  <span class="hljs-symbol">foreign_key:</span>  <span class="hljs-symbol">:follower_id</span><br>  has_many <span class="hljs-symbol">:followers</span>, Follows,  <span class="hljs-symbol">foreign_key:</span>  <span class="hljs-symbol">:followed_id</span><br>  has_many <span class="hljs-symbol">:posts</span>, InstagramClone.Posts.Post <span class="hljs-comment"># &lt;-- THIS LINE WAS ADDED</span><br>  timestamps()<br><span class="hljs-keyword">end</span><br><br></code></pre></td></tr></table></figure>

<p>打开<code>lib/instagram_clone/posts/post.ex</code>添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramClone.Posts.Post</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> Ecto.Schema<br>  <span class="hljs-keyword">import</span> Ecto.Changeset<br><br>  schema <span class="hljs-string">&quot;posts&quot;</span> <span class="hljs-keyword">do</span><br>    field <span class="hljs-symbol">:description</span>, <span class="hljs-symbol">:string</span><br>    field <span class="hljs-symbol">:photo_url</span>, <span class="hljs-symbol">:string</span><br>    field <span class="hljs-symbol">:url_id</span>, <span class="hljs-symbol">:string</span><br>    field <span class="hljs-symbol">:total_likes</span>, <span class="hljs-symbol">:integer</span>, <span class="hljs-symbol">default:</span> 0<br>    field <span class="hljs-symbol">:total_comments</span>, <span class="hljs-symbol">:integer</span>, <span class="hljs-symbol">default:</span> 0<br>    belongs_to <span class="hljs-symbol">:user</span>, InstagramClone.Accounts.User<br><br>    timestamps()<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-keyword">false</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">changeset</span></span>(post, attrs) <span class="hljs-keyword">do</span><br>    post<br>    |&gt; cast(attrs, [<span class="hljs-symbol">:url_id</span>, <span class="hljs-symbol">:description</span>, <span class="hljs-symbol">:photo_url</span>])<br>    |&gt; validate_required([<span class="hljs-symbol">:url_id</span>, <span class="hljs-symbol">:photo_url</span>])<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>让我们添加新的架构，并允许在其中上传<code>lib/instagram_clone_web/live/post_live/new.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.PostLive.New</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_view</span><br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Posts.Post<br>  <span class="hljs-keyword">alias</span> InstagramClone.Posts<br><br>  <span class="hljs-variable">@extension_whitelist</span> <span class="hljs-string">~w(.jpg .jpeg .png)</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(_params, session, socket) <span class="hljs-keyword">do</span><br>    socket = assign_defaults(session, socket)<br><br>    &#123;<span class="hljs-symbol">:ok</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">page_title:</span> <span class="hljs-string">&quot;New Post&quot;</span>)<br>      |&gt; assign(<span class="hljs-symbol">changeset:</span> Posts.change_post(%Post&#123;&#125;))<br>      |&gt; allow_upload(<span class="hljs-symbol">:photo_url</span>,<br>      <span class="hljs-symbol">accept:</span> <span class="hljs-variable">@extension_whitelist</span>,<br>      <span class="hljs-symbol">max_file_size:</span> <span class="hljs-number">30_000_000</span>)&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;validate&quot;</span>, %&#123;<span class="hljs-string">&quot;post&quot;</span> =&gt; post_params&#125;, socket) <span class="hljs-keyword">do</span><br>    changeset =<br>      Posts.change_post(%Post&#123;&#125;, post_params)<br>      |&gt; Map.put(<span class="hljs-symbol">:action</span>, <span class="hljs-symbol">:validate</span>)<br><br>    &#123;<span class="hljs-symbol">:noreply</span>, socket |&gt; assign(<span class="hljs-symbol">changeset:</span> changeset)&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;cancel-entry&quot;</span>, %&#123;<span class="hljs-string">&quot;ref&quot;</span> =&gt; ref&#125;, socket) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:noreply</span>, cancel_upload(socket, <span class="hljs-symbol">:photo_url</span>, ref)&#125;<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>打开<code>config/dev.exs</code>第 61 行编辑：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-string">~r&quot;priv/static/[^uploads].*(js|css|png|jpeg|jpg|gif|svg)$&quot;</span>,<br></code></pre></td></tr></table></figure>

<p>该配置可以避免每次上传文件时重新加载上传文件夹的实时重新加载，否则，您在尝试上传时会遇到奇怪的行为。</p>
<p>在里面添加以下内容<code>lib/instagram_clone_web/live/post_live/new.html.leex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;div class=<span class="hljs-string">&quot;flex flex-col w-1/2 mx-auto&quot;</span>&gt;<br>  &lt;h2 class=<span class="hljs-string">&quot;text-xl font-bold text-gray-600&quot;</span>&gt;&lt;%= <span class="hljs-variable">@page_title</span> %&gt;&lt;<span class="hljs-regexp">/h2&gt;</span><br><span class="hljs-regexp"></span><br><span class="hljs-regexp">  &lt;%= f = form_for @changeset, &quot;#&quot;,</span><br><span class="hljs-regexp">    class: &quot;mt-8&quot;,</span><br><span class="hljs-regexp">    phx_change: &quot;validate&quot;,</span><br><span class="hljs-regexp">    phx_submit: &quot;save&quot; %&gt;</span><br><span class="hljs-regexp"></span><br><span class="hljs-regexp">    &lt;%= for &#123;_ref, err&#125; &lt;- @uploads.photo_url.errors do %&gt;</span><br><span class="hljs-regexp">        &lt;p class=&quot;alert alert-danger&quot;&gt;&lt;%= Phoenix.Naming.humanize(err) %&gt;&lt;/p</span>&gt;<br>    &lt;% <span class="hljs-keyword">end</span> %&gt;<br><br>    &lt;div class=<span class="hljs-string">&quot;border border-dashed border-gray-500 relative&quot;</span> phx-drop-target=<span class="hljs-string">&quot;&lt;%= @uploads.photo_url.ref %&gt;&quot;</span>&gt;<br>      &lt;%= live_file_input <span class="hljs-variable">@uploads</span>.photo_url, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;cursor-pointer relative block opacity-0 w-full h-full p-20 z-30&quot;</span> %&gt;<br>      &lt;div class=<span class="hljs-string">&quot;text-center p-10 absolute top-0 right-0 left-0 m-auto&quot;</span>&gt;<br>          &lt;h4&gt;<br>              Drop files anywhere to upload<br>              &lt;br/&gt;<span class="hljs-keyword">or</span><br>          &lt;<span class="hljs-regexp">/h4&gt;</span><br><span class="hljs-regexp">          &lt;p class=&quot;&quot;&gt;Select Files&lt;/p</span>&gt;<br>      &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">    &lt;/div</span>&gt;<br>    <br>    &lt;%= <span class="hljs-keyword">for</span> entry &lt;- <span class="hljs-variable">@uploads</span>.photo_url.entries <span class="hljs-keyword">do</span> %&gt;<br>      &lt;div class=<span class="hljs-string">&quot;my-8 flex items-center&quot;</span>&gt;<br>        &lt;div&gt;<br>          &lt;%= live_img_preview entry, <span class="hljs-symbol">height:</span> <span class="hljs-number">250</span>, <span class="hljs-symbol">width:</span> <span class="hljs-number">250</span> %&gt;<br>        &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">        &lt;div class=&quot;px-4&quot;&gt;</span><br><span class="hljs-regexp">          &lt;progress max=&quot;100&quot; value=&quot;&lt;%= entry.progress %&gt;&quot; /</span>&gt;<br>        &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">        &lt;span&gt;&lt;%= entry.progress %&gt;%&lt;/span</span>&gt;<br>        &lt;div class=<span class="hljs-string">&quot;px-4&quot;</span>&gt;<br>          &lt;a href=<span class="hljs-string">&quot;#&quot;</span> class=<span class="hljs-string">&quot;text-red-600 text-lg font-semibold&quot;</span> phx-click=<span class="hljs-string">&quot;cancel-entry&quot;</span> phx-value-ref=<span class="hljs-string">&quot;&lt;%= entry.ref %&gt;&quot;</span>&gt;cancel&lt;<span class="hljs-regexp">/a&gt;</span><br><span class="hljs-regexp">        &lt;/div</span>&gt;<br>      &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">    &lt;% end %&gt;</span><br><span class="hljs-regexp"></span><br><span class="hljs-regexp">    &lt;div class=&quot;mt-6&quot;&gt;</span><br><span class="hljs-regexp">      &lt;%= label f, :description, class: &quot;font-semibold&quot; %&gt;</span><br><span class="hljs-regexp">    &lt;/div</span>&gt;<br>    &lt;div class=<span class="hljs-string">&quot;mt-3&quot;</span>&gt;<br>      &lt;%= textarea f, <span class="hljs-symbol">:description</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-full border-2 border-gray-400 rounded p-1 text-semibold text-gray-500 focus:ring-transparent focus:border-gray-600&quot;</span>, <span class="hljs-symbol">rows:</span> <span class="hljs-number">5</span> %&gt;<br>      &lt;%= error_tag f, <span class="hljs-symbol">:description</span>, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;text-red-700 text-sm block&quot;</span> %&gt;<br>    &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp"></span><br><span class="hljs-regexp">    &lt;div class=&quot;mt-6&quot;&gt;</span><br><span class="hljs-regexp">      &lt;%= submit &quot;Submit&quot;,</span><br><span class="hljs-regexp">        phx_disable_with: &quot;Saving...&quot;,</span><br><span class="hljs-regexp">        class: &quot;py-2 px-6 border-none shadow rounded font-semibold text-sm text-gray-50 hover:bg-light-blue-600 bg-light-blue-500 cursor-pointer&quot; %&gt;</span><br><span class="hljs-regexp">    &lt;/div</span>&gt;<br><br>  &lt;<span class="hljs-regexp">/form&gt;</span><br><span class="hljs-regexp">&lt;/div</span>&gt;<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="https://s2.loli.net/2023/08/30/uPxNBhpRSHCronw.jpg" alt="instagram-phoenix-p4-1.jpg" class="lazyload"></p>
<p><code>lib/instagram_clone_web/live/uploaders</code>在创建一个名为的文件下，<code>post.ex</code>在该文件中添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramClone.Uploaders.Post</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">alias</span> InstagramCloneWeb.Router.Helpers, <span class="hljs-symbol">as:</span> Routes<br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Posts.Post<br><br>  <span class="hljs-variable">@upload_directory_name</span> <span class="hljs-string">&quot;uploads&quot;</span><br>  <span class="hljs-variable">@upload_directory_path</span> <span class="hljs-string">&quot;priv/static/uploads&quot;</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">ext</span></span>(entry) <span class="hljs-keyword">do</span><br>    [ext | _] = MIME.extensions(entry.client_type)<br>    ext<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">put_image_url</span></span>(socket, %Post&#123;&#125; = post) <span class="hljs-keyword">do</span><br>    &#123;completed, []&#125; = Phoenix.LiveView.uploaded_entries(socket, <span class="hljs-symbol">:photo_url</span>)<br>    urls =<br>      <span class="hljs-keyword">for</span> entry &lt;- completed <span class="hljs-keyword">do</span><br>        Routes.static_path(socket, <span class="hljs-string">&quot;/<span class="hljs-subst">#&#123;<span class="hljs-variable">@upload_directory_name</span>&#125;</span>/<span class="hljs-subst">#&#123;entry.uuid&#125;</span>.<span class="hljs-subst">#&#123;ext(entry)&#125;</span>&quot;</span>)<br>      <span class="hljs-keyword">end</span><br><br>    %Post&#123;post | <span class="hljs-symbol">photo_url:</span> List.to_string(urls)&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save</span></span>(socket) <span class="hljs-keyword">do</span><br>	if !File.exists?(<span class="hljs-variable">@upload_directory_path</span>), <span class="hljs-symbol">do:</span> File.mkdir!(<span class="hljs-variable">@upload_directory_path</span>)<br>	<br>    Phoenix.LiveView.consume_uploaded_entries(socket, <span class="hljs-symbol">:photo_url</span>, <span class="hljs-keyword">fn</span> meta, entry -&gt;<br>      dest = Path.join(<span class="hljs-variable">@upload_directory_path</span>, <span class="hljs-string">&quot;<span class="hljs-subst">#&#123;entry.uuid&#125;</span>.<span class="hljs-subst">#&#123;ext(entry)&#125;</span>&quot;</span>)<br>      File.cp!(meta.path, dest)<br>    <span class="hljs-keyword">end</span>)<br><br>    <span class="hljs-symbol">:ok</span><br>  <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>打开<code>lib/instagram_clone/posts.ex</code>编辑<code>create_post()</code>并添加一个私有函数来放置 url id：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs elixir">...<br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_post</span></span>(%Post&#123;&#125; = post, attrs \\ %&#123;&#125;, user) <span class="hljs-keyword">do</span><br>    post = Ecto.build_assoc(user, <span class="hljs-symbol">:posts</span>, put_url_id(post))<br>    changeset = Post.changeset(post, attrs)<br>    update_posts_count = from(u <span class="hljs-keyword">in</span> User, <span class="hljs-symbol">where:</span> u.id == ^user.id)<br><br>    Ecto.Multi.new()<br>    |&gt; Ecto.Multi.update_all(<span class="hljs-symbol">:update_posts_count</span>, update_posts_count, <span class="hljs-symbol">inc:</span> [<span class="hljs-symbol">posts_count:</span>  <span class="hljs-number">1</span>])<br>    |&gt; Ecto.Multi.insert(<span class="hljs-symbol">:post</span>, changeset)<br>    |&gt; Repo.transaction()<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-comment"># Generates a base64-encoding 8 bytes</span><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">put_url_id</span></span>(post) <span class="hljs-keyword">do</span><br>    url_id = Base.encode64(<span class="hljs-symbol">:crypto</span>.strong_rand_bytes(<span class="hljs-number">8</span>), <span class="hljs-symbol">padding:</span> <span class="hljs-keyword">false</span>)<br><br>    %Post&#123;post | <span class="hljs-symbol">url_id:</span> url_id&#125;<br>  <span class="hljs-keyword">end</span><br><br>...<br></code></pre></td></tr></table></figure>

<p>添加<code>lib/instagram_clone_web/live/post_live/new.ex</code>以下事件处理函数：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-keyword">alias</span> InstagramClone.Uploaders.Post, <span class="hljs-symbol">as:</span> PostUploader<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;save&quot;</span>, %&#123;<span class="hljs-string">&quot;post&quot;</span> =&gt; post_params&#125;, socket) <span class="hljs-keyword">do</span><br>  post = PostUploader.put_image_url(socket, %Post&#123;&#125;)<br>  <span class="hljs-keyword">case</span> Posts.create_post(post, post_params, socket.assigns.current_user) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:ok</span>, post&#125; -&gt;<br>      PostUploader.save(socket, post)<br>      <br>      &#123;<span class="hljs-symbol">:noreply</span>,<br>       socket<br>       |&gt; put_flash(<span class="hljs-symbol">:info</span>, <span class="hljs-string">&quot;Post created successfully&quot;</span>)<br>       |&gt; push_redirect(<span class="hljs-symbol">to:</span> Routes.user_profile_path(socket, <span class="hljs-symbol">:index</span>, socket.assigns.current_user.username))&#125;<br><br>    &#123;<span class="hljs-symbol">:error</span>, %Ecto.Changeset&#123;&#125; = changeset&#125; -&gt;<br>      &#123;<span class="hljs-symbol">:noreply</span>, assign(socket, <span class="hljs-symbol">changeset:</span> changeset)&#125;<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>在第 52 行打开，<code>lib/instagram_clone_web/live/user_live/profile.html.leex</code>让我们显示我们的帖子数：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;li&gt;&lt;b&gt;&lt;%= <span class="hljs-variable">@user</span>.posts_count %&gt;&lt;<span class="hljs-regexp">/b&gt; Posts&lt;/li</span>&gt;<br></code></pre></td></tr></table></figure>

<p>现在让我们创建一个函数来获取个人资料帖子并使用无限滚动对结果进行分页，打开<code>lib/instagram_clone/posts.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><br>...<br><br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Returns the list of paginated posts of a given user id.</span><br><span class="hljs-string"></span><br><span class="hljs-string">  ## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">      iex&gt; list_user_posts(page: 1, per_page: 10, user_id: 1)</span><br><span class="hljs-string">      [%&#123;photo_url: &quot;&quot;, url_id: &quot;&quot;&#125;, ...]</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">list_profile_posts</span></span>(<span class="hljs-symbol">page:</span> page, <span class="hljs-symbol">per_page:</span> per_page, <span class="hljs-symbol">user_id:</span> user_id) <span class="hljs-keyword">do</span><br>    Post<br>    |&gt; select([p], map(p, [<span class="hljs-symbol">:url_id</span>, <span class="hljs-symbol">:photo_url</span>]))<br>    |&gt; where(<span class="hljs-symbol">user_id:</span> ^user_id)<br>    |&gt; limit(^per_page)<br>    |&gt; offset(^((page - <span class="hljs-number">1</span>) * per_page))<br>    |&gt; order_by(<span class="hljs-symbol">desc:</span> <span class="hljs-symbol">:id</span>)<br>    |&gt; Repo.all<br>  <span class="hljs-keyword">end</span><br><br>...<br></code></pre></td></tr></table></figure>

<p>打开<code>lib/instagram_clone_web/live/user_live/profile.ex</code>并分配帖子：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><br>...<br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Posts<br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(%&#123;<span class="hljs-string">&quot;username&quot;</span> =&gt; username&#125;, session, socket) <span class="hljs-keyword">do</span><br>    socket = assign_defaults(session, socket)<br>    user = Accounts.profile(username)<br><br>    &#123;<span class="hljs-symbol">:ok</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">page:</span> <span class="hljs-number">1</span>, <span class="hljs-symbol">per_page:</span> <span class="hljs-number">15</span>)<br>      |&gt; assign(<span class="hljs-symbol">user:</span> user)<br>      |&gt; assign(<span class="hljs-symbol">page_title:</span> <span class="hljs-string">&quot;<span class="hljs-subst">#&#123;user.full_name&#125;</span> (@<span class="hljs-subst">#&#123;user.username&#125;</span>)&quot;</span>)<br>      |&gt; assign_posts(),<br>      <span class="hljs-symbol">temporary_assigns:</span> [<span class="hljs-symbol">posts:</span> []]&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">assign_posts</span></span>(socket) <span class="hljs-keyword">do</span><br>    socket<br>    |&gt; assign(<span class="hljs-symbol">posts:</span><br>      Posts.list_profile_posts(<br>        <span class="hljs-symbol">page:</span> socket.assigns.page,<br>        <span class="hljs-symbol">per_page:</span> socket.assigns.per_page,<br>        <span class="hljs-symbol">user_id:</span> socket.assigns.user.id<br>      )<br>    )<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;load-more-profile-posts&quot;</span>, _, socket) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:noreply</span>, socket |&gt; load_posts&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">load_posts</span></span>(socket) <span class="hljs-keyword">do</span><br>    total_posts = socket.assigns.user.posts_count<br>    page = socket.assigns.page<br>    per_page = socket.assigns.per_page<br>    total_pages = ceil(total_posts / per_page)<br><br>    if page == total_pages <span class="hljs-keyword">do</span><br>      socket<br>    else<br>      socket<br>      |&gt; update(<span class="hljs-symbol">:page</span>, &amp;(&amp;<span class="hljs-number">1</span> + <span class="hljs-number">1</span>))<br>      |&gt; assign_posts()<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>...<br></code></pre></td></tr></table></figure>

<p>一切都保持不变，我们只需分配页面并设置每页的限制，然后在我们的<code>mount()</code>函数中分配个人资料帖子。我们添加了一个事件处理函数，该函数将在模板中使用 javascript 挂钩触发，如果不是最后一页，它将加载更多页面。</p>
<p><code>lib/instagram_clone_web/live/user_live/profile.html.leex</code>在文件底部打开以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><br>...<br><br>&lt;!-- Gallery Grid --&gt;<br>&lt;div id=<span class="hljs-string">&quot;posts&quot;</span> phx-update=<span class="hljs-string">&quot;append&quot;</span> class=<span class="hljs-string">&quot;mt-9 grid gap-8 grid-cols-3&quot;</span>&gt;<br>  &lt;%= <span class="hljs-keyword">for</span> post &lt;- <span class="hljs-variable">@posts</span> <span class="hljs-keyword">do</span> %&gt;<br>    &lt;%= live_redirect img_tag(post.photo_url, <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;object-cover h-80 w-full&quot;</span>),<br>      <span class="hljs-symbol">id:</span> post.url_id,<br>      <span class="hljs-symbol">to:</span> Routes.live_path(<span class="hljs-variable">@socket</span>, InstagramCloneWeb.PostLive.Show, post.url_id) %&gt;<br>  &lt;% <span class="hljs-keyword">end</span> %&gt;<br>&lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp"></span><br><span class="hljs-regexp">&lt;div</span><br><span class="hljs-regexp">  id=&quot;profile-posts-footer&quot;</span><br><span class="hljs-regexp">  class=&quot;flex justify-center&quot;</span><br><span class="hljs-regexp">  phx-hook=&quot;ProfilePostsScroll&quot;&gt;</span><br><span class="hljs-regexp">&lt;/div</span>&gt;<br></code></pre></td></tr></table></figure>

<p>我们将每个新页面附加到 posts div 中，底部有一个空的 div，每次可见时都会触发事件来加载更多页面。</p>
<p>打开<code>assets/js/app.js</code>并添加我们的钩子：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><br>...<br><br>let Hooks = &#123;&#125;<br><br>Hooks.ProfilePostsScroll = &#123;<br>  mounted() &#123;<br>    this.observer = new IntersectionObserver(entries =&gt; &#123;<br>      const entry = entries[0];<br>      if (entry.isIntersecting) &#123;  <br>        this.pushEvent(<span class="hljs-string">&quot;load-more-profile-posts&quot;</span>);<br>      &#125;<br>    &#125;);<br><br>    this.observer.observe(this.el);<br>  &#125;,<br>  destroyed() &#123;<br>    this.observer.disconnect();<br>  &#125;,<br>&#125;<br><br>let csrfToken = document.querySelector(<span class="hljs-string">&quot;meta[name=&#x27;csrf-token&#x27;]&quot;</span>).getAttribute(<span class="hljs-string">&quot;content&quot;</span>)<br>let liveSocket = new LiveSocket(<span class="hljs-string">&quot;/live&quot;</span>, Socket, &#123;<br>  <span class="hljs-symbol">hooks:</span> Hooks,<br>  <span class="hljs-symbol">params:</span> &#123; <span class="hljs-symbol">_csrf_token:</span> csrfToken &#125;,<br>  <span class="hljs-symbol">dom:</span> &#123;<br>    onBeforeElUpdated(from, to) &#123;<br>      if (from.__x) &#123; Alpine.clone(from.__x, to) &#125;<br>    &#125;<br>  &#125;<br>&#125;)<br><br>...<br></code></pre></td></tr></table></figure>

<p>每次到达或可见空页脚 div 时，我们使用观察者来推送事件以加载更多帖子。</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="https://s2.loli.net/2023/08/30/xYvkAoH6gG1WyVp.jpg" alt="instagram-phoenix-p4-2.jpg" class="lazyload"></p>
<p>打开lib/instagram_clone/posts.ex并添加一个函数来通过 url id 获取帖子：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><br>...<br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_post_by_url!</span></span>(id) <span class="hljs-keyword">do</span> <br>    Repo.get_by!(Post, <span class="hljs-symbol">url_id:</span> id)<br>    |&gt; Repo.preload(<span class="hljs-symbol">:user</span>)<br>  <span class="hljs-keyword">end</span><br>...<br></code></pre></td></tr></table></figure>

<p>让我们在 mount 函数中分配 post <code>lib/instagram_clone_web/live/post_live/show.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.PostLive.Show</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_view</span><br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Posts<br>  <span class="hljs-keyword">alias</span> InstagramClone.Uploaders.Avatar<br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(%&#123;<span class="hljs-string">&quot;id&quot;</span> =&gt; id&#125;, session, socket) <span class="hljs-keyword">do</span><br>    socket = assign_defaults(session, socket)<br>    post = Posts.get_post_by_url!(URI.decode(id))<br><br>    &#123;<span class="hljs-symbol">:ok</span>, socket |&gt; assign(<span class="hljs-symbol">post:</span> post)&#125;<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>我们正在对 URL ID 进行解码，因为在我们的个人资料模板中，当我们发布帖子时，<code>live_redirect</code> URL ID 会被编码。我们<code>Base.encode64</code>用来生成 id 的 ，有时会产生特殊字符，例如/需要在 URL 中进行编码的字符。</p>
<p>这就是这部分的内容，这是一项正在进行的工作。在下一部分中，我们将使用 show-post 页面。</p>
<p>转自：<a target="_blank" rel="noopener" href="https://elixirprogrammer.com/learn/lets-build-an-instagram-clone-with-the-petal-phoenix-elixir-tailwindcss-alpinejs-liveview-stack-part-4/">Elixirprogrammer</a></p>

  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>本文作者：</strong>MarkHoo<br>
        <strong>本文链接：</strong><a href="https://blog.markhoo.com/posts/instagram-phoenix-liveview-p4/" title="https:&#x2F;&#x2F;blog.markhoo.com&#x2F;posts&#x2F;instagram-phoenix-liveview-p4&#x2F;" target="_blank" rel="noopener">https:&#x2F;&#x2F;blog.markhoo.com&#x2F;posts&#x2F;instagram-phoenix-liveview-p4&#x2F;</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 进行许可
        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
    
        <a class="nexmoefont icon-appstore-fill -link" href="/categories/Elixir/">Elixir</a>
    
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/AlpineJS/" rel="tag">AlpineJS</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Elixir/" rel="tag">Elixir</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/LiveView/" rel="tag">LiveView</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Phoenix/" rel="tag">Phoenix</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/TailwindCSS/" rel="tag">TailwindCSS</a>
    
</div>

  
      <div class="nexmoe-post-footer">
          <section class="nexmoe-comment">
    <div class="valine"></div>
<script src='https://cdn.jsdelivr.net/npm/valine'></script>
<script>
    // 使用方法 https://valine.js.org/quickstart.html
    new Valine({
        el: '.valine',
        appId: 'LnljA9jtf29oZKiQMJ6OAWJU-gzGzoHsz',
        appKey: 'wb1Mrzef0b2x540dSrcCcg5y'
    })
</script>
</section>
      </div>
  
</div>
            <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                        
                          
                          
                          
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
        </div>
    </div>
     
    <div id="nexmoe-search-space">
        <div class="search-container">
            <div class="search-header">
                <div class="search-input-container">
                    <input class="search-input" type="text" placeholder="搜索" oninput="sinput();">
                </div>
                <a class="search-close" onclick="sclose();">×</a>
            </div>
            <div class="search-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/combine/npm/lazysizes@5.1.0/lazysizes.min.js,npm/mdui@0.4.3/dist/js/mdui.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

 

<script async src="/js/app.js?v=1693394714817"></script>



<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>


    





</body>

</html>
