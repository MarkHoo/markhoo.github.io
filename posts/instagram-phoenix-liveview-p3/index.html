<!DOCTYPE html>

<html lang="zh-CN">

<head>
    
    <title>使用 Phoenix LiveView 构建 Instagram (3) - 和光同尘|MarkHoo_不积跬步无以至千里，不积小流无以成江海</title>
    <meta charset="UTF-8">
    <meta name="description" content="终日而思,不如须臾之所学也">
    <meta name="keywords" content="和光同尘,MarkHoo,Python,Elixir,Phoenix,SpringBoot,Django,">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    

    <link rel="shortcut icon" href="https://media.markhoo.com/image/favicon24.ico" type="image/x-icon" />
    <meta name="description" content="使用PETAL(Phoenix、Elixir、TailwindCSS、AlpineJS、LiveView)技术栈构建一个简化版的Instagram Web应用程序">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 Phoenix LiveView 构建 Instagram (3)">
<meta property="og:url" content="https://blog.markhoo.com/posts/instagram-phoenix-liveview-p3/">
<meta property="og:site_name" content="和光同尘|MarkHoo_不积跬步无以至千里，不积小流无以成江海">
<meta property="og:description" content="使用PETAL(Phoenix、Elixir、TailwindCSS、AlpineJS、LiveView)技术栈构建一个简化版的Instagram Web应用程序">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/08/30/YEm8GDHX7kzdQIK.gif">
<meta property="og:image" content="https://s2.loli.net/2023/08/30/jU1ZCgdJqBeSc4f.gif">
<meta property="article:published_time" content="2023-08-31T14:43:40.000Z">
<meta property="article:modified_time" content="2023-08-30T09:09:39.203Z">
<meta property="article:author" content="MarkHoo">
<meta property="article:tag" content="Elixir">
<meta property="article:tag" content="Phoenix">
<meta property="article:tag" content="LiveView">
<meta property="article:tag" content="TailwindCSS">
<meta property="article:tag" content="AlpineJS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/08/30/YEm8GDHX7kzdQIK.gif">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/npm/highlight.js@9.15.8/styles/atom-one-dark.css,npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css,gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css,npm/hexo-theme-nexmoe@latest/source/lib/mdui_043tiny/css/mdui.css,npm/hexo-theme-nexmoe@latest/source/lib/iconfont/iconfont.css?v=233" crossorigin>
    <link rel="stylesheet" href="/css/style.css?v=1693394714818">
     
    
    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1693394714818">
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="mdui-drawer-body-left">
    
    <div id="nexmoe-background">
        <div class="nexmoe-bg" style="background-image: url(https://s2.loli.net/2023/08/30/SfpNaZsg3IW5MDz.jpg)"></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="MarkHoo" class="mdui-btn mdui-btn-icon"><img src="https://media.markhoo.com/avatar.jpg" alt="MarkHoo"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="MarkHoo">
            <img src="https://media.markhoo.com/avatar.jpg" alt="MarkHoo" alt="MarkHoo">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>53</div>
        <div><span>标签</span>40</div>
        <div><span>分类</span>11</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archives" title="归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/books" title="书架">
            <i class="mdui-list-item-icon nexmoefont icon-battlenet"></i>
            <div class="mdui-list-item-content">
                书架
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about" title="关于">
            <i class="mdui-list-item-icon nexmoefont icon-coffee"></i>
            <div class="mdui-list-item-content">
                关于
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/links" title="邻居">
            <i class="mdui-list-item-icon nexmoefont icon-dribbble"></i>
            <div class="mdui-list-item-content">
                邻居
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=site:markhoo.com" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
            </form>
         
    </div>
</div>
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://jq.qq.com/" target="_blank" mdui-tooltip="{content: 'QQ群'}" style="color: rgb(249, 174, 8);background-color: rgba(249, 174, 8, .1);">
            <i class="nexmoefont icon-QQ"></i>
        </a><a class="mdui-ripple" href="https://space.bilibili.com/182687081" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/markhoo/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
    
    
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/API/" style="font-size: 10px;">API</a> <a href="/tags/AlpineJS/" style="font-size: 16.25px;">AlpineJS</a> <a href="/tags/ArchLinux/" style="font-size: 10px;">ArchLinux</a> <a href="/tags/C-C/" style="font-size: 10px;">C/C++</a> <a href="/tags/CentOS7/" style="font-size: 15px;">CentOS7</a> <a href="/tags/Django/" style="font-size: 18.75px;">Django</a> <a href="/tags/Elixir/" style="font-size: 18.75px;">Elixir</a> <a href="/tags/EndeavourOS/" style="font-size: 10px;">EndeavourOS</a> <a href="/tags/Erlang/" style="font-size: 10px;">Erlang</a> <a href="/tags/Gin/" style="font-size: 10px;">Gin</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/Gitlab/" style="font-size: 10px;">Gitlab</a> <a href="/tags/Go/" style="font-size: 16.25px;">Go</a> <a href="/tags/Gunicorn/" style="font-size: 12.5px;">Gunicorn</a> <a href="/tags/Hugo/" style="font-size: 10px;">Hugo</a> <a href="/tags/IDE/" style="font-size: 11.25px;">IDE</a> <a href="/tags/JWT/" style="font-size: 10px;">JWT</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Linux/" style="font-size: 13.75px;">Linux</a> <a href="/tags/LiveView/" style="font-size: 16.25px;">LiveView</a> <a href="/tags/Lua/" style="font-size: 11.25px;">Lua</a> <a href="/tags/Manim/" style="font-size: 10px;">Manim</a> <a href="/tags/NeoVim/" style="font-size: 11.25px;">NeoVim</a> <a href="/tags/Nginx/" style="font-size: 13.75px;">Nginx</a> <a href="/tags/Phoenix/" style="font-size: 17.5px;">Phoenix</a> <a href="/tags/PyCharm/" style="font-size: 10px;">PyCharm</a> <a href="/tags/Python/" style="font-size: 20px;">Python</a> <a href="/tags/Rest/" style="font-size: 10px;">Rest</a> <a href="/tags/TailwindCSS/" style="font-size: 16.25px;">TailwindCSS</a> <a href="/tags/Unix/" style="font-size: 10px;">Unix</a> <a href="/tags/Vim/" style="font-size: 12.5px;">Vim</a> <a href="/tags/hexo/" style="font-size: 11.25px;">hexo</a> <a href="/tags/pip/" style="font-size: 11.25px;">pip</a> <a href="/tags/pypi/" style="font-size: 10px;">pypi</a> <a href="/tags/xadmin/" style="font-size: 10px;">xadmin</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E7%BD%91%E6%98%93%E4%BA%91%E9%9F%B3%E4%B9%90/" style="font-size: 10px;">网易云音乐</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 11.25px;">面试题</a> <a href="/tags/%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8/" style="font-size: 10px;">音乐播放器</a>
    </div>
    
  </div>

    
</aside>
    <div class="nexmoe-copyright">
        &copy; 2023 MarkHoo
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        <br><a target="_blank" href="https://beian.miit.gov.cn">苏ICP备17044309号</a><br><a target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"><img src="https://i.dawnlab.me/c0268c1e6cfd0863d6ba35be1575941a.png" width="150px"></a><script data-ad-client="ca-pub-2058306854838448" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
            <div class="nexmoe-post">

  <article>
      
          <div class="nexmoe-post-cover" style="padding-bottom: 45.83333333333333%;"> 
              <img data-src="https://s2.loli.net/2023/08/30/SfpNaZsg3IW5MDz.jpg" data-sizes="auto" alt="使用 Phoenix LiveView 构建 Instagram (3)" class="lazyload">
              <h1>使用 Phoenix LiveView 构建 Instagram (3)</h1>
          </div>
      
      
      <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2023年08月31日</a>
    <a><i class="nexmoefont icon-areachart"></i>8k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 45 分钟</a>
</div>

      

      <blockquote>
<p>使用PETAL(Phoenix、Elixir、TailwindCSS、AlpineJS、LiveView)技术栈构建一个简化版的Instagram Web应用程序</p>
</blockquote>
<span id="more"></span>

<p>在第 2 部分中，我们添加了编辑帐户和上传用户头像的功能，在这部分中，我们将处理用户的个人资料。您可以赶上Instagram 克隆 GitHub Repo。  </p>
<p>首先，我们需要路由，<code>lib/instagram_clone_web/router.ex</code>在根范围下打开添加以下路由<code>:browser</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs elixir">scope <span class="hljs-string">&quot;/&quot;</span>, InstagramCloneWeb <span class="hljs-keyword">do</span><br>  pipe_through <span class="hljs-symbol">:browser</span><br>  <br>  live <span class="hljs-string">&quot;/&quot;</span>, PageLive,  <span class="hljs-symbol">:index</span><br>  live <span class="hljs-string">&quot;/:username&quot;</span>, UserLive.Profile <span class="hljs-comment"># THIS LINE WAS ADDED</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>然后让我们在<code>lib/instagram_clone_web/live/user_live</code>文件夹中创建实时查看文件：</p>
<p><code>lib/instagram_clone_web/live/user_live/profile.ex</code> <code>lib/instagram_clone_web/live/user_live/profile.html.leex</code></p>
<p>在里面添加以下内容<code>lib/instagram_clone_web/live/user_live/profile.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.UserLive.Profile</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_view</span><br>  <br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(%&#123;<span class="hljs-string">&quot;username&quot;</span> =&gt; username&#125;, session, socket) <span class="hljs-keyword">do</span><br>    socket = assign_defaults(session, socket)<br><br>    &#123;<span class="hljs-symbol">:ok</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">username:</span> username)&#125;<br>  <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>里面<code>lib/instagram_clone_web/live/user_live/profile.html.leex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;h1 class=<span class="hljs-string">&quot;text-5xl&quot;</span>&gt;&lt;%= <span class="hljs-variable">@username</span> %&gt;&lt;<span class="hljs-regexp">/h1&gt;</span><br></code></pre></td></tr></table></figure>

<p>打开第 56 行的导航标题，<code>lib/instagram_clone_web/live/header_nav_component.html.leex</code>让我们添加新路线：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= live_patch <span class="hljs-symbol">to:</span> Routes.live_path(<span class="hljs-variable">@socket</span>, InstagramCloneWeb.UserLive.Profile, <span class="hljs-variable">@current_user</span>.username)  <span class="hljs-keyword">do</span>  %&gt;<br></code></pre></td></tr></table></figure>

<p>我们需要找到用户名参数传递给我们的实时视图的用户，打开<code>lib/instagram_clone/accounts.ex</code>添加一个<code>profile()</code>函数来为我们做到这一点：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs elixir">...<br><br>  <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  Gets the user with the given username param.</span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">profile</span></span>(param) <span class="hljs-keyword">do</span><br>    Repo.get_by!(User, <span class="hljs-symbol">username:</span> param)<br>  <span class="hljs-keyword">end</span><br><br>...<br></code></pre></td></tr></table></figure>

<p>让我们更新里面的挂载函数<code>lib/instagram_clone_web/live/user_live/profile.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.UserLive.Profile</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_view</span><br>  <br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(_params, session, socket) <span class="hljs-keyword">do</span><br>    socket = assign_defaults(session, socket)<br><br>    &#123;<span class="hljs-symbol">:ok</span>, socket&#125;<br>  <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>我们需要处理用户名参数，打开宏<code>lib/instagram_clone_web.ex</code>并将其更新<code>live_view()</code>为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">live_view</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">quote</span> <span class="hljs-keyword">do</span><br>    <span class="hljs-keyword">use</span> Phoenix.LiveView,<br>      <span class="hljs-symbol">layout:</span> &#123;InstagramCloneWeb.LayoutView, <span class="hljs-string">&quot;live.html&quot;</span>&#125;<br><br>    unquote(view_helpers())<br>    <span class="hljs-keyword">import</span> InstagramCloneWeb.LiveHelpers<br><br>    <span class="hljs-keyword">alias</span> InstagramClone.Accounts.User<br>    <span class="hljs-keyword">alias</span> InstagramClone.Accounts <span class="hljs-comment"># &lt;-- THIS LINE WAS ADDED</span><br>    <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_info</span></span>(%&#123;<span class="hljs-symbol">event:</span> <span class="hljs-string">&quot;logout_user&quot;</span>, <span class="hljs-symbol">payload:</span> %&#123;<span class="hljs-symbol">user:</span> %User&#123;<span class="hljs-symbol">id:</span> id&#125;&#125;&#125;, socket) <span class="hljs-keyword">do</span><br>      <span class="hljs-keyword">with</span> %User&#123;<span class="hljs-symbol">id:</span> ^id&#125; &lt;- socket.assigns.current_user <span class="hljs-keyword">do</span><br>        &#123;<span class="hljs-symbol">:noreply</span>,<br>          socket<br>          |&gt; redirect(<span class="hljs-symbol">to:</span> <span class="hljs-string">&quot;/&quot;</span>)<br>          |&gt; put_flash(<span class="hljs-symbol">:info</span>, <span class="hljs-string">&quot;Logged out successfully.&quot;</span>)&#125;<br>      else<br>        _any -&gt; &#123;<span class="hljs-symbol">:noreply</span>, socket&#125;<br>      <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br> <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">   Because we are calling this function in each liveview, </span><br><span class="hljs-string">   and we needed access to the username param in our profile liveview, </span><br><span class="hljs-string">   we updated this function for when the username param is present,</span><br><span class="hljs-string">   get the user and assign it along with page title to the socket</span><br><span class="hljs-string"> &quot;&quot;&quot;</span><br>    <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_params</span></span>(params, uri, socket) <span class="hljs-keyword">do</span><br>      if Map.has_key?(params, <span class="hljs-string">&quot;username&quot;</span>) <span class="hljs-keyword">do</span><br>        %&#123;<span class="hljs-string">&quot;username&quot;</span> =&gt; username&#125; = params<br>        user = Accounts.profile(username)<br>        &#123;<span class="hljs-symbol">:noreply</span>,<br>        socket<br>        |&gt; assign(<span class="hljs-symbol">current_uri_path:</span> URI.parse(uri).path)<br>        |&gt; assign(<span class="hljs-symbol">user:</span> user, <span class="hljs-symbol">page_title:</span> <span class="hljs-string">&quot;<span class="hljs-subst">#&#123;user.full_name&#125;</span> (@<span class="hljs-subst">#&#123;user.username&#125;</span>)&quot;</span>)&#125;<br>      else<br>        &#123;<span class="hljs-symbol">:noreply</span>,<br>          socket<br>          |&gt; assign(<span class="hljs-symbol">current_uri_path:</span> URI.parse(uri).path)&#125;<br>      <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h2 id="Repo-get-by-可查询、子句、选项"><a href="#Repo-get-by-可查询、子句、选项" class="headerlink" title="Repo.get_by!(可查询、子句、选项)"></a>Repo.get_by!(可查询、子句、选项)</h2><p>从查询中获取单个结果。Ecto.NoResultsError如果未找到记录或有多个条目，则引发。在生产中，当找不到记录时会出现 404 错误。</p>
<p>在第 57 行打开，<code>lib/instagram_clone_web/live/header_nav_component.htm.leex</code>将以下内容添加到配置文件列表标记中，以在选择时关闭下拉菜单：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;li  <span class="hljs-variable">@click</span>=<span class="hljs-string">&quot;open = false&quot;</span>  class=<span class="hljs-string">&quot;py-2 px-4 hover:bg-gray-50&quot;</span>&gt;Profile&lt;<span class="hljs-regexp">/li&gt;</span><br></code></pre></td></tr></table></figure>

<p>里面<code>lib/instagram_clone_web/live/user_live/profile.html.leex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;header class=<span class="hljs-string">&quot;flex justify-center px-10&quot;</span>&gt;<br>  &lt;!-- Profile Picture Section --&gt;<br>  &lt;section class=<span class="hljs-string">&quot;w-1/4&quot;</span>&gt;<br>      &lt;%= img_tag <span class="hljs-variable">@user</span>.avatar_url,<br>          <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-40 h-40 rounded-full object-cover object-center&quot;</span> %&gt;<br>  &lt;<span class="hljs-regexp">/section&gt;</span><br><span class="hljs-regexp">  &lt;!-- END Profile Picture Section --&gt;</span><br><span class="hljs-regexp"></span><br><span class="hljs-regexp">  &lt;!-- Profile Details Section --&gt;</span><br><span class="hljs-regexp">  &lt;section class=&quot;w-3/</span><span class="hljs-number">4</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">    &lt;div class=&quot;</span>flex px<span class="hljs-number">-3</span> pt<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">        &lt;h1 class=&quot;</span>truncate <span class="hljs-symbol">md:</span>overflow-clip text<span class="hljs-number">-2</span>xl <span class="hljs-symbol">md:</span>text<span class="hljs-number">-2</span>xl text-gray<span class="hljs-number">-500</span> mb<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;&lt;%= @user.username %&gt;&lt;/h1&gt;</span><br><span class="hljs-string">        &lt;span class=&quot;</span>ml<span class="hljs-number">-11</span><span class="hljs-string">&quot;&gt;&lt;button class=&quot;</span>py<span class="hljs-number">-1</span> px<span class="hljs-number">-5</span> border-none shadow rounded text-gray<span class="hljs-number">-50</span> <span class="hljs-symbol">hover:</span>bg-light-blue<span class="hljs-number">-600</span> bg-light-blue<span class="hljs-number">-500</span><span class="hljs-string">&quot;&gt;Follow&lt;/button&gt;&lt;/span&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;div&gt;</span><br><span class="hljs-string">      &lt;ul class=&quot;</span>flex p<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">          &lt;li&gt;&lt;b&gt;0&lt;/b&gt; Posts&lt;/li&gt;</span><br><span class="hljs-string">          &lt;li class=&quot;</span>ml<span class="hljs-number">-11</span><span class="hljs-string">&quot;&gt;&lt;b&gt;0&lt;/b&gt; Followers&lt;/li&gt;</span><br><span class="hljs-string">          &lt;li class=&quot;</span>ml<span class="hljs-number">-11</span><span class="hljs-string">&quot;&gt;&lt;b&gt;0&lt;/b&gt; Following&lt;/li&gt;</span><br><span class="hljs-string">      &lt;/ul&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;div class=&quot;</span>p<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      &lt;h2 class=&quot;</span>text-md text-gray<span class="hljs-number">-600</span> font-bold<span class="hljs-string">&quot;&gt;&lt;%= @user.full_name %&gt;&lt;/h2&gt;</span><br><span class="hljs-string">      &lt;%= if @user.bio do %&gt;</span><br><span class="hljs-string">        &lt;p class=&quot;</span>max-w-full <span class="hljs-keyword">break</span>-words<span class="hljs-string">&quot;&gt;&lt;%= @user.bio %&gt;&lt;/p&gt;</span><br><span class="hljs-string">      &lt;% end %&gt;</span><br><span class="hljs-string">      &lt;%= if @user.website do %&gt;</span><br><span class="hljs-string">        &lt;%= link display_website_uri(@user.website),</span><br><span class="hljs-string">          to: @user.website,</span><br><span class="hljs-string">          target: &quot;</span>_blank<span class="hljs-string">&quot;, rel: &quot;</span>noreferrer<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          class: &quot;</span>text-blue<span class="hljs-number">-700</span><span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">      &lt;% end %&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string">  &lt;/section&gt;</span><br><span class="hljs-string">  &lt;!-- END Profile Details Section --&gt;</span><br><span class="hljs-string">&lt;/header&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;section class=&quot;</span>border-t<span class="hljs-number">-2</span> mt<span class="hljs-number">-5</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">  &lt;ul class=&quot;</span>flex justify-center text-center space-x<span class="hljs-number">-20</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-600</span> border-t<span class="hljs-number">-2</span> border-black -mt-0.<span class="hljs-number">5</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">       POSTS</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-400</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      IGTV</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-400</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      SAVED</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-400</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      TAGGED</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">  &lt;/ul&gt;</span><br><span class="hljs-string">&lt;/section&gt;</span><br></code></pre></td></tr></table></figure>

<p>打开<code>lib/instagram_clone_web/live/render_helpers.ex</code>添加以下2个函数来显示和获取网站uri：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">display_website_uri</span></span>(website) <span class="hljs-keyword">do</span><br>  website = website<br>  |&gt; String.replace_leading(<span class="hljs-string">&quot;https://&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>  |&gt; String.replace_leading(<span class="hljs-string">&quot;http://&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>  website<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>现在我们需要在内部创建用户关注组件<code>lib/instagram_clone_web/live/user_live</code>：</p>
<p><code>lib/instagram_clone_web/live/user_live/follow_component.ex</code></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.UserLive.FollowComponent</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_component</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">render</span></span>(assigns) <span class="hljs-keyword">do</span><br>    <span class="hljs-string">~L&quot;&quot;&quot;</span><br><span class="hljs-string">    &lt;button</span><br><span class="hljs-string">      phx-target=&quot;&lt;%= @myself %&gt;&quot;</span><br><span class="hljs-string">      phx-click=&quot;</span>toggle-status<span class="hljs-string">&quot;</span><br><span class="hljs-string">      class=&quot;</span>&lt;%= <span class="hljs-variable">@follow_btn_styles</span>? %&gt;<span class="hljs-string">&quot;&gt;&lt;%= @follow_btn_name? %&gt;&lt;/button&gt;</span><br><span class="hljs-string">    &quot;</span><span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;toggle-status&quot;</span>, _params, socket) <span class="hljs-keyword">do</span><br>    follow_btn_name? = get_follow_btn_name?(socket.assigns.follow_btn_name?)<br>    follow_btn_styles? = get_follow_btn_styles?(socket.assigns.follow_btn_name?)<br><br>    <span class="hljs-symbol">:timer</span>.sleep(<span class="hljs-number">200</span>)<br>    &#123;<span class="hljs-symbol">:noreply</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">follow_btn_name?:</span> follow_btn_name?)<br>      |&gt; assign(<span class="hljs-symbol">follow_btn_styles?:</span> follow_btn_styles?)&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_follow_btn_name?</span></span>(name) <span class="hljs-keyword">when</span> name == <span class="hljs-string">&quot;Follow&quot;</span> <span class="hljs-keyword">do</span><br>    <span class="hljs-string">&quot;Unfollow&quot;</span><br>  <span class="hljs-keyword">end</span><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_follow_btn_name?</span></span>(name) <span class="hljs-keyword">when</span> name == <span class="hljs-string">&quot;Unfollow&quot;</span> <span class="hljs-keyword">do</span><br>    <span class="hljs-string">&quot;Follow&quot;</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_follow_btn_styles?</span></span>(name) <span class="hljs-keyword">when</span> name == <span class="hljs-string">&quot;Follow&quot;</span>  <span class="hljs-keyword">do</span><br>    <span class="hljs-string">&quot;py-1 px-2 text-red-500 border-2 rounded font-semibold hover:bg-gray-50 focus:outline-none&quot;</span><br>  <span class="hljs-keyword">end</span><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_follow_btn_styles?</span></span>(name) <span class="hljs-keyword">when</span> name == <span class="hljs-string">&quot;Unfollow&quot;</span> <span class="hljs-keyword">do</span><br>    <span class="hljs-string">&quot;py-1 px-5 border-none shadow rounded text-gray-50 hover:bg-light-blue-600 bg-light-blue-500 focus:outline-none&quot;</span><br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>在我们的渲染函数中，我们只有按钮和一个将在组件内部获取句柄的单击函数。它有 2 个分配，一个用于按钮名称，另一个用于样式，这些将在我们的配置文件 LiveView 中设置，然后在我们的事件函数中，我们将它们分配回套接字。</p>
<p>现在让我们在配置文件模板中使用我们的组件，打开<code>lib/instagram_clone_web/live/user_live/profile.html.leex</code>文件并将其更新为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;header class=<span class="hljs-string">&quot;flex justify-center px-10&quot;</span>&gt;<br>  &lt;!-- Profile Picture Section --&gt;<br>  &lt;section class=<span class="hljs-string">&quot;w-1/4&quot;</span>&gt;<br>      &lt;%= img_tag <span class="hljs-variable">@user</span>.avatar_url,<br>          <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-40 h-40 rounded-full object-cover object-center&quot;</span> %&gt;<br>  &lt;<span class="hljs-regexp">/section&gt;</span><br><span class="hljs-regexp">  &lt;!-- END Profile Picture Section --&gt;</span><br><span class="hljs-regexp"></span><br><span class="hljs-regexp">  &lt;!-- Profile Details Section --&gt;</span><br><span class="hljs-regexp">  &lt;section class=&quot;w-3/</span><span class="hljs-number">4</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">    &lt;div class=&quot;</span>flex px<span class="hljs-number">-3</span> pt<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">        &lt;h1 class=&quot;</span>truncate <span class="hljs-symbol">md:</span>overflow-clip text<span class="hljs-number">-2</span>xl <span class="hljs-symbol">md:</span>text<span class="hljs-number">-2</span>xl text-gray<span class="hljs-number">-500</span> mb<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;&lt;%= @user.username %&gt;&lt;/h1&gt;</span><br><span class="hljs-string">        &lt;span class=&quot;</span>ml<span class="hljs-number">-11</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">	      &lt;!-- THE BUTTON WAS REPLACED FOR THE COMPONENT --&gt;</span><br><span class="hljs-string">          &lt;%= cond do %&gt;</span><br><span class="hljs-string">            &lt;% @current_user &amp;&amp; @current_user == @user -&gt; %&gt;</span><br><span class="hljs-string">              &lt;%= live_patch &quot;</span>Edit Profile<span class="hljs-string">&quot;,</span><br><span class="hljs-string">                to: Routes.live_path(@socket, InstagramCloneWeb.UserLive.Settings),</span><br><span class="hljs-string">                class: &quot;</span>py<span class="hljs-number">-1</span> px<span class="hljs-number">-2</span> border<span class="hljs-number">-2</span> rounded font-semibold <span class="hljs-symbol">hover:</span>bg-gray<span class="hljs-number">-50</span><span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">            &lt;% @current_user -&gt; %&gt;</span><br><span class="hljs-string">              &lt;%= live_component @socket,</span><br><span class="hljs-string">                InstagramCloneWeb.UserLive.FollowComponent,</span><br><span class="hljs-string">                id: @user.id,</span><br><span class="hljs-string">                follow_btn_name?: @follow_btn_name?,</span><br><span class="hljs-string">                follow_btn_styles?: @follow_btn_styles? %&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">            &lt;% true -&gt; %&gt;</span><br><span class="hljs-string">              &lt;%= link &quot;</span>Follow<span class="hljs-string">&quot;, to: Routes.user_session_path(@socket, :new), class: &quot;</span>py<span class="hljs-number">-1</span> px<span class="hljs-number">-5</span> border-none shadow rounded text-gray<span class="hljs-number">-50</span> <span class="hljs-symbol">hover:</span>bg-light-blue<span class="hljs-number">-600</span> bg-light-blue<span class="hljs-number">-500</span><span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">          &lt;% end %&gt;</span><br><span class="hljs-string">          &lt;!-- ALL THIS UNTIL HERE WAS ADDED --&gt;</span><br><span class="hljs-string">        &lt;/span&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;div&gt;</span><br><span class="hljs-string">      &lt;ul class=&quot;</span>flex p<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">          &lt;li&gt;&lt;b&gt;0&lt;/b&gt; Posts&lt;/li&gt;</span><br><span class="hljs-string">          &lt;li class=&quot;</span>ml<span class="hljs-number">-11</span><span class="hljs-string">&quot;&gt;&lt;b&gt;0&lt;/b&gt; Followers&lt;/li&gt;</span><br><span class="hljs-string">          &lt;li class=&quot;</span>ml<span class="hljs-number">-11</span><span class="hljs-string">&quot;&gt;&lt;b&gt;0&lt;/b&gt; Following&lt;/li&gt;</span><br><span class="hljs-string">      &lt;/ul&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;div class=&quot;</span>p<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      &lt;h2 class=&quot;</span>text-md text-gray<span class="hljs-number">-600</span> font-bold<span class="hljs-string">&quot;&gt;&lt;%= @user.full_name %&gt;&lt;/h2&gt;</span><br><span class="hljs-string">      &lt;%= if @user.bio do %&gt;</span><br><span class="hljs-string">        &lt;p class=&quot;</span>max-w-full <span class="hljs-keyword">break</span>-words<span class="hljs-string">&quot;&gt;&lt;%= @user.bio %&gt;&lt;/p&gt;</span><br><span class="hljs-string">      &lt;% end %&gt;</span><br><span class="hljs-string">      &lt;%= if @user.website do %&gt;</span><br><span class="hljs-string">        &lt;%= link display_website_uri(@user.website),</span><br><span class="hljs-string">          to: @user.website,</span><br><span class="hljs-string">          target: &quot;</span>_blank<span class="hljs-string">&quot;, rel: &quot;</span>noreferrer<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          class: &quot;</span>text-blue<span class="hljs-number">-700</span><span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">      &lt;% end %&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string">  &lt;/section&gt;</span><br><span class="hljs-string">  &lt;!-- END Profile Details Section --&gt;</span><br><span class="hljs-string">&lt;/header&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;section class=&quot;</span>border-t<span class="hljs-number">-2</span> mt<span class="hljs-number">-5</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">  &lt;ul class=&quot;</span>flex justify-center text-center space-x<span class="hljs-number">-20</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-600</span> border-t<span class="hljs-number">-2</span> border-black -mt-0.<span class="hljs-number">5</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">       POSTS</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-400</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      IGTV</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-400</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      SAVED</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-400</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      TAGGED</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">  &lt;/ul&gt;</span><br><span class="hljs-string">&lt;/section&gt;</span><br></code></pre></td></tr></table></figure>

<p>我们创建了一个条件来向用户显示正确的按钮，当登录并且用户在他的个人资料上时，它将获得一个编辑个人资料链接，当登录和任何其他个人资料时，我们显示该组件，当未登录时，只是一个链接到登录页面。现在我们需要发送到组件的分配，就在组件显示时，打开<code>lib/instagram_clone_web/live/user_live/profile.ex</code>文件并将其更新为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.UserLive.Profile</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_view</span><br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Accounts<br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(%&#123;<span class="hljs-string">&quot;username&quot;</span> =&gt; username&#125;, session, socket) <span class="hljs-keyword">do</span><br>    socket = assign_defaults(session, socket)<br>    current_user = socket.assigns.current_user<br>    user = Accounts.profile(username)<br><br>    get_assigns(socket, current_user, user)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_follow_btn_name?</span></span> <span class="hljs-keyword">do</span><br>    <span class="hljs-string">&quot;Follow&quot;</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_follow_btn_styles?</span></span> <span class="hljs-keyword">do</span><br>    <span class="hljs-string">&quot;py-1 px-5 border-none shadow rounded text-gray-50 hover:bg-light-blue-600 bg-light-blue-500 focus:outline-none&quot;</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_assigns</span></span>(socket, current_user, user) <span class="hljs-keyword">do</span><br>    if current_user &amp;&amp; current_user !== user <span class="hljs-keyword">do</span><br>      follow_btn_name? = get_follow_btn_name?()<br>      follow_btn_styles? = get_follow_btn_styles?()<br><br>      &#123;<span class="hljs-symbol">:ok</span>,<br>        socket<br>        |&gt; assign(<span class="hljs-symbol">follow_btn_name?:</span> follow_btn_name?)<br>        |&gt; assign(<span class="hljs-symbol">follow_btn_styles?:</span> follow_btn_styles?)&#125;<br>    else<br>      &#123;<span class="hljs-symbol">:ok</span>, socket&#125;<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>让我们创建一个关注模式来处理终端中的关注者：</p>
<p><code>$ mix phx.gen.schema Accounts.Follows accounts_follows follower_id:references:users followed_id:references:users</code></p>
<p>打开生成的迁移并添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span>  <span class="hljs-title">InstagramClone.Repo.Migrations.CreateAccountsFollows</span></span>  <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> Ecto.Migration<br>  <br>  <span class="hljs-function"><span class="hljs-keyword">def</span>  <span class="hljs-title">change</span></span>  <span class="hljs-keyword">do</span><br>    create table(<span class="hljs-symbol">:accounts_follows</span>)  <span class="hljs-keyword">do</span><br>      add <span class="hljs-symbol">:follower_id</span>,  references(<span class="hljs-symbol">:users</span>,  <span class="hljs-symbol">on_delete:</span>  <span class="hljs-symbol">:delete_all</span>)<br>      add <span class="hljs-symbol">:followed_id</span>,  references(<span class="hljs-symbol">:users</span>,  <span class="hljs-symbol">on_delete:</span>  <span class="hljs-symbol">:delete_all</span>)<br><br>      timestamps()<br>    <span class="hljs-keyword">end</span><br>	<br>    create index(<span class="hljs-symbol">:accounts_follows</span>,  [<span class="hljs-symbol">:follower_id</span>])<br>    create index(<span class="hljs-symbol">:accounts_follows</span>,  [<span class="hljs-symbol">:followed_id</span>])<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>另外，让我们在用户表中添加 2 个新字段，以跟踪总关注者和关注者，回到我们的终端：</p>
<p><code>$ mix ecto.gen.migration adds_follower_followings_count_to_users_table</code></p>
<p>打开生成的迁移并添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramClone.Repo.Migrations.AddsFollowerFollowingsCountToUsersTable</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> Ecto.Migration<br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">change</span></span> <span class="hljs-keyword">do</span><br>    alter table(<span class="hljs-symbol">:users</span>) <span class="hljs-keyword">do</span><br>      add <span class="hljs-symbol">:followers_count</span>, <span class="hljs-symbol">:integer</span>, <span class="hljs-symbol">default:</span> 0<br>      add <span class="hljs-symbol">:following_count</span>, <span class="hljs-symbol">:integer</span>, <span class="hljs-symbol">default:</span> 0<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>返回终端运行<code>$ mix ecto.migrate</code></p>
<p>现在打开在该文件内生成的新架构，<code>lib/instagram_clone/accounts/follows.ex</code>添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramClone.Accounts.Follows</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> Ecto.Schema<br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Accounts.User<br><br>  schema <span class="hljs-string">&quot;accounts_follows&quot;</span> <span class="hljs-keyword">do</span><br>    belongs_to <span class="hljs-symbol">:follower</span>, User<br>    belongs_to <span class="hljs-symbol">:followed</span>, User<br><br>    timestamps()<br>  <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>里面<code>lib/instagram_clone/accounts/user.ex</code>添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-keyword">alias</span> InstagramClone.Accounts.Follows<br><br><span class="hljs-variable">@derive</span> &#123;Inspect,  <span class="hljs-symbol">except:</span>  [<span class="hljs-symbol">:password</span>]&#125;<br>schema <span class="hljs-string">&quot;users&quot;</span>  <span class="hljs-keyword">do</span><br>  field <span class="hljs-symbol">:email</span>,  <span class="hljs-symbol">:string</span><br>  field <span class="hljs-symbol">:password</span>,  <span class="hljs-symbol">:string</span>,  <span class="hljs-symbol">virtual:</span>  <span class="hljs-keyword">true</span><br>  field <span class="hljs-symbol">:hashed_password</span>,  <span class="hljs-symbol">:string</span><br>  field <span class="hljs-symbol">:confirmed_at</span>,  <span class="hljs-symbol">:naive_datetime</span><br>  field <span class="hljs-symbol">:username</span>,  <span class="hljs-symbol">:string</span><br>  field <span class="hljs-symbol">:full_name</span>,  <span class="hljs-symbol">:string</span><br>  field <span class="hljs-symbol">:avatar_url</span>,  <span class="hljs-symbol">:string</span>,  <span class="hljs-symbol">default:</span>  <span class="hljs-string">&quot;/images/default-avatar.png&quot;</span><br>  field <span class="hljs-symbol">:bio</span>,  <span class="hljs-symbol">:string</span><br>  field <span class="hljs-symbol">:website</span>,  <span class="hljs-symbol">:string</span><br>  field <span class="hljs-symbol">:followers_count</span>, <span class="hljs-symbol">:integer</span>, <span class="hljs-symbol">default:</span> 0<br>  field <span class="hljs-symbol">:following_count</span>, <span class="hljs-symbol">:integer</span>, <span class="hljs-symbol">default:</span> 0<br>  has_many <span class="hljs-symbol">:following</span>, Follows,  <span class="hljs-symbol">foreign_key:</span>  <span class="hljs-symbol">:follower_id</span><br>  has_many <span class="hljs-symbol">:followers</span>, Follows,  <span class="hljs-symbol">foreign_key:</span>  <span class="hljs-symbol">:followed_id</span><br>  timestamps()<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">registration_changeset</span></span>(user, attrs, opts \\ []) <span class="hljs-keyword">do</span><br>  user<br>  |&gt; cast(attrs, [<span class="hljs-symbol">:email</span>, <span class="hljs-symbol">:password</span>, <span class="hljs-symbol">:username</span>, <span class="hljs-symbol">:full_name</span>, <span class="hljs-symbol">:avatar_url</span>, <span class="hljs-symbol">:bio</span>, <span class="hljs-symbol">:website</span>])<br>  |&gt; validate_required([<span class="hljs-symbol">:username</span>, <span class="hljs-symbol">:full_name</span>])<br>  |&gt; validate_length(<span class="hljs-symbol">:username</span>, <span class="hljs-symbol">min:</span> <span class="hljs-number">5</span>, <span class="hljs-symbol">max:</span> <span class="hljs-number">30</span>)<br>  |&gt; validate_format(<span class="hljs-symbol">:username</span>, <span class="hljs-string">~r/^[a-zA-Z0-9_.-]*$/</span>, <span class="hljs-symbol">message:</span> <span class="hljs-string">&quot;Please use letters and numbers without space(only characters allowed _ . -)&quot;</span>)<br>  |&gt; unique_constraint(<span class="hljs-symbol">:username</span>)<br>  |&gt; unsafe_validate_unique(<span class="hljs-symbol">:username</span>, InstagramClone.Repo)<br>  |&gt; validate_length(<span class="hljs-symbol">:full_name</span>, <span class="hljs-symbol">min:</span> <span class="hljs-number">4</span>, <span class="hljs-symbol">max:</span> <span class="hljs-number">255</span>)<br>  |&gt; validate_format(<span class="hljs-symbol">:full_name</span>,  <span class="hljs-string">~r/^[a-zA-Z0-9 ]*$/</span>,  <span class="hljs-symbol">message:</span>  <span class="hljs-string">&quot;Please use letters and numbers&quot;</span>)<br>  |&gt; validate_website_schemes()<br>  |&gt; validate_website_authority()<br>  |&gt; validate_email()<br>  |&gt; validate_password(opts)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">validate_website_schemes</span></span>(changeset) <span class="hljs-keyword">do</span><br>  validate_change(changeset, <span class="hljs-symbol">:website</span>, <span class="hljs-keyword">fn</span> <span class="hljs-symbol">:website</span>, website -&gt;<br>    uri = URI.parse(website)<br>    if uri.scheme, <span class="hljs-symbol">do:</span> check_uri_scheme(uri.scheme), <span class="hljs-symbol">else:</span> [<span class="hljs-symbol">website:</span> <span class="hljs-string">&quot;Enter a valid website&quot;</span>]<br>  <span class="hljs-keyword">end</span>)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">validate_website_authority</span></span>(changeset) <span class="hljs-keyword">do</span><br>  validate_change(changeset, <span class="hljs-symbol">:website</span>, <span class="hljs-keyword">fn</span> <span class="hljs-symbol">:website</span>, website -&gt;<br>    authority = URI.parse(website).authority<br>    if String.match?(authority, <span class="hljs-string">~r/^[a-zA-Z0-9.-]*$/</span>) <span class="hljs-keyword">do</span><br>      []<br>    else<br>      [<span class="hljs-symbol">website:</span> <span class="hljs-string">&quot;Enter a valid website&quot;</span>]<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span>)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">check_uri_scheme</span></span>(scheme) <span class="hljs-keyword">when</span> scheme == <span class="hljs-string">&quot;http&quot;</span>, <span class="hljs-symbol">do:</span> []<br><span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">check_uri_scheme</span></span>(scheme) <span class="hljs-keyword">when</span> scheme == <span class="hljs-string">&quot;https&quot;</span>, <span class="hljs-symbol">do:</span> []<br><span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">check_uri_scheme</span></span>(_scheme), <span class="hljs-symbol">do:</span> [<span class="hljs-symbol">website:</span> <span class="hljs-string">&quot;Enter a valid website&quot;</span>]<br></code></pre></td></tr></table></figure>

<p><code>lib/instagram_clone/accounts.ex</code>在文件的底部和顶部添加以下函数<code>alias InstagramClone.Accounts.Follows</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">Creates a follow to the given followed user, and builds</span><br><span class="hljs-string">user association to be able to preload the user when associations are loaded,</span><br><span class="hljs-string">gets users to update counts, then performs 3 Repo operations,</span><br><span class="hljs-string">creates the follow, updates user followings count, and user followers count,</span><br><span class="hljs-string">we select the user in our updated followers count query, that gets returned</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_follow</span></span>(follower, followed, user) <span class="hljs-keyword">do</span><br>  follower = Ecto.build_assoc(follower, <span class="hljs-symbol">:following</span>)<br>  follow = Ecto.build_assoc(followed, <span class="hljs-symbol">:followers</span>, follower)<br>  update_following_count = from(u <span class="hljs-keyword">in</span> User, <span class="hljs-symbol">where:</span> u.id == ^user.id)<br>  update_followers_count = from(u <span class="hljs-keyword">in</span> User, <span class="hljs-symbol">where:</span> u.id == ^followed.id, <span class="hljs-symbol">select:</span> u)<br><br>  Ecto.Multi.new()<br>  |&gt; Ecto.Multi.insert(<span class="hljs-symbol">:follow</span>, follow)<br>  |&gt; Ecto.Multi.update_all(<span class="hljs-symbol">:update_following</span>, update_following_count, <span class="hljs-symbol">inc:</span> [<span class="hljs-symbol">following_count:</span> <span class="hljs-number">1</span>])<br>  |&gt; Ecto.Multi.update_all(<span class="hljs-symbol">:update_followers</span>, update_followers_count, <span class="hljs-symbol">inc:</span> [<span class="hljs-symbol">followers_count:</span> <span class="hljs-number">1</span>])<br>  |&gt; Repo.transaction()<br>  |&gt; <span class="hljs-keyword">case</span> <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:ok</span>,   %&#123;<span class="hljs-symbol">update_followers:</span> update_followers&#125;&#125; -&gt;<br>      &#123;<span class="hljs-number">1</span>, user&#125; = update_followers<br>      hd(user)<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">Deletes following association with given user,</span><br><span class="hljs-string">then performs 3 Repo operations, to delete the association,</span><br><span class="hljs-string">update followings count, update and select followers count,</span><br><span class="hljs-string">updated followers count gets returned</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unfollow</span></span>(follower_id, followed_id) <span class="hljs-keyword">do</span><br>  follow = following?(follower_id, followed_id)<br>  update_following_count = from(u <span class="hljs-keyword">in</span> User, <span class="hljs-symbol">where:</span> u.id == ^follower_id)<br>  update_followers_count = from(u <span class="hljs-keyword">in</span> User, <span class="hljs-symbol">where:</span> u.id == ^followed_id, <span class="hljs-symbol">select:</span> u)<br><br>  Ecto.Multi.new()<br>  |&gt; Ecto.Multi.delete(<span class="hljs-symbol">:follow</span>, follow)<br>  |&gt; Ecto.Multi.update_all(<span class="hljs-symbol">:update_following</span>, update_following_count, <span class="hljs-symbol">inc:</span> [<span class="hljs-symbol">following_count:</span> <span class="hljs-number">-1</span>])<br>  |&gt; Ecto.Multi.update_all(<span class="hljs-symbol">:update_followers</span>, update_followers_count, <span class="hljs-symbol">inc:</span> [<span class="hljs-symbol">followers_count:</span> <span class="hljs-number">-1</span>])<br>  |&gt; Repo.transaction()<br>  |&gt; <span class="hljs-keyword">case</span> <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:ok</span>,   %&#123;<span class="hljs-symbol">update_followers:</span> update_followers&#125;&#125; -&gt;<br>      &#123;<span class="hljs-number">1</span>, user&#125; = update_followers<br>      hd(user)<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">Returns nil if not found</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">following?</span></span>(follower_id, followed_id) <span class="hljs-keyword">do</span><br>  Repo.get_by(Follows, [<span class="hljs-symbol">follower_id:</span> follower_id, <span class="hljs-symbol">followed_id:</span> followed_id])<br><span class="hljs-keyword">end</span><br><br><span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">Returns all user&#x27;s followings</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">list_following</span></span>(user) <span class="hljs-keyword">do</span><br>  user = user |&gt; Repo.preload(<span class="hljs-symbol">:following</span>)<br>  user.following |&gt; Repo.preload(<span class="hljs-symbol">:followed</span>)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">Returns all user&#x27;s followers</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">list_followers</span></span>(user) <span class="hljs-keyword">do</span><br>  user = user |&gt; Repo.preload(<span class="hljs-symbol">:followers</span>)<br>  user.followers |&gt; Repo.preload(<span class="hljs-symbol">:follower</span>)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>现在让我们更新我们的文件<code>lib/instagram_clone_web/live/user_live/profile.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.UserLive.Profile</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_view</span><br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Accounts<br>  <span class="hljs-keyword">alias</span> InstagramCloneWeb.UserLive.FollowComponent<br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(_params, session, socket) <span class="hljs-keyword">do</span><br>    socket = assign_defaults(session, socket)<br><br>    &#123;<span class="hljs-symbol">:ok</span>, socket&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_info</span></span>(&#123;FollowComponent, <span class="hljs-symbol">:update_totals</span>, updated_user&#125;, socket) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:noreply</span>, socket |&gt; assign(<span class="hljs-symbol">user:</span> updated_user)&#125;<br>  <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>我们将在组件内设置关注按钮，然后向父级实时视图发送消息以更新计数。</p>
<p>在里面<code>lib/instagram_clone_web/live/user_live/profile.html.leex</code>更新第 20 行和第 27 行的分配名称：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%  <span class="hljs-variable">@current_user</span> -&gt;  %&gt;<br>  &lt;%= live_component <span class="hljs-variable">@socket</span>,<br>    InstagramCloneWeb.UserLive.FollowComponent,<br>    <span class="hljs-symbol">id:</span>  <span class="hljs-variable">@user</span>.id,<br>    <span class="hljs-symbol">user:</span>  <span class="hljs-variable">@user</span>,<br>    <span class="hljs-symbol">current_user:</span>  <span class="hljs-variable">@current_user</span> %&gt;<br><br>&lt;%  <span class="hljs-keyword">true</span>  -&gt;  %&gt;<br>  &lt;%= link <span class="hljs-string">&quot;Follow&quot;</span>,  <span class="hljs-symbol">to:</span> Routes.user_session_path(<span class="hljs-variable">@socket</span>,  <span class="hljs-symbol">:new</span>),  <span class="hljs-symbol">class:</span>  <span class="hljs-string">&quot;user-profile-follow-btn&quot;</span>  %&gt;<br>  <br></code></pre></td></tr></table></figure>

<p>打开<code>assets/css/app.scss</code>并添加以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs elixir">/* This file is <span class="hljs-keyword">for</span> your main application css. *<span class="hljs-regexp">/</span><br><span class="hljs-regexp">@import &quot;tailwindcss/base</span><span class="hljs-string">&quot;;</span><br><span class="hljs-string">@import &quot;</span>tailwindcss/components<span class="hljs-string">&quot;;</span><br><span class="hljs-string">@import &quot;</span>tailwindcss/utilities<span class="hljs-string">&quot;;</span><br><span class="hljs-string">@import &quot;</span>../node_modules/nprogress/nprogress.css<span class="hljs-string">&quot;;</span><br><span class="hljs-string"></span><br><span class="hljs-string">@layer components &#123;</span><br><span class="hljs-string">  .user-profile-unfollow-btn &#123;</span><br><span class="hljs-string">    @apply  py-1  px-2  text-red-500  border-2  rounded  font-semibold  hover:bg-gray-50</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">  .user-profile-follow-btn &#123;</span><br><span class="hljs-string">    @apply  py-1  px-5  border-none  shadow  rounded  text-gray-50  hover:bg-light-blue-600  bg-light-blue-500</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">/* Styles for handling buttons click events */</span><br><span class="hljs-string">.while-submitting  &#123;  display: none;  &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">.phx-click-loading  &#123;</span><br><span class="hljs-string">  .while-submitting  &#123;  display: inline;  &#125;</span><br><span class="hljs-string">  .btns  &#123;  display: none;  &#125;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<p>打开<code>lib/instagram_clone_web/live/user_live/follow_component.ex</code>文件并将其更新为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.UserLive.FollowComponent</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_component</span><br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Accounts<br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span></span>(assigns, socket) <span class="hljs-keyword">do</span><br>    get_btn_status(socket, assigns)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">render</span></span>(assigns) <span class="hljs-keyword">do</span><br>    <span class="hljs-string">~L&quot;&quot;&quot;</span><br><span class="hljs-string">    &lt;button</span><br><span class="hljs-string">      phx-target=&quot;&lt;%= @myself %&gt;&quot;</span><br><span class="hljs-string">      phx-click=&quot;</span>toggle-status<span class="hljs-string">&quot;</span><br><span class="hljs-string">      class=&quot;</span><span class="hljs-symbol">focus:</span>outline-none<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">      &lt;span class=&quot;</span><span class="hljs-keyword">while</span>-submitting<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">        &lt;span class=&quot;</span>&lt;%= <span class="hljs-variable">@follow_btn_styles</span> %&gt; inline-flex items-center transition ease-<span class="hljs-keyword">in</span>-out duration<span class="hljs-number">-150</span> cursor-<span class="hljs-keyword">not</span>-allowed<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">          &lt;svg class=&quot;</span>animate-spin -ml<span class="hljs-number">-1</span> mr<span class="hljs-number">-3</span> h<span class="hljs-number">-5</span> w<span class="hljs-number">-5</span> text-gray<span class="hljs-number">-300</span><span class="hljs-string">&quot; xmlns=&quot;</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/www.w3.org/</span><span class="hljs-number">2000</span>/svg<span class="hljs-string">&quot; fill=&quot;</span>none<span class="hljs-string">&quot; viewBox=&quot;</span>0 0 <span class="hljs-number">24</span> <span class="hljs-number">24</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">            &lt;circle class=&quot;</span>opacity<span class="hljs-number">-25</span><span class="hljs-string">&quot; cx=&quot;</span><span class="hljs-number">12</span><span class="hljs-string">&quot; cy=&quot;</span><span class="hljs-number">12</span><span class="hljs-string">&quot; r=&quot;</span><span class="hljs-number">10</span><span class="hljs-string">&quot; stroke=&quot;</span>currentColor<span class="hljs-string">&quot; stroke-width=&quot;</span><span class="hljs-number">4</span><span class="hljs-string">&quot;&gt;&lt;/circle&gt;</span><br><span class="hljs-string">            &lt;path class=&quot;</span>opacity<span class="hljs-number">-75</span><span class="hljs-string">&quot; fill=&quot;</span>currentColor<span class="hljs-string">&quot; d=&quot;</span>M4 <span class="hljs-number">12</span>a8 <span class="hljs-number">8</span> 0 018<span class="hljs-number">-8</span>V0C5.<span class="hljs-number">373</span> 0 0 <span class="hljs-number">5.373</span> 0 <span class="hljs-number">12</span>h4zm2 <span class="hljs-number">5.291</span>A7.<span class="hljs-number">962</span> <span class="hljs-number">7.962</span> 0 014 <span class="hljs-number">12</span>H0c0 <span class="hljs-number">3.042</span> <span class="hljs-number">1.135</span> <span class="hljs-number">5.824</span> <span class="hljs-number">3</span> <span class="hljs-number">7.938</span>l3<span class="hljs-number">-2.647</span>z<span class="hljs-string">&quot;&gt;&lt;/path&gt;</span><br><span class="hljs-string">          &lt;/svg&gt;</span><br><span class="hljs-string">          Saving</span><br><span class="hljs-string">        &lt;/span&gt;</span><br><span class="hljs-string">      &lt;/span&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">      &lt;span class=&quot;</span>&lt;%= <span class="hljs-variable">@follow_btn_styles</span> %&gt;<span class="hljs-string">&quot;&gt;&lt;%= @follow_btn_name %&gt;&lt;span&gt;</span><br><span class="hljs-string">    &lt;/button&gt;</span><br><span class="hljs-string">    &quot;</span><span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;toggle-status&quot;</span>, _params, socket) <span class="hljs-keyword">do</span><br>    current_user = socket.assigns.current_user<br>    user = socket.assigns.user<br><br>    <span class="hljs-symbol">:timer</span>.sleep(<span class="hljs-number">300</span>)<br>    if Accounts.following?(current_user.id, user.id) <span class="hljs-keyword">do</span><br>      unfollow(socket, current_user.id, user.id)<br>    else<br>      follow(socket, current_user, user)<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_btn_status</span></span>(socket, assigns) <span class="hljs-keyword">do</span><br>    if Accounts.following?(assigns.current_user.id, assigns.user.id) <span class="hljs-keyword">do</span><br>      get_socket_assigns(socket, assigns, <span class="hljs-string">&quot;Unfollow&quot;</span>, <span class="hljs-string">&quot;user-profile-unfollow-btn&quot;</span>)<br>    else<br>      get_socket_assigns(socket, assigns, <span class="hljs-string">&quot;Follow&quot;</span>, <span class="hljs-string">&quot;user-profile-follow-btn&quot;</span>)<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_socket_assigns</span></span>(socket, assigns, btn_name, btn_styles) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:ok</span>,<br>      socket<br>      |&gt; assign(assigns)<br>      |&gt; assign(<span class="hljs-symbol">follow_btn_name:</span> btn_name)<br>      |&gt; assign(<span class="hljs-symbol">follow_btn_styles:</span> btn_styles)&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">follow</span></span>(socket, current_user, user) <span class="hljs-keyword">do</span><br>    updated_user = Accounts.create_follow(current_user, user, current_user)<br>    <span class="hljs-comment"># Message sent to the parent liveview to update totals</span><br>    send(<span class="hljs-keyword">self</span>(), &#123;__MODULE__, <span class="hljs-symbol">:update_totals</span>, updated_user&#125;)<br>    &#123;<span class="hljs-symbol">:noreply</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">follow_btn_name:</span> <span class="hljs-string">&quot;Unfollow&quot;</span>)<br>      |&gt; assign(<span class="hljs-symbol">follow_btn_styles:</span> <span class="hljs-string">&quot;user-profile-unfollow-btn&quot;</span>)&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">unfollow</span></span>(socket, current_user_id, user_id) <span class="hljs-keyword">do</span><br>    updated_user = Accounts.unfollow(current_user_id, user_id)<br>    <span class="hljs-comment"># Message sent to the parent liveview to update totals</span><br>    send(<span class="hljs-keyword">self</span>(), &#123;__MODULE__, <span class="hljs-symbol">:update_totals</span>, updated_user&#125;)<br>    &#123;<span class="hljs-symbol">:noreply</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">follow_btn_name:</span> <span class="hljs-string">&quot;Follow&quot;</span>)<br>      |&gt; assign(<span class="hljs-symbol">follow_btn_styles:</span> <span class="hljs-string">&quot;user-profile-follow-btn&quot;</span>)&#125;<br>  <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>内部<code>lib/instagram_clone_web/live/user_live/profile.html.leex</code>更新第 37、38 行：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;li class=<span class="hljs-string">&quot;ml-11&quot;</span>&gt;&lt;b&gt;&lt;%=  <span class="hljs-variable">@user</span>.followers_count %&gt;&lt;<span class="hljs-regexp">/b&gt; Followers&lt;/li</span>&gt;<br>&lt;li class=<span class="hljs-string">&quot;ml-11&quot;</span>&gt;&lt;b&gt;&lt;%=  <span class="hljs-variable">@user</span>.following_count %&gt;&lt;<span class="hljs-regexp">/b&gt; Following&lt;/li</span>&gt;<br></code></pre></td></tr></table></figure>

<p>一切都应该工作正常，但是出现了一个问题，您可以在下面的 gif 图片中看到它。</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="https://s2.loli.net/2023/08/30/YEm8GDHX7kzdQIK.gif" alt="instagram-phoenix-p3-1.gif" class="lazyload"></p>
<p>当关注按钮被触发并且我们导航到我们的个人资料时，我们仍然在同一条路线上，我们没有得到正确的编辑个人资料按钮，因为我们在标题导航中使用，所以当我们转到我们的个人资料时，<code>live_patch/2</code>有没有变化，唯一改变的是<code>@user</code>在我们的模板中，我们用来显示右侧按钮的情况永远不会被调用。</p>
<p><code>link/2</code>并<code>redirect/2</code>重新加载整页</p>
<p><code>live_redirect/2</code>并<code>push_redirect/2</code>重新加载 LiveView 但保留当前布局</p>
<p><code>live_patch/2</code>并<code>push_patch/2</code>更新当前的 LiveView 并仅发送最小的差异</p>
<p>当您想要导航到当前的 LiveView 时，必须使用“修补”操作，只需更新 URL 和当前参数，而不需要挂载新的 LiveView。使用补丁时，将调用handle_params/3回调并将最小的更改集发送到客户端。请参阅下一节了解更多信息。</p>
<p>一个简单的经验法则是坚持使用 <code>live_redirect/2</code> 和 <code>push_redirect/2</code> 并仅在您希望在同一 LiveView 中导航时最大程度地减少发送的数据量的情况下使用补丁帮助程序（例如，如果您想更改对表进行排序，同时更新 URL）。</p>
<p>我们能想到的唯一可以解决该问题的解决方案是<code>live_redirect/2</code>在标题导航中使用重新加载 LiveView。在第 56 行打开，<code>lib/instagram_clone_web/live/header_nav_component.html.leex</code>执行以下操作：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= live_redirect <span class="hljs-symbol">to:</span> Routes.live_path(<span class="hljs-variable">@socket</span>, InstagramCloneWeb.UserLive.Profile,  <span class="hljs-variable">@current_user</span>.username)  <span class="hljs-keyword">do</span>  %&gt;<br></code></pre></td></tr></table></figure>

<p>现在，LiveView 重新加载，我们会显示正确的按钮。我还注意到为什么我们需要使用该<code>handle_params()</code>函数来分配用户，因为当我们使用<code>live_patch/2</code>任何内容时都没有更改并且用户分配没有重新加载，但现在 LiveView 重新加载，因此我们可以在 LiveView<code>mount()</code>函数中设置用户，这是冲突的。</p>
<p>打开函数<code>lib/instagram_clone_web/live/user_live/profile.ex</code>并将其更新<code>mount()</code>为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(%&#123;<span class="hljs-string">&quot;username&quot;</span> =&gt; username&#125;, session, socket) <span class="hljs-keyword">do</span><br>  socket = assign_defaults(session, socket)<br>  user = Accounts.profile(username)<br><br>  &#123;<span class="hljs-symbol">:ok</span>,<br>    socket<br>    |&gt; assign(<span class="hljs-symbol">user:</span> user)<br>    |&gt; assign(<span class="hljs-symbol">page_title:</span> <span class="hljs-string">&quot;<span class="hljs-subst">#&#123;user.full_name&#125;</span> (@<span class="hljs-subst">#&#123;user.username&#125;</span>)&quot;</span>)&#125;<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>打开<code>lib/instagram_clone_web.ex</code>并在我们的<code>live_view()</code>宏中将函数更新<code>handle_params()</code>为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_params</span></span>(_params, uri, socket) <span class="hljs-keyword">do</span><br>  &#123;<span class="hljs-symbol">:noreply</span>,<br>    socket<br>    |&gt; assign(<span class="hljs-symbol">current_uri_path:</span> URI.parse(uri).path)&#125;<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>另外，当我们在个人资料页面上时，我们不再需要在选择时关闭下拉菜单，因此<code>lib/instagram_clone_web/live/header_nav_component.htm.leex</code>在第 57 行打开，删除 AlpineJS 指令：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;li class=<span class="hljs-string">&quot;py-2 px-4 hover:bg-gray-50&quot;</span>&gt;Profile&lt;<span class="hljs-regexp">/li&gt;</span><br></code></pre></td></tr></table></figure>

<p>让我们坚持只<code>live_patch/2</code>在我们只想显示使用 URLS 参数更新的内容时使用，这不会触发任何操作或更改任何状态。</p>
<p>我还决定处理 LiveView 中关注按钮的条件，这是个人喜好，您可以选择任何一种方式或您感觉舒服的方式。打开<code>lib/instagram_clone_web/live/user_live/profile.ex</code>并添加以下私有函数：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_action</span></span>(user, current_user) <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">cond</span> <span class="hljs-keyword">do</span><br>    current_user &amp;&amp; current_user == user -&gt; <span class="hljs-symbol">:edit_profile</span><br>    current_user -&gt; <span class="hljs-symbol">:follow_component</span><br>    <span class="hljs-keyword">true</span> -&gt; <span class="hljs-symbol">:login_btn</span><br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>然后<code>lib/instagram_clone_web/live/user_live/profile.ex</code>在我们的 mount 函数中，让我们分配<code>my_action</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(%&#123;<span class="hljs-string">&quot;username&quot;</span> =&gt; username&#125;, session, socket) <span class="hljs-keyword">do</span><br>  socket = assign_defaults(session, socket)<br>  user = Accounts.profile(username)<br>  my_action = get_action(user, socket.assigns.current_user)<br><br>  &#123;<span class="hljs-symbol">:ok</span>,<br>    socket<br>    |&gt; assign(<span class="hljs-symbol">my_action:</span> my_action)<br>    |&gt; assign(<span class="hljs-symbol">user:</span> user)<br>    |&gt; assign(<span class="hljs-symbol">page_title:</span> <span class="hljs-string">&quot;<span class="hljs-subst">#&#123;user.full_name&#125;</span> (@<span class="hljs-subst">#&#123;user.username&#125;</span>)&quot;</span>)&#125;<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>然后打开<code>lib/instagram_clone_web/live/user_live/profile.html.leex</code>并将条件更新为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;header class=<span class="hljs-string">&quot;flex justify-center px-10&quot;</span>&gt;<br>  &lt;!-- Profile Picture Section --&gt;<br>  &lt;section class=<span class="hljs-string">&quot;w-1/4&quot;</span>&gt;<br>      &lt;%= img_tag <span class="hljs-variable">@user</span>.avatar_url,<br>          <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-40 h-40 rounded-full object-cover object-center&quot;</span> %&gt;<br>  &lt;<span class="hljs-regexp">/section&gt;</span><br><span class="hljs-regexp">  &lt;!-- END Profile Picture Section --&gt;</span><br><span class="hljs-regexp"></span><br><span class="hljs-regexp">  &lt;!-- Profile Details Section --&gt;</span><br><span class="hljs-regexp">  &lt;section class=&quot;w-3/</span><span class="hljs-number">4</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">    &lt;div class=&quot;</span>flex px<span class="hljs-number">-3</span> pt<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">        &lt;h1 class=&quot;</span>truncate <span class="hljs-symbol">md:</span>overflow-clip text<span class="hljs-number">-2</span>xl <span class="hljs-symbol">md:</span>text<span class="hljs-number">-2</span>xl text-gray<span class="hljs-number">-500</span> mb<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;&lt;%= @user.username %&gt;&lt;/h1&gt;</span><br><span class="hljs-string">        &lt;span class=&quot;</span>ml<span class="hljs-number">-11</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">          &lt;%= if @my_action in [:edit_profile] do %&gt;</span><br><span class="hljs-string">            &lt;%= live_patch &quot;</span>Edit Profile<span class="hljs-string">&quot;,</span><br><span class="hljs-string">                to: Routes.live_path(@socket, InstagramCloneWeb.UserLive.Settings),</span><br><span class="hljs-string">                class: &quot;</span>py<span class="hljs-number">-1</span> px<span class="hljs-number">-2</span> border<span class="hljs-number">-2</span> rounded font-semibold <span class="hljs-symbol">hover:</span>bg-gray<span class="hljs-number">-50</span><span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">          &lt;% end %&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">          &lt;%= if @my_action in [:follow_component] do %&gt;</span><br><span class="hljs-string">            &lt;%= live_component @socket,</span><br><span class="hljs-string">                InstagramCloneWeb.UserLive.FollowComponent,</span><br><span class="hljs-string">                id: @user.id,</span><br><span class="hljs-string">                user: @user,</span><br><span class="hljs-string">                current_user: @current_user %&gt;</span><br><span class="hljs-string">          &lt;% end %&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">          &lt;%= if @my_action in [:login_btn] do %&gt;</span><br><span class="hljs-string">            &lt;%= link &quot;</span>Follow<span class="hljs-string">&quot;, to: Routes.user_session_path(@socket, :new), class: &quot;</span>user-profile-follow-btn<span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">          &lt;% end %&gt;</span><br><span class="hljs-string">        &lt;/span&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;div&gt;</span><br><span class="hljs-string">      &lt;ul class=&quot;</span>flex p<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">          &lt;li&gt;&lt;b&gt;0&lt;/b&gt; Posts&lt;/li&gt;</span><br><span class="hljs-string">          &lt;li class=&quot;</span>ml<span class="hljs-number">-11</span><span class="hljs-string">&quot;&gt;&lt;b&gt;&lt;%= @user.followers_count %&gt;&lt;/b&gt; Followers&lt;/li&gt;</span><br><span class="hljs-string">          &lt;li class=&quot;</span>ml<span class="hljs-number">-11</span><span class="hljs-string">&quot;&gt;&lt;b&gt;&lt;%= @user.following_count %&gt;&lt;/b&gt; Following&lt;/li&gt;</span><br><span class="hljs-string">      &lt;/ul&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;div class=&quot;</span>p<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      &lt;h2 class=&quot;</span>text-md text-gray<span class="hljs-number">-600</span> font-bold<span class="hljs-string">&quot;&gt;&lt;%= @user.full_name %&gt;&lt;/h2&gt;</span><br><span class="hljs-string">      &lt;%= if @user.bio do %&gt;</span><br><span class="hljs-string">        &lt;p class=&quot;</span>max-w-full <span class="hljs-keyword">break</span>-words<span class="hljs-string">&quot;&gt;&lt;%= @user.bio %&gt;&lt;/p&gt;</span><br><span class="hljs-string">      &lt;% end %&gt;</span><br><span class="hljs-string">      &lt;%= if @user.website do %&gt;</span><br><span class="hljs-string">        &lt;%= link display_website_uri(@user.website),</span><br><span class="hljs-string">          to: @user.website,</span><br><span class="hljs-string">          target: &quot;</span>_blank<span class="hljs-string">&quot;, rel: &quot;</span>noreferrer<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          class: &quot;</span>text-blue<span class="hljs-number">-700</span><span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">      &lt;% end %&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string">  &lt;/section&gt;</span><br><span class="hljs-string">  &lt;!-- END Profile Details Section --&gt;</span><br><span class="hljs-string">&lt;/header&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;section class=&quot;</span>border-t<span class="hljs-number">-2</span> mt<span class="hljs-number">-5</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">  &lt;ul class=&quot;</span>flex justify-center text-center space-x<span class="hljs-number">-20</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-600</span> border-t<span class="hljs-number">-2</span> border-black -mt-0.<span class="hljs-number">5</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">       POSTS</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-400</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      IGTV</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-400</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      SAVED</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-400</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      TAGGED</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">  &lt;/ul&gt;</span><br><span class="hljs-string">&lt;/section&gt;</span><br></code></pre></td></tr></table></figure>

<p>让我们致力于显示以下内容和关注者，我们将为此使用模态，我们需要使用<code>handle_params()</code>每个 LiveView 上的宏中定义的函数，因此让我们采用该函数并正确分配它。</p>
<p>打开并从我们的宏中<code>lib/instagram_clone_web.ex</code>删除：<code>handle_params()</code> <code>live_view()</code></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-comment"># DELETE THIS FUNCTION AND MOVE IT TO: </span><br><span class="hljs-comment">#lib/instagram_clone_web/live/user_live/settings.ex</span><br><span class="hljs-comment">#lib/instagram_clone_web/live/user_live/pass_settings.ex</span><br><span class="hljs-comment">#lib/instagram_clone_web/live/page_live.ex</span><br>   <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>   <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_params</span></span>(_params, uri, socket) <span class="hljs-keyword">do</span><br>     &#123;<span class="hljs-symbol">:noreply</span>,<br>       socket<br>       |&gt; assign(<span class="hljs-symbol">current_uri_path:</span> URI.parse(uri).path)&#125;<br>   <span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p><strong>现在，在我们找到另一种方法之前，我们需要<code>current_uri_path</code>在每个实时视图上手动分配 ，所以让我们记住这一点，我们必须记住它。</strong></p>
<p>打开<code>lib/instagram_clone_web/router.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs elixir">scope <span class="hljs-string">&quot;/&quot;</span>, InstagramCloneWeb <span class="hljs-keyword">do</span><br>  pipe_through <span class="hljs-symbol">:browser</span><br>  <br>  live <span class="hljs-string">&quot;/&quot;</span>, PageLive,  <span class="hljs-symbol">:index</span><br>  live <span class="hljs-string">&quot;/:username&quot;</span>, UserLive.Profile, <span class="hljs-symbol">:index</span> <span class="hljs-comment"># THIS LINE WAS UPDATED</span><br><span class="hljs-keyword">end</span><br><br>scope <span class="hljs-string">&quot;/&quot;</span>, InstagramCloneWeb <span class="hljs-keyword">do</span><br>  pipe_through [<span class="hljs-symbol">:browser</span>, <span class="hljs-symbol">:require_authenticated_user</span>]<br><br>  get <span class="hljs-string">&quot;/users/settings/confirm_email/:token&quot;</span>, UserSettingsController, <span class="hljs-symbol">:confirm_email</span><br>  live <span class="hljs-string">&quot;/accounts/edit&quot;</span>, UserLive.Settings<br>  live <span class="hljs-string">&quot;/accounts/password/change&quot;</span>, UserLive.PassSettings<br>  live <span class="hljs-string">&quot;/:username/following&quot;</span>, UserLive.Profile, <span class="hljs-symbol">:following</span>  <span class="hljs-comment"># THIS LINE WAS ADDED</span><br>  live <span class="hljs-string">&quot;/:username/followers&quot;</span>, UserLive.Profile, <span class="hljs-symbol">:followers</span> <span class="hljs-comment"># THIS LINE WAS ADDED</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>打开第 56 行的导航标题，<code>lib/instagram_clone_web/live/header_nav_component.html.leex</code>让我们更新路线：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= live_patch <span class="hljs-symbol">to:</span> Routes.user_profile_path(<span class="hljs-variable">@socket</span>, <span class="hljs-symbol">:index</span>, <span class="hljs-variable">@current_user</span>.username)  <span class="hljs-keyword">do</span>  %&gt;<br></code></pre></td></tr></table></figure>

<p>更新<code>lib/instagram_clone_web/live/user_live/profile.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.UserLive.Profile</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_view</span><br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Accounts<br>  <span class="hljs-keyword">alias</span> InstagramCloneWeb.UserLive.FollowComponent<br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(%&#123;<span class="hljs-string">&quot;username&quot;</span> =&gt; username&#125;, session, socket) <span class="hljs-keyword">do</span><br>    socket = assign_defaults(session, socket)<br>    user = Accounts.profile(username)<br><br>    &#123;<span class="hljs-symbol">:ok</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">user:</span> user)<br>      |&gt; assign(<span class="hljs-symbol">page_title:</span> <span class="hljs-string">&quot;<span class="hljs-subst">#&#123;user.full_name&#125;</span> (@<span class="hljs-subst">#&#123;user.username&#125;</span>)&quot;</span>)&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_params</span></span>(_params, uri, socket) <span class="hljs-keyword">do</span><br>    socket = socket |&gt; assign(<span class="hljs-symbol">current_uri_path:</span> URI.parse(uri).path)<br>    &#123;<span class="hljs-symbol">:noreply</span>, apply_action(socket, socket.assigns.live_action)&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_info</span></span>(&#123;FollowComponent, <span class="hljs-symbol">:update_totals</span>, updated_user&#125;, socket) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:noreply</span>, apply_msg_action(socket, socket.assigns.live_action, updated_user)&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">apply_msg_action</span></span>(socket, <span class="hljs-symbol">:follow_component</span>, updated_user) <span class="hljs-keyword">do</span><br>    socket |&gt; assign(<span class="hljs-symbol">user:</span> updated_user)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">apply_msg_action</span></span>(socket, _, _updated_user) <span class="hljs-keyword">do</span><br>    socket<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">apply_action</span></span>(socket, <span class="hljs-symbol">:index</span>) <span class="hljs-keyword">do</span><br>	live_action = get_live_action(socket.assigns.user, socket.assigns.current_user)<br>	<br>    socket |&gt; assign(<span class="hljs-symbol">live_action:</span> live_action)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">apply_action</span></span>(socket, <span class="hljs-symbol">:following</span>) <span class="hljs-keyword">do</span><br>    following = Accounts.list_following(socket.assigns.user)<br>    socket |&gt; assign(<span class="hljs-symbol">following:</span> following)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">apply_action</span></span>(socket, <span class="hljs-symbol">:followers</span>) <span class="hljs-keyword">do</span><br>    followers = Accounts.list_followers(socket.assigns.user)<br>    socket |&gt; assign(<span class="hljs-symbol">followers:</span> followers)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">get_live_action</span></span>(user, current_user) <span class="hljs-keyword">do</span><br>    <span class="hljs-keyword">cond</span> <span class="hljs-keyword">do</span><br>      current_user &amp;&amp; current_user == user -&gt; <span class="hljs-symbol">:edit_profile</span><br>      current_user -&gt; <span class="hljs-symbol">:follow_component</span><br>      <span class="hljs-keyword">true</span> -&gt; <span class="hljs-symbol">:login_btn</span><br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>更新<code>lib/instagram_clone_web/live/user_live/profile.html.leex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= if <span class="hljs-variable">@live_action</span> == <span class="hljs-symbol">:following</span> <span class="hljs-keyword">do</span> %&gt;<br>  &lt;%= live_modal <span class="hljs-variable">@socket</span>, InstagramCloneWeb.UserLive.Profile.FollowingComponent,<br>    <span class="hljs-symbol">id:</span> <span class="hljs-variable">@user</span>.id || <span class="hljs-symbol">:following</span>,<br>    <span class="hljs-symbol">width:</span>  <span class="hljs-string">&quot;w-1/4&quot;</span>,<br>    <span class="hljs-symbol">current_user:</span> <span class="hljs-variable">@current_user</span>,<br>    <span class="hljs-symbol">following:</span> <span class="hljs-variable">@following</span>,<br>    <span class="hljs-symbol">return_to:</span> Routes.user_profile_path(<span class="hljs-variable">@socket</span>, <span class="hljs-symbol">:index</span>, <span class="hljs-variable">@user</span>.username) %&gt;<br>&lt;% <span class="hljs-keyword">end</span> %&gt;<br><br>&lt;%= if <span class="hljs-variable">@live_action</span> == <span class="hljs-symbol">:followers</span> <span class="hljs-keyword">do</span> %&gt;<br>  &lt;%= live_modal <span class="hljs-variable">@socket</span>, InstagramCloneWeb.UserLive.Profile.FollowersComponent,<br>    <span class="hljs-symbol">id:</span> <span class="hljs-variable">@user</span>.id || <span class="hljs-symbol">:followers</span>,<br>    <span class="hljs-symbol">width:</span>  <span class="hljs-string">&quot;w-1/4&quot;</span>,<br>    <span class="hljs-symbol">current_user:</span> <span class="hljs-variable">@current_user</span>,<br>    <span class="hljs-symbol">followers:</span> <span class="hljs-variable">@followers</span>,<br>    <span class="hljs-symbol">return_to:</span> Routes.user_profile_path(<span class="hljs-variable">@socket</span>, <span class="hljs-symbol">:index</span>, <span class="hljs-variable">@user</span>.username) %&gt;<br>&lt;% <span class="hljs-keyword">end</span> %&gt;<br><br>&lt;header class=<span class="hljs-string">&quot;flex justify-center px-10&quot;</span>&gt;<br>  &lt;!-- Profile Picture Section --&gt;<br>  &lt;section class=<span class="hljs-string">&quot;w-1/4&quot;</span>&gt;<br>      &lt;%= img_tag <span class="hljs-variable">@user</span>.avatar_url,<br>          <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-40 h-40 rounded-full object-cover object-center&quot;</span> %&gt;<br>  &lt;<span class="hljs-regexp">/section&gt;</span><br><span class="hljs-regexp">  &lt;!-- END Profile Picture Section --&gt;</span><br><span class="hljs-regexp"></span><br><span class="hljs-regexp">  &lt;!-- Profile Details Section --&gt;</span><br><span class="hljs-regexp">  &lt;section class=&quot;w-3/</span><span class="hljs-number">4</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">    &lt;div class=&quot;</span>flex px<span class="hljs-number">-3</span> pt<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">        &lt;h1 class=&quot;</span>truncate <span class="hljs-symbol">md:</span>overflow-clip text<span class="hljs-number">-2</span>xl <span class="hljs-symbol">md:</span>text<span class="hljs-number">-2</span>xl text-gray<span class="hljs-number">-500</span> mb<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;&lt;%= @user.username %&gt;&lt;/h1&gt;</span><br><span class="hljs-string">        &lt;span class=&quot;</span>ml<span class="hljs-number">-11</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">          &lt;%= if @live_action == :edit_profile do %&gt;</span><br><span class="hljs-string">            &lt;%= live_patch &quot;</span>Edit Profile<span class="hljs-string">&quot;,</span><br><span class="hljs-string">                to: Routes.live_path(@socket, InstagramCloneWeb.UserLive.Settings),</span><br><span class="hljs-string">                class: &quot;</span>py<span class="hljs-number">-1</span> px<span class="hljs-number">-2</span> border<span class="hljs-number">-2</span> rounded font-semibold <span class="hljs-symbol">hover:</span>bg-gray<span class="hljs-number">-50</span><span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">          &lt;% end %&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">          &lt;%= if @live_action == :follow_component do %&gt;</span><br><span class="hljs-string">            &lt;%= live_component @socket,</span><br><span class="hljs-string">                InstagramCloneWeb.UserLive.FollowComponent,</span><br><span class="hljs-string">                id: @user.id,</span><br><span class="hljs-string">                user: @user,</span><br><span class="hljs-string">                current_user: @current_user %&gt;</span><br><span class="hljs-string">          &lt;% end %&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">          &lt;%= if @live_action == :login_btn do %&gt;</span><br><span class="hljs-string">            &lt;%= link &quot;</span>Follow<span class="hljs-string">&quot;, to: Routes.user_session_path(@socket, :new), class: &quot;</span>user-profile-follow-btn<span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">          &lt;% end %&gt;</span><br><span class="hljs-string">        &lt;/span&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;div&gt;</span><br><span class="hljs-string">      &lt;ul class=&quot;</span>flex p<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">          &lt;li&gt;&lt;b&gt;0&lt;/b&gt; Posts&lt;/li&gt;</span><br><span class="hljs-string">          &lt;%= live_patch to: Routes.user_profile_path(@socket, :followers, @user.username) do %&gt;</span><br><span class="hljs-string">            &lt;li class=&quot;</span>ml<span class="hljs-number">-11</span><span class="hljs-string">&quot;&gt;&lt;b&gt;&lt;%= @user.followers_count %&gt;&lt;/b&gt; Followers&lt;/li&gt;</span><br><span class="hljs-string">          &lt;% end %&gt;</span><br><span class="hljs-string">          &lt;%= live_patch to: Routes.user_profile_path(@socket, :following, @user.username) do %&gt;</span><br><span class="hljs-string">            &lt;li class=&quot;</span>ml<span class="hljs-number">-11</span><span class="hljs-string">&quot;&gt;&lt;b&gt;&lt;%= @user.following_count %&gt;&lt;/b&gt; Following&lt;/li&gt;</span><br><span class="hljs-string">          &lt;% end %&gt;</span><br><span class="hljs-string">      &lt;/ul&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;div class=&quot;</span>p<span class="hljs-number">-3</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      &lt;h2 class=&quot;</span>text-md text-gray<span class="hljs-number">-600</span> font-bold<span class="hljs-string">&quot;&gt;&lt;%= @user.full_name %&gt;&lt;/h2&gt;</span><br><span class="hljs-string">      &lt;%= if @user.bio do %&gt;</span><br><span class="hljs-string">        &lt;p class=&quot;</span>max-w-full <span class="hljs-keyword">break</span>-words<span class="hljs-string">&quot;&gt;&lt;%= @user.bio %&gt;&lt;/p&gt;</span><br><span class="hljs-string">      &lt;% end %&gt;</span><br><span class="hljs-string">      &lt;%= if @user.website do %&gt;</span><br><span class="hljs-string">        &lt;%= link display_website_uri(@user.website),</span><br><span class="hljs-string">          to: @user.website,</span><br><span class="hljs-string">          target: &quot;</span>_blank<span class="hljs-string">&quot;, rel: &quot;</span>noreferrer<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          class: &quot;</span>text-blue<span class="hljs-number">-700</span><span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">      &lt;% end %&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string">  &lt;/section&gt;</span><br><span class="hljs-string">  &lt;!-- END Profile Details Section --&gt;</span><br><span class="hljs-string">&lt;/header&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;section class=&quot;</span>border-t<span class="hljs-number">-2</span> mt<span class="hljs-number">-5</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">  &lt;ul class=&quot;</span>flex justify-center text-center space-x<span class="hljs-number">-20</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-600</span> border-t<span class="hljs-number">-2</span> border-black -mt-0.<span class="hljs-number">5</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">       POSTS</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-400</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      IGTV</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-400</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      SAVED</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">    &lt;li class=&quot;</span>pt<span class="hljs-number">-4</span> px<span class="hljs-number">-1</span> text-sm text-gray<span class="hljs-number">-400</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">      TAGGED</span><br><span class="hljs-string">    &lt;/li&gt;</span><br><span class="hljs-string">  &lt;/ul&gt;</span><br><span class="hljs-string">&lt;/section&gt;</span><br></code></pre></td></tr></table></figure>

<p>打开<code>lib/instagram_clone_web/live/render_helpers.ex</code>并添加以下内容以帮助我们显示模态：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-keyword">import</span> Phoenix.LiveView.Helpers<br><br>    <span class="hljs-variable">@doc</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">Renders a component inside the `LiveviewPlaygroundWeb.ModalComponent` component.</span><br><span class="hljs-string"></span><br><span class="hljs-string">The rendered modal receives a `:return_to` option to properly update</span><br><span class="hljs-string">the URL when the modal is closed.</span><br><span class="hljs-string">The rendered modal also receives a `:width` option for the style width</span><br><span class="hljs-string"></span><br><span class="hljs-string">## Examples</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;%= live_modal @socket, LiveviewPlaygroundWeb.PostLive.FormComponent,</span><br><span class="hljs-string">      id: @post.id || :new,</span><br><span class="hljs-string">      width: &quot;w-1/2&quot;,</span><br><span class="hljs-string">      post: @post,</span><br><span class="hljs-string">      return_to: Routes.post_index_path(@socket, :index) %&gt;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">live_modal</span></span>(socket, component, opts) <span class="hljs-keyword">do</span><br>  path = Keyword.fetch!(opts, <span class="hljs-symbol">:return_to</span>)<br>  width = Keyword.fetch!(opts,  <span class="hljs-symbol">:width</span>)<br>  modal_opts = [<span class="hljs-symbol">id:</span> <span class="hljs-symbol">:modal</span>, <span class="hljs-symbol">return_to:</span> path, <span class="hljs-symbol">width:</span> width, <span class="hljs-symbol">component:</span> component, <span class="hljs-symbol">opts:</span> opts]<br>  live_component(socket, InstagramCloneWeb.ModalComponent, modal_opts)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>创建模态组件<code>lib/instagram_clone_web/live/modal_component.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.ModalComponent</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_component</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">render</span></span>(assigns) <span class="hljs-keyword">do</span><br>    <span class="hljs-string">~L&quot;&quot;&quot;</span><br><span class="hljs-string">    &lt;div</span><br><span class="hljs-string">      class=&quot;</span>fixed top-0 left-0 flex items-center justify-center w-full h-screen bg-black bg-opacity<span class="hljs-number">-40</span> z<span class="hljs-number">-50</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">      phx-capture-click=&quot;</span>close<span class="hljs-string">&quot;</span><br><span class="hljs-string">      phx-window-keydown=&quot;</span>close<span class="hljs-string">&quot;</span><br><span class="hljs-string">      phx-key=&quot;</span>escape<span class="hljs-string">&quot;</span><br><span class="hljs-string">      phx-target=&quot;</span>&lt;%= <span class="hljs-variable">@myself</span> %&gt;<span class="hljs-string">&quot;</span><br><span class="hljs-string">      phx-page-loading&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">      &lt;div class=&quot;</span>&lt;%= <span class="hljs-variable">@width</span> %&gt; h-auto bg-white rounded-xl shadow-xl<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">        &lt;%= live_patch raw(&quot;</span>&amp;times;<span class="hljs-string">&quot;), to: @return_to, class: &quot;</span>float-right text-gray<span class="hljs-number">-500</span> text<span class="hljs-number">-4</span>xl px<span class="hljs-number">-4</span><span class="hljs-string">&quot; %&gt;</span><br><span class="hljs-string">        &lt;%= live_component @socket, @component, @opts %&gt;</span><br><span class="hljs-string">      &lt;/div&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string">    &quot;</span><span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-keyword">end</span><br><br>    <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;close&quot;</span>, _, socket) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:noreply</span>, push_patch(socket, <span class="hljs-symbol">to:</span> socket.assigns.return_to)&#125;<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>创建关注者组件<code>lib/instagram_clone_web/live/user_live/followers_component.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.UserLive.Profile.FollowersComponent</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_component</span><br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Uploaders.Avatar<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>和模板<code>lib/instagram_clone_web/live/user_live/followers_component.html.leex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;header class=<span class="hljs-string">&quot;bg-gray-50 p-2 border-b-2 rounded-t-xl&quot;</span>&gt;<br>  &lt;h1 class=<span class="hljs-string">&quot;flex justify-center text-xl font-semibold&quot;</span>&gt;Followers&lt;<span class="hljs-regexp">/h1&gt;</span><br><span class="hljs-regexp">&lt;/header</span>&gt;<br><br>&lt;%= <span class="hljs-keyword">for</span> follow &lt;- <span class="hljs-variable">@followers</span> <span class="hljs-keyword">do</span> %&gt;<br>  &lt;div class=<span class="hljs-string">&quot;p-4&quot;</span>&gt;<br>    &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>      &lt;%= live_redirect <span class="hljs-symbol">to:</span> Routes.user_profile_path(<span class="hljs-variable">@socket</span>, <span class="hljs-symbol">:index</span>, follow.follower.username) <span class="hljs-keyword">do</span> %&gt;<br>        &lt;%= img_tag Avatar.get_thumb(follow.follower.avatar_url), <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-10 h-10 rounded-full object-cover object-center&quot;</span> %&gt;<br>      &lt;% <span class="hljs-keyword">end</span> %&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;ml-3&quot;</span>&gt;<br>        &lt;%= live_redirect  follow.follower.username,<br>          <span class="hljs-symbol">to:</span> Routes.user_profile_path(<span class="hljs-variable">@socket</span>, <span class="hljs-symbol">:index</span>, follow.follower.username),<br>          <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;font-semibold text-sm truncate text-gray-700 hover:underline&quot;</span> %&gt;<br>        &lt;h6 class=<span class="hljs-string">&quot;font-semibold text-sm truncate text-gray-400&quot;</span>&gt;<br>          &lt;%= follow.follower.full_name %&gt;<br>        &lt;<span class="hljs-regexp">/h6&gt;</span><br><span class="hljs-regexp">      &lt;/div</span>&gt;<br>      &lt;%= if <span class="hljs-variable">@current_user</span> !== follow.follower <span class="hljs-keyword">do</span> %&gt;<br>        &lt;span class=<span class="hljs-string">&quot;ml-auto&quot;</span>&gt;<br>          &lt;%= live_component <span class="hljs-variable">@socket</span>,<br>            InstagramCloneWeb.UserLive.FollowComponent,<br>            <span class="hljs-symbol">id:</span> follow.follower.id,<br>            <span class="hljs-symbol">user:</span> follow.follower,<br>            <span class="hljs-symbol">current_user:</span> <span class="hljs-variable">@current_user</span> %&gt;<br>        &lt;<span class="hljs-regexp">/span&gt;</span><br><span class="hljs-regexp">      &lt;% end %&gt;</span><br><span class="hljs-regexp">    &lt;/div</span>&gt;<br><br>  &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">&lt;% end %&gt;</span><br></code></pre></td></tr></table></figure>

<p>创建以下组件<code>lib/instagram_clone_web/live/user_live/following_component.ex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.UserLive.Profile.FollowingComponent</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_component</span><br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Uploaders.Avatar<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>和模板<code>lib/instagram_clone_web/live/user_live/following_component.html.leex</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;header class=<span class="hljs-string">&quot;bg-gray-50 p-2 border-b-2 rounded-t-xl&quot;</span>&gt;<br>  &lt;h1 class=<span class="hljs-string">&quot;flex justify-center text-xl font-semibold&quot;</span>&gt;Following&lt;<span class="hljs-regexp">/h1&gt;</span><br><span class="hljs-regexp">&lt;/header</span>&gt;<br>&lt;%= <span class="hljs-keyword">for</span> follow &lt;- <span class="hljs-variable">@following</span> <span class="hljs-keyword">do</span> %&gt;<br>  &lt;div class=<span class="hljs-string">&quot;p-4&quot;</span>&gt;<br>    &lt;div class=<span class="hljs-string">&quot;flex items-center&quot;</span>&gt;<br>      &lt;%= live_redirect <span class="hljs-symbol">to:</span> Routes.user_profile_path(<span class="hljs-variable">@socket</span>, <span class="hljs-symbol">:index</span>, follow.followed.username) <span class="hljs-keyword">do</span> %&gt;<br>        &lt;%= img_tag Avatar.get_thumb(follow.followed.avatar_url), <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;w-10 h-10 rounded-full object-cover object-center&quot;</span> %&gt;<br>      &lt;% <span class="hljs-keyword">end</span> %&gt;<br><br>      &lt;div class=<span class="hljs-string">&quot;ml-3&quot;</span>&gt;<br>        &lt;%= live_redirect  follow.followed.username,<br>          <span class="hljs-symbol">to:</span> Routes.user_profile_path(<span class="hljs-variable">@socket</span>, <span class="hljs-symbol">:index</span>, follow.followed.username),<br>          <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;font-semibold text-sm truncate text-gray-700 hover:underline&quot;</span> %&gt;<br>        &lt;h6 class=<span class="hljs-string">&quot;font-semibold text-sm truncate text-gray-400&quot;</span>&gt;<br>          &lt;%= follow.followed.full_name %&gt;<br>        &lt;<span class="hljs-regexp">/h6&gt;</span><br><span class="hljs-regexp">      &lt;/div</span>&gt;<br>      &lt;%= if <span class="hljs-variable">@current_user</span> !== follow.followed <span class="hljs-keyword">do</span> %&gt;<br>        &lt;span class=<span class="hljs-string">&quot;ml-auto&quot;</span>&gt;<br>          &lt;%= live_component <span class="hljs-variable">@socket</span>,<br>            InstagramCloneWeb.UserLive.FollowComponent,<br>            <span class="hljs-symbol">id:</span> follow.followed.id,<br>            <span class="hljs-symbol">user:</span> follow.followed,<br>            <span class="hljs-symbol">current_user:</span> <span class="hljs-variable">@current_user</span> %&gt;<br>        &lt;<span class="hljs-regexp">/span&gt;</span><br><span class="hljs-regexp">      &lt;% end %&gt;</span><br><span class="hljs-regexp">    &lt;/div</span>&gt;<br>  &lt;<span class="hljs-regexp">/div&gt;</span><br><span class="hljs-regexp">&lt;% end %&gt;</span><br></code></pre></td></tr></table></figure>

<p>此外，我们还需要对头像上传器、打开<code>lib/instagram_clone_web/live/uploaders/avatar.ex</code>和以下内容进行一些小调整：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-comment"># This was added to return the default image when no avatar uploaded</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_thumb</span></span>(avatar_url) <span class="hljs-keyword">when</span> avatar_url == <span class="hljs-string">&quot;/images/default-avatar.png&quot;</span> <span class="hljs-keyword">do</span><br>  avatar_url<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_thumb</span></span>(avatar_url) <span class="hljs-keyword">do</span><br>  file_name = String.replace_leading(avatar_url, <span class="hljs-string">&quot;/uploads/&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>  [<span class="hljs-string">&quot;/<span class="hljs-subst">#&#123;<span class="hljs-variable">@upload_directory_name</span>&#125;</span>&quot;</span>, <span class="hljs-string">&quot;thumb_<span class="hljs-subst">#&#123;file_name&#125;</span>&quot;</span>] |&gt; Path.join()<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="https://s2.loli.net/2023/08/30/jU1ZCgdJqBeSc4f.gif" alt="instagram-phoenix-p3-2.gif" class="lazyload"></p>
<p>让我们对标题导航菜单进行一些小的调整，以便不必在每个 LiveView 上分配 current_uri_path，并对我们的<code>page_live</code>组件进行一些小的调整，以在组件内部而不是父 LiveView 中设置表单。</p>
<p>打开<code>lib/instagram_clone_web/live/page_live.ex</code>文件并将其更新为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.PageLive</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_view</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(_params, session, socket) <span class="hljs-keyword">do</span><br>    socket = assign_defaults(session, socket)<br>    &#123;<span class="hljs-symbol">:ok</span>, socket&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_params</span></span>(_params, _uri, socket) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:noreply</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">live_action:</span> apply_action(socket.assigns.current_user))&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">defp</span> <span class="hljs-title">apply_action</span></span>(current_user) <span class="hljs-keyword">do</span><br>    if !current_user, <span class="hljs-symbol">do:</span> <span class="hljs-symbol">:root_path</span><br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>更新<code>lib/instagram_clone_web/live/page_live_component.ex</code>如下：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-class"><span class="hljs-keyword">defmodule</span> <span class="hljs-title">InstagramCloneWeb.PageLiveComponent</span></span> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">use</span> InstagramCloneWeb, <span class="hljs-symbol">:live_component</span><br><br>  <span class="hljs-keyword">alias</span> InstagramClone.Accounts<br>  <span class="hljs-keyword">alias</span> InstagramClone.Accounts.User<br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mount</span></span>(socket) <span class="hljs-keyword">do</span><br>    changeset = Accounts.change_user_registration(%User&#123;&#125;)<br>    &#123;<span class="hljs-symbol">:ok</span>,<br>      socket<br>      |&gt; assign(<span class="hljs-symbol">changeset:</span> changeset)<br>      |&gt; assign(<span class="hljs-symbol">trigger_submit:</span> <span class="hljs-keyword">false</span>)&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;validate&quot;</span>, %&#123;<span class="hljs-string">&quot;user&quot;</span> =&gt; user_params&#125;, socket) <span class="hljs-keyword">do</span><br>    changeset =<br>      %User&#123;&#125;<br>      |&gt; User.registration_changeset(user_params)<br>      |&gt; Map.put(<span class="hljs-symbol">:action</span>, <span class="hljs-symbol">:validate</span>)<br>    &#123;<span class="hljs-symbol">:noreply</span>, socket |&gt; assign(<span class="hljs-symbol">changeset:</span> changeset)&#125;<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span></span>(<span class="hljs-string">&quot;save&quot;</span>, _, socket) <span class="hljs-keyword">do</span><br>    &#123;<span class="hljs-symbol">:noreply</span>, assign(socket, <span class="hljs-symbol">trigger_submit:</span> <span class="hljs-keyword">true</span>)&#125;<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>在第 5 行内部<code>lib/instagram_clone_web/live/page_live_component.html.leex</code>向表单添加一个目标：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= f = form_for <span class="hljs-variable">@changeset</span>, Routes.user_registration_path(<span class="hljs-variable">@socket</span>, <span class="hljs-symbol">:create</span>),<br>  <span class="hljs-symbol">phx_change:</span> <span class="hljs-string">&quot;validate&quot;</span>,<br>  <span class="hljs-symbol">phx_submit:</span> <span class="hljs-string">&quot;save&quot;</span>,<br>  <span class="hljs-symbol">phx_target:</span> <span class="hljs-variable">@myself</span>, <span class="hljs-comment"># &lt;-- THIS LINE WAS ADDED</span><br>  <span class="hljs-symbol">phx_trigger_action:</span> <span class="hljs-variable">@trigger_submit</span>,<br>  <span class="hljs-symbol">class:</span> <span class="hljs-string">&quot;flex flex-col space-y-4 w-full px-6&quot;</span> %&gt;<br></code></pre></td></tr></table></figure>

<p>更新<code>lib/instagram_clone_web/live/page_live.html.leex</code>如下：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= if <span class="hljs-variable">@current_user</span> <span class="hljs-keyword">do</span> %&gt;<br>  &lt;h1&gt;User Logged In Homepage&lt;<span class="hljs-regexp">/h1&gt;</span><br><span class="hljs-regexp">&lt;% else %&gt;</span><br><span class="hljs-regexp">  &lt;%= live_component @socket,</span><br><span class="hljs-regexp">    InstagramCloneWeb.PageLiveComponent,</span><br><span class="hljs-regexp">    id: 1 %&gt;</span><br><span class="hljs-regexp">&lt;% end %&gt;</span><br></code></pre></td></tr></table></figure>

<p>打开<code>lib/instagram_clone_web/templates/layout/live.html.leex</code>顶部逻辑并将其更新为以下内容：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&lt;%= if <span class="hljs-variable">@current_user</span> <span class="hljs-keyword">do</span> %&gt;<br>  &lt;%= live_component <span class="hljs-variable">@socket</span>, InstagramCloneWeb.HeaderNavComponent, <span class="hljs-symbol">current_user:</span> <span class="hljs-variable">@current_user</span> %&gt;<br><br>&lt;% else %&gt;<br>  &lt;%= if <span class="hljs-variable">@live_action</span> !== <span class="hljs-symbol">:root_path</span> <span class="hljs-keyword">do</span> %&gt;<br>    &lt;%= live_component <span class="hljs-variable">@socket</span>, InstagramCloneWeb.HeaderNavComponent, <span class="hljs-symbol">current_user:</span> <span class="hljs-variable">@current_user</span> %&gt;<br>  &lt;% <span class="hljs-keyword">end</span> %&gt;<br>&lt;% <span class="hljs-keyword">end</span> %&gt;<br></code></pre></td></tr></table></figure>

<p>现在我们不需要<code>@curent_uri_path</code>在每个liveview上，我们可以从<code>lib/instagram_clone_web/live/user_live/profile.ex</code>第20行里面删除它<code>handle_params()</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">@impl</span> <span class="hljs-keyword">true</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_params</span></span>(_params, uri, socket) <span class="hljs-keyword">do</span><br>  socket = socket |&gt; assign(<span class="hljs-symbol">current_uri_path:</span> URI.parse(uri).path) <span class="hljs-comment"># &lt;-- DELETE THIS LINE</span><br>  &#123;<span class="hljs-symbol">:noreply</span>, apply_action(socket, socket.assigns.live_action)&#125;<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>制作这一部分比我预期的要困难，它变得有点具有挑战性，这个应用程序并不像我们想象的那么容易做好。我的完美主义战胜了我，这就是为什么我花了更长的时间才发布它，我对一些我必须弄清楚的事情一无所知，但毫无疑问，我很享受这个过程并学到了很多东西。在下一部分中，我们将处理用户的帖子。</p>
<p>转自：<a target="_blank" rel="noopener" href="https://elixirprogrammer.com/learn/lets-build-an-instagram-clone-with-the-petal-phoenix-elixir-tailwindcss-alpinejs-liveview-stack-part-3/">Elixirprogrammer</a></p>

  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>本文作者：</strong>MarkHoo<br>
        <strong>本文链接：</strong><a href="https://blog.markhoo.com/posts/instagram-phoenix-liveview-p3/" title="https:&#x2F;&#x2F;blog.markhoo.com&#x2F;posts&#x2F;instagram-phoenix-liveview-p3&#x2F;" target="_blank" rel="noopener">https:&#x2F;&#x2F;blog.markhoo.com&#x2F;posts&#x2F;instagram-phoenix-liveview-p3&#x2F;</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 进行许可
        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
    
        <a class="nexmoefont icon-appstore-fill -link" href="/categories/Elixir/">Elixir</a>
    
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/AlpineJS/" rel="tag">AlpineJS</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Elixir/" rel="tag">Elixir</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/LiveView/" rel="tag">LiveView</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Phoenix/" rel="tag">Phoenix</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/TailwindCSS/" rel="tag">TailwindCSS</a>
    
</div>

  
      <div class="nexmoe-post-footer">
          <section class="nexmoe-comment">
    <div class="valine"></div>
<script src='https://cdn.jsdelivr.net/npm/valine'></script>
<script>
    // 使用方法 https://valine.js.org/quickstart.html
    new Valine({
        el: '.valine',
        appId: 'LnljA9jtf29oZKiQMJ6OAWJU-gzGzoHsz',
        appKey: 'wb1Mrzef0b2x540dSrcCcg5y'
    })
</script>
</section>
      </div>
  
</div>
            <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                        
                          
                          
                              <button class="mdui-fab catalog" style="overflow:unset;">
                                  <i class="nexmoefont icon-i-catalog"></i>
                                  <div class="nexmoe-toc">
                                      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Repo-get-by-%E5%8F%AF%E6%9F%A5%E8%AF%A2%E3%80%81%E5%AD%90%E5%8F%A5%E3%80%81%E9%80%89%E9%A1%B9"><span class="toc-number">1.</span> <span class="toc-text">Repo.get_by!(可查询、子句、选项)</span></a></li></ol>
                                  </div>
                              </button>
                          
                          
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
        </div>
    </div>
     
    <div id="nexmoe-search-space">
        <div class="search-container">
            <div class="search-header">
                <div class="search-input-container">
                    <input class="search-input" type="text" placeholder="搜索" oninput="sinput();">
                </div>
                <a class="search-close" onclick="sclose();">×</a>
            </div>
            <div class="search-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/combine/npm/lazysizes@5.1.0/lazysizes.min.js,npm/mdui@0.4.3/dist/js/mdui.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

 

<script async src="/js/app.js?v=1693394714830"></script>



<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>


    





</body>

</html>
